<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeFix Platform - Companies</title>
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #32281d 0%, #E67E00 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo span {
            color: #FCD34D;
        }

        .menu {
            list-style: none;
        }

        .menu-item {
            margin-bottom: 5px;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .menu-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: #FCD34D;
        }

        .menu-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: #FCD34D;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 18px;
        }

        .submenu {
            list-style: none;
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .submenu.open {
            max-height: 200px;
        }

        .submenu-item {
            padding-left: 52px;
        }

        .submenu-link {
            display: block;
            padding: 10px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .submenu-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.05);
            padding-left: 25px;
        }

        .submenu-link.active {
            color: #FCD34D;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #E67E00;
        }

        .btn-add {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(247, 143, 30, 0.4);
        }

        /* Grid View Styles */
        .content-area {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Filter Section */
        .filter-section {
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            min-width: 250px;
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: #F78F1E;
            box-shadow: 0 0 0 3px rgba(247, 143, 30, 0.1);
        }

        .results-count {
            color: #6b7280;
            font-size: 14px;
            margin-left: auto;
        }

        .grid-container {
            overflow-x: auto;
        }

        .grid-header {
            display: grid;
            grid-template-columns: 60px 100px 200px 80px 150px 120px 120px 400px;
            gap: 8px;
            padding: 15px 12px;
            background-color: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #E67E00;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .grid-header-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .grid-header-cell:hover {
            color: #F78F1E;
        }

        .sort-icon {
            font-size: 12px;
            opacity: 0.5;
        }

        .grid-header-cell.sorted .sort-icon {
            opacity: 1;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 60px 100px 200px 80px 150px 120px 120px 400px;
            gap: 8px;
            padding: 15px 12px;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .grid-row:hover {
            background-color: #f8fafc;
        }

        .grid-cell {
            display: flex;
            align-items: center;
            color: #374151;
            font-size: 14px;
        }

        .company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .branches-count {
            text-align: center;
            font-weight: 600;
            color: #F78F1E;
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #f3f4f6;
            border-color: #F78F1E;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            border-color: #F78F1E;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Modal Popup Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 22px;
            color: #E67E00;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #374151;
        }

        .modal-body {
            padding: 30px;
        }

        /* Wizard Form Styles */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }

        .wizard-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 8px;
        }

        .wizard-step:hover {
            background-color: rgba(230, 126, 0, 0.1);
            transform: translateY(-2px);
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-title {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 500;
        }

        /* Additional Form Styles */
        .form-group-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group-required::after {
            content: ' *';
            color: #EF4444;
        }

        .file-upload-container {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-container:hover {
            border-color: #F78F1E;
            background-color: #fff7ed;
        }

        .file-upload-input {
            display: none;
        }

        .file-upload-icon {
            font-size: 48px;
            color: #9ca3af;
            margin-bottom: 10px;
        }

        .file-upload-text {
            color: #6b7280;
            font-size: 14px;
        }

        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #d1d5db;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .dynamic-section {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9fafb;
        }

        .dynamic-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dynamic-section-title {
            font-weight: 600;
            color: #E67E00;
        }

        .btn-remove {
            background: #EF4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-add-item {
            background: #22C55E;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-add-item:hover {
            background: #16A34A;
        }

        .conditional-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #fef3c7;
            border-radius: 8px;
            border-left: 4px solid #F78F1E;
        }

        .conditional-section.show {
            display: block;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: white;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .country-select {
            width: 100%;
        }

        /* Multi-Select Dropdown Styles */
        .multi-select-container {
            position: relative;
            width: 100%;
        }

        .multi-select-dropdown {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .multi-select-dropdown:hover {
            border-color: #F78F1E;
        }

        .multi-select-dropdown.active {
            border-color: #F78F1E;
            box-shadow: 0 0 0 3px rgba(247, 143, 30, 0.1);
        }

        .multi-select-text {
            color: #374151;
            flex: 1;
        }

        .multi-select-arrow {
            color: #6b7280;
            transition: transform 0.3s ease;
        }

        .multi-select-dropdown.active .multi-select-arrow {
            transform: rotate(180deg);
        }

        .multi-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .multi-select-options.show {
            display: block;
        }

        .multi-select-option {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .multi-select-option:hover {
            background-color: #f3f4f6;
        }

        .multi-select-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .multi-select-option label {
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            margin: 0;
        }

        /* Edit Button Styles */
        .btn-edit {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
            pointer-events: auto;
            z-index: 10;
            position: relative;
            width: 80px;
            height: 36px;
            flex-shrink: 0;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #1D4ED8 0%, #1E40AF 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        /* Team Leader Edit Button Specific Styles */
        .team-leader-card .btn-edit {
            position: relative;
            z-index: 10;
            pointer-events: auto;
            cursor: pointer;
        }

        /* Action Buttons Container */
        .action-buttons {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 8px;
            justify-content: flex-start;
            align-items: center;
            padding: 8px 0;
        }

        /* Add User Button */
        .btn-add-user {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
            pointer-events: auto;
            z-index: 10;
            position: relative;
            width: 80px;
            height: 36px;
            flex-shrink: 0;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-add-user:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        /* Add Branch Button */
        .btn-add-branch {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
            pointer-events: auto;
            z-index: 10;
            position: relative;
            width: 80px;
            height: 36px;
            flex-shrink: 0;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-add-branch:hover {
            background: linear-gradient(135deg, #D97706 0%, #B45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }

        /* Add Zone Button */
        .btn-add-zone {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
            pointer-events: auto;
            z-index: 10;
            position: relative;
            width: 80px;
            height: 36px;
            flex-shrink: 0;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-add-zone:hover {
            background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4);
        }

        /* Add Contract Button */
        .btn-add-contract {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
            pointer-events: auto;
            z-index: 10;
            position: relative;
            width: 100px;
            height: 36px;
            flex-shrink: 0;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-add-contract:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        /* Danger Button */
        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        /* Team Leader Avatar Status */
        .team-leader-avatar-large.status-active {
            background-color: #10B981 !important;
            color: white !important;
        }

        .team-leader-avatar-large.status-inactive {
            background-color: #EF4444 !important;
            color: white !important;
        }

        .team-leader-avatar-large.status-active .default-avatar,
        .team-leader-avatar-large.status-inactive .default-avatar {
            color: white !important;
        }

        /* Expandable Row Styles */
        .company-row {
            border-bottom: 1px solid #e5e7eb;
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .clickable-row:hover {
            background-color: #f9fafb;
        }

        .branch-details {
            background-color: #f8fafc;
            border-top: 1px solid #e5e7eb;
            padding: 20px;
            margin: 0;
        }

        .branch-details-header {
            font-weight: 600;
            color: #E67E00;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .contract-details {
            background-color: #f8fafc;
            border-top: 1px solid #e5e7eb;
            padding: 20px;
            margin: 0;
        }

        .contract-details-header {
            font-weight: 600;
            color: #E67E00;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .contract-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-left: 4px solid #E67E00;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .contract-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .contract-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .contract-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .contract-info-item {
            display: flex;
            flex-direction: column;
        }

        .contract-info-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .contract-info-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 600;
        }

        .branch-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .branch-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .branch-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .branch-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .branch-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .branch-toggle:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #10B981;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Radio Button Styles */
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #F78F1E;
        }

        .radio-group.error {
            border: 2px solid #EF4444;
            border-radius: 8px;
            padding: 12px;
        }

        .radio-item label {
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            margin: 0;
        }

        /* Searchable Dropdown Styles */
        .searchable-dropdown {
            position: relative;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 4px;
        }

        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #f9fafb;
        }

        .dropdown-item.selected {
            background-color: #fef3c7;
        }

        /* Services Table Styles */
        .services-table {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .services-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }

        .services-table tbody tr:last-child {
            border-bottom: none;
        }

        .services-table tbody tr:hover {
            background-color: #f9fafb;
        }

        .services-table td {
            padding: 12px;
            color: #374151;
            font-size: 14px;
        }

        .btn-delete {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        .time-slots-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }

        .time-slot-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .time-slot-option.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .time-slot-option.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }

        /* Working Days & Hours Styles */
        .working-days-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .workday-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }

        .workday-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #374151;
        }

        .workday-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .time-inputs input[type="time"] {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            min-width: 130px;
        }

        .time-inputs input[type="time"]:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        /* Count Control Styles */
        .count-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .count-input {
            width: 80px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }

        .count-input:focus {
            outline: none;
            border-color: #F78F1E;
            box-shadow: 0 0 0 3px rgba(247, 143, 30, 0.1);
        }

        .count-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .count-btn:hover {
            background: #F78F1E;
            color: white;
            border-color: #F78F1E;
        }

        .count-btn:active {
            transform: scale(0.95);
        }

        .branch-item:last-child {
            margin-bottom: 0;
        }

        .branch-title {
            font-weight: 700;
            color: white;
            background-color: #6b7280;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.2s ease;
        }

        .branch-title:hover {
            background-color: #4b5563;
        }

        .branch-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .branch-info-item {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #f1f5f9;
        }

        .branch-info-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .branch-info-value {
            font-size: 14px;
            color: #1f2937;
        }

        .team-leaders-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .team-leaders-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        .team-leaders-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 15px;
        }

        .team-leader-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            position: relative;
            z-index: 1;
        }

        .team-leader-card-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .team-leader-avatar-large {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #6b7280;
            flex-shrink: 0;
        }

        .team-leader-avatar-large img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .team-leader-info {
            flex: 1;
            min-width: 0;
        }

        .team-leader-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .team-leader-job-title {
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .team-leader-mobile {
            color: #6b7280;
            font-size: 11px;
            line-height: 1.2;
        }

        .team-leader-card-body {
            margin-top: 12px;
        }

        .team-leader-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 11px;
        }

        .field-label {
            font-weight: 500;
            color: #6b7280;
        }

        .field-value {
            color: #374151;
            text-align: right;
        }

        .team-leader-status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 8px;
            display: inline-block;
        }

        .team-leader-status-badge.active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .team-leader-status-badge.inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .note-icon {
            cursor: help;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            margin-left: 4px;
        }

        .note-icon:hover {
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .team-leaders-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }

        @media (max-width: 480px) {
            .team-leaders-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        /* Zones Section Styles */
        .zones-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .zones-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        .zone-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e5e7eb;
        }

        .zone-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
        }

        .zone-number {
            background: #E67E00;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .zone-info {
            padding: 16px;
        }

        .zone-info-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .zone-info-item:last-child {
            border-bottom: none;
        }

        .zone-info-label {
            font-weight: 500;
            color: #6b7280;
            font-size: 12px;
            min-width: 120px;
        }

        .zone-info-value {
            color: #374151;
            font-size: 13px;
            text-align: right;
            flex: 1;
            line-height: 1.4;
        }

        .team-leader-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .team-leader-item:last-child {
            border-bottom: none;
        }

        .team-leader-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .team-leader-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .team-leader-avatar .default-avatar {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .team-leader-info {
            flex: 1;
        }

        .team-leader-name {
            font-size: 13px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .team-leader-mobile {
            font-size: 12px;
            color: #6b7280;
        }

        .team-leader-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .team-leader-status.active {
            background-color: #dcfce7;
            color: #166534;
        }

        .team-leader-status.inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Team Leaders Column Styles */
        .team-leaders-avatars {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }

        .team-leader-avatar-small {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease;
        }

        .team-leader-avatar-small:hover {
            transform: scale(1.1);
        }

        .team-leader-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            pointer-events: none;
        }

        .team-leader-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #1f2937;
        }

        .team-leader-avatar-small:hover .team-leader-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* New Team Leader Card Styles */
        .team-leader-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .team-leader-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e5e7eb;
        }

        .team-leader-avatar-large {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #6b7280;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .team-leader-avatar-large img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .team-leader-status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .team-leader-status-badge.active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .team-leader-status-badge.inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .team-leader-card-body {
            padding: 16px;
        }

        .team-leader-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .team-leader-field:last-child {
            border-bottom: none;
        }

        .field-label {
            font-weight: 500;
            color: #6b7280;
            font-size: 12px;
            min-width: 120px;
        }

        .field-value {
            color: #374151;
            font-size: 13px;
            text-align: right;
            flex: 1;
        }

        .note-icon {
            cursor: help;
            font-size: 14px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .note-icon:hover {
            opacity: 1;
        }

        .tooltip-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .tooltip-branch {
            color: #9ca3af;
            font-size: 11px;
        }

        .tooltip-mobile {
            color: #9ca3af;
            font-size: 11px;
        }

        .wizard-step.active .step-number {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
        }

        .wizard-step.active .step-title {
            color: #F78F1E;
        }

        .wizard-step.completed .step-number {
            background-color: #10b981;
            color: white;
        }

        .wizard-section {
            display: none;
        }

        .wizard-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #F78F1E;
            box-shadow: 0 0 0 3px rgba(247, 143, 30, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(247, 143, 30, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: #E67E00;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Responsive Design */
        
        /* Large Desktop (1440px and above) */
        @media (min-width: 1440px) {
            .main-content {
                padding: 40px;
            }
            
            .content-area {
                padding: 40px;
            }
        }

        /* Laptop (1024px - 1439px) */
        @media (max-width: 1439px) and (min-width: 1024px) {
            .main-content {
                padding: 30px;
            }
            
            .grid-header,
            .grid-row {
                grid-template-columns: 50px 90px 180px 75px 130px 100px 100px 80px;
                gap: 8px;
            }
        }

        /* Tablet (768px - 1023px) */
        @media (max-width: 1023px) and (min-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar .logo h1,
            .sidebar .menu-link span {
                display: none;
            }

            .sidebar .menu-icon {
                margin-right: 0;
            }

            .main-content {
                margin-left: 70px;
                padding: 20px;
            }

            .submenu-item {
                padding-left: 20px;
            }

            .header {
                padding: 15px 20px;
            }

            .content-area {
                padding: 20px;
            }

            .grid-header,
            .grid-row {
                grid-template-columns: 50px 80px 180px 70px 120px 80px 80px 60px;
                gap: 6px;
                padding: 12px 10px;
                font-size: 12px;
            }

            .modal-content {
                max-width: 90%;
            }
        }

        /* Mobile (below 768px) */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                left: -260px;
                transition: left 0.3s ease;
                z-index: 1000;
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .sidebar .logo h1 {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .header h2 {
                font-size: 20px;
            }

            .btn-add {
                width: 100%;
                justify-content: center;
            }

            .content-area {
                padding: 15px;
            }

            .filter-section {
                flex-direction: column;
                gap: 10px;
            }

            .filter-input,
            .filter-select {
                width: 100%;
            }

            .results-count {
                margin-left: 0;
                width: 100%;
                text-align: center;
            }

            .grid-header,
            .grid-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .grid-header {
                display: none;
            }

            .grid-cell {
                display: grid;
                grid-template-columns: 100px 1fr;
                gap: 10px;
            }

            .grid-cell::before {
                content: attr(data-label);
                font-weight: 600;
                color: #E67E00;
            }

            .company-logo {
                margin: 0 auto;
            }

            .status-badge,
            .branches-count {
                justify-self: start;
            }

            .pagination-container {
                flex-direction: column;
                gap: 15px;
            }

            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .pagination-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            /* Modal responsive */
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
            }

            .btn-primary,
            .btn-secondary {
                width: 100%;
            }

            .wizard-steps {
                gap: 5px;
            }

            .step-number {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .step-title {
                font-size: 10px;
            }

            /* Show mobile menu toggle button */
            .mobile-menu-toggle {
                display: block;
            }
        }

        /* Small Mobile (below 480px) */
        @media (max-width: 479px) {
            .main-content {
                padding: 10px;
            }

            .header {
                padding: 12px;
            }

            .content-area {
                padding: 12px;
            }

            .filter-section {
                gap: 8px;
            }

            .grid-cell {
                grid-template-columns: 80px 1fr;
                gap: 8px;
            }

            .pagination-btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            .modal-content {
                width: 98%;
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 15px;
            }

            .wizard-steps {
                margin-bottom: 20px;
            }

            .step-number {
                width: 24px;
                height: 24px;
            }

            .step-title {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()"></button>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <h1>We<span>Fix</span></h1>
            </div>
            <ul class="menu">
                <li class="menu-item">
                    <a href="index.html" class="menu-link">
                        <span class="menu-icon"></span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link">
                        <span class="menu-icon"></span>
                        <span>Calendar</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="tickets.html" class="menu-link">
                        <span class="menu-icon"></span>
                        <span>Tickets</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link customers-link">
                        <span class="menu-icon"></span>
                        <span>Customers</span>
                    </a>
                    <ul class="submenu open">
                        <li class="submenu-item">
                            <a href="companies.html" class="submenu-link active">Companies</a>
                        </li>
                        <li class="submenu-item">
                            <a href="individuals.html" class="submenu-link">Individuals</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-item">
                    <a href="contracts.html" class="menu-link">
                        <span class="menu-icon"></span>
                        <span>Contracts</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="permissions.html" class="menu-link">
                        <span class="menu-icon"></span>
                        <span>Roles</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="./login.html" class="menu-link">
                        <span class="menu-icon"></span>
                        <span>Login</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h2>Companies</h2>
                <button class="btn-add" onclick="openModal()">
                    <span></span>
                    <span>Add New Company</span>
                </button>
            </div>
            <div class="content-area">
                <!-- Filter Section -->
                <div class="filter-section">
                    <input type="text" class="filter-input" id="searchInput" placeholder="Search by company title, ID...">
                    <select class="filter-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                    <select class="filter-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="LLC">LLC</option>
                        <option value="Corporation">Corporation</option>
                        <option value="Partnership">Partnership</option>
                        <option value="Sole Proprietorship">Sole Proprietorship</option>
                    </select>
                    <span class="results-count" id="resultsCount">Showing 0 results</span>
                </div>

                <!-- Grid Container -->
                <div class="grid-container">
                    <div class="grid-header">
                        <div class="grid-header-cell" data-sort="logo">
                            Logo
                        </div>
                        <div class="grid-header-cell" data-sort="id">
                            Company ID <span class="sort-icon"></span>
                        </div>
                        <div class="grid-header-cell" data-sort="title">
                            Company Title <span class="sort-icon"></span>
                        </div>
                        <div class="grid-header-cell" data-sort="isActive">
                            Is Active <span class="sort-icon"></span>
                        </div>
                        <div class="grid-header-cell" data-sort="establishedType">
                            Established Type <span class="sort-icon"></span>
                        </div>
                        <div class="grid-header-cell" data-sort="branches">
                            # of Branches <span class="sort-icon"></span>
                        </div>
                        <div class="grid-header-cell">
                            Team Leaders
                        </div>
                        <div class="grid-header-cell">
                            Actions
                        </div>
                    </div>
                    <div id="companiesGrid">
                        <!-- Companies will be displayed here -->
                    </div>
                    <!-- Pagination Container -->
                    <div class="pagination-container" id="paginationContainer" style="display: none;">
                        <div class="pagination-info" id="paginationInfo">
                            Showing 0 - 0 of 0
                        </div>
                        <div class="pagination-controls" id="paginationControls">
                            <!-- Pagination buttons will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Popup -->
    <div class="modal-overlay" id="companyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Setup Company</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Wizard Steps -->
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1" onclick="goToStep(1)">
                        <div class="step-number">1</div>
                        <div class="step-title">Basic Info</div>
                    </div>
                    <div class="wizard-step" data-step="2" onclick="goToStep(2)">
                        <div class="step-number">2</div>
                        <div class="step-title">Contracts</div>
                    </div>
                    <div class="wizard-step" data-step="3" onclick="goToStep(3)">
                        <div class="step-number">3</div>
                        <div class="step-title">User Roles</div>
                    </div>
                    <div class="wizard-step" data-step="4" onclick="goToStep(4)">
                        <div class="step-number">4</div>
                        <div class="step-title">Branches</div>
                    </div>
                    <div class="wizard-step" data-step="5" onclick="goToStep(5)">
                        <div class="step-number">5</div>
                        <div class="step-title">Zones</div>
                    </div>
                    <div class="wizard-step" data-step="6" onclick="goToStep(6)">
                        <div class="step-number">6</div>
                        <div class="step-title">Maintenance Services</div>
                    </div>
                    <div class="wizard-step" data-step="7" onclick="goToStep(7)">
                        <div class="step-number">7</div>
                        <div class="step-title">Working Hours</div>
                    </div>
                </div>

                <!-- Section 1: Basic Information -->
                <div class="wizard-section active" id="section1">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Basic Information</h4>
                    <div class="form-group">
                        <label class="form-label form-group-required">Company Title</label>
                        <input type="text" class="form-input" id="companyTitle" placeholder="Enter company title">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Company Name Arabic</label>
                            <input type="text" class="form-input" id="companyNameAr" placeholder="  ">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Company Name English</label>
                            <input type="text" class="form-input" id="companyNameEn" placeholder="Enter company name">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Country</label>
                            <select class="form-input country-select" id="companyCountry">
                                <option value="Jordan" selected>Jordan</option>
                                <option value="Saudi Arabia">Saudi Arabia</option>
                                <option value="UAE">UAE</option>
                                <option value="Egypt">Egypt</option>
                                <option value="Lebanon">Lebanon</option>
                                <option value="Kuwait">Kuwait</option>
                                <option value="Oman">Oman</option>
                                <option value="Qatar">Qatar</option>
                                <option value="Bahrain">Bahrain</option>
                                <option value="Iraq">Iraq</option>
                                <option value="Syria">Syria</option>
                                <option value="Yemen">Yemen</option>
                                <option value="Palestine">Palestine</option>
                                <option value="Tunisia">Tunisia</option>
                                <option value="Algeria">Algeria</option>
                                <option value="Morocco">Morocco</option>
                                <option value="Libya">Libya</option>
                                <option value="Sudan">Sudan</option>
                                <option value="Mauritania">Mauritania</option>
                                <option value="Djibouti">Djibouti</option>
                                <option value="Somalia">Somalia</option>
                                <option value="Comoros">Comoros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Established Type</label>
                            <select class="form-input" id="companyType">
                                <option value=""> </option>
                                <option value=""></option>
                                <option value=""></option>
                                <option value=" "> </option>
                                <option value=" "> </option>
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">HO-Address</label>
                        <textarea class="form-input form-textarea" id="hoAddress" placeholder="Enter head office address"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">HO-Location Map</label>
                        <div class="map-container" id="mapContainer">
                             Click to drop pin on map<br>
                            <small style="font-size: 12px;">Map integration will be added</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Logo</label>
                        <div class="file-upload-container" onclick="document.getElementById('logoUpload').click()">
                            <div class="file-upload-icon"></div>
                            <div class="file-upload-text">Click to upload logo</div>
                            <div class="file-upload-text" id="logoFileName" style="display: none; color: #F78F1E;"></div>
                            <input type="file" id="logoUpload" class="file-upload-input" accept="image/*">
                        </div>
                    </div>
                </div>

                <!-- Section 2: Contracts -->
                <div class="wizard-section" id="section2">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Contract Information</h4>
                    
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"> Contract Reference</label>
                            <input type="text" class="form-input" id="contractNumber" placeholder="Enter contract reference">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contract Title</label>
                            <input type="text" class="form-input" id="contractTitle" placeholder="Enter contract title">
                        </div>
                    </div>

                    <!-- Business Model -->
                    <div class="form-group">
                        <label class="form-label form-group-required">Business Model</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="businessModelB2B" name="businessModel" value="B2B" required>
                                <label for="businessModelB2B">B2B</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="businessModelWhiteLabel" name="businessModel" value="White Label" required>
                                <label for="businessModelWhiteLabel">White Label</label>
                            </div>
                        </div>
                    </div>

                    <!-- Managed By -->
                    <div class="form-group">
                        <label class="form-label form-group-required">Managed By</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="wizardManagedByClientTeam" name="wizardManagedBy" value="Client Team" onchange="updateWizardBranchTeamLeaderDropdown();" required>
                                <label for="wizardManagedByClientTeam">Client Team</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="wizardManagedByWeFixTeam" name="wizardManagedBy" value="WeFix Team" onchange="updateWizardBranchTeamLeaderDropdown();" required>
                                <label for="wizardManagedByWeFixTeam">WeFix Team</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label form-group-required">Ticket ShortCode</label>
                        <input type="text" class="form-input" id="ticketShortCode" placeholder="TKT-XX-0001" required>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 6px;">Format: TKT-ShortName-0001 (auto-generated from company title and must be unique)</small>
                    </div>

                    <!-- Is Active Toggle -->
                    <div class="form-group">
                        <label class="form-label">Is Active</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="contractIsActive" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="color: #374151; font-size: 14px;">Active</span>
                        </div>
                    </div>

                    <!-- Count Controls -->
                    <div class="form-group-row" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label"># of Owner</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('ownerCount')"></button>
                                <input type="number" class="count-input" id="ownerCount" value="1" min="1" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('ownerCount')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"># of Team Leader</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('teamLeaderCount')"></button>
                                <input type="number" class="count-input" id="teamLeaderCount" value="1" min="1" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('teamLeaderCount')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"># of Branch</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('branchCount')"></button>
                                <input type="number" class="count-input" id="branchCount" value="1" min="1" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('branchCount')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-row" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label"># of Preventive Tickets</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('preventiveTicketsCount')"></button>
                                <input type="number" class="count-input" id="preventiveTicketsCount" value="1" min="0" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('preventiveTicketsCount')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"># of Corrective Tickets</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('correctiveTicketsCount')"></button>
                                <input type="number" class="count-input" id="correctiveTicketsCount" value="1" min="0" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('correctiveTicketsCount')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"># of Emergency Tickets</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('emergencyTicketsCount')"></button>
                                <input type="number" class="count-input" id="emergencyTicketsCount" value="1" min="0" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('emergencyTicketsCount')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required"> Contract Start Date</label>
                            <input type="date" class="form-input" id="contractStartDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required"> Contract End Date</label>
                            <input type="date" class="form-input" id="contractEndDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Contract Files</label>
                        <div class="file-upload-container" onclick="document.getElementById('contractFilesUpload').click()">
                            <div class="file-upload-icon"></div>
                            <div class="file-upload-text">Click to upload contract files</div>
                            <div class="file-upload-text" id="contractFilesName" style="display: none; color: #F78F1E;"></div>
                            <input type="file" id="contractFilesUpload" class="file-upload-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                        </div>
                        <small style="color: #6b7280; font-size: 12px; margin-top: 5px; display: block;">Supported formats: PDF, DOC, DOCX, JPG, PNG (Multiple files allowed)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Contract Description</label>
                        <textarea class="form-input form-textarea" id="contractDescription" placeholder="Enter contract description or notes" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Contract Value</label>
                        <input type="text" class="form-input" id="contractValue" placeholder="Enter contract value">
                    </div>
                </div>

                <!-- Section 3: User Roles -->
                <div class="wizard-section" id="section3">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Add Main User</h4>
                    <div class="form-group">
                        <label class="form-label form-group-required"> User Role</label>
                        <select class="form-input" id="wizardUserType">
                            <option value="">Select User Role</option>
                            <option value="Owner (Admin)">Owner (Admin)</option>
                            <option value="Team Leader">Team Leader</option>
                            <option value="Technician">Technician</option>
                        </select>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required"> Full Name Ar</label>
                            <input type="text" class="form-input" id="wizardUserNameAr" placeholder=" ">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required"> Full Name En</label>
                            <input type="text" class="form-input" id="wizardUserNameEn" placeholder="User Name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> User Image</label>
                        <div class="file-upload-container" onclick="document.getElementById('wizardUserImageUpload').click()">
                            <div class="file-upload-icon"></div>
                            <div class="file-upload-text">Click to upload user image</div>
                            <div class="file-upload-text" id="wizardUserImageFileName" style="display: none; color: #F78F1E;"></div>
                            <input type="file" id="wizardUserImageUpload" class="file-upload-input" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required"> Country</label>
                            <select class="form-input" id="wizardUserCountry">
                                <option value="Jordan">Jordan (+962)</option>
                                <option value="Saudi Arabia">Saudi Arabia (+966)</option>
                                <option value="UAE">UAE (+971)</option>
                                <option value="Egypt">Egypt (+20)</option>
                                <option value="Kuwait">Kuwait (+965)</option>
                                <option value="Qatar">Qatar (+974)</option>
                                <option value="Bahrain">Bahrain (+973)</option>
                                <option value="Oman">Oman (+968)</option>
                                <option value="Lebanon">Lebanon (+961)</option>
                                <option value="Iraq">Iraq (+964)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required"> Mobile Number</label>
                            <input type="tel" class="form-input" id="wizardUserMobile" placeholder="7XX XXX XXX">
                            <small style="color: #6b7280; font-size: 12px;">Mobile number only (without country code)</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Email Address</label>
                        <input type="email" class="form-input" id="wizardUserEmail" placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Description</label>
                        <textarea class="form-input form-textarea" id="wizardUserDescription" placeholder="Enter user description" rows="3"></textarea>
                    </div>
                </div>

                <!-- Section 4: Add Branch -->
                <div class="wizard-section" id="section4">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Add Main Branch</h4>
                    <div class="form-group">
                        <label class="form-label form-group-required">Branch Title</label>
                        <input type="text" class="form-input" id="wizardBranchTitle" placeholder="Enter branch title" required>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Branch Name (Arabic)</label>
                            <input type="text" class="form-input" id="wizardBranchNameAr" placeholder=" " required>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Branch Name (English)</label>
                            <input type="text" class="form-input" id="wizardBranchNameEn" placeholder="Branch Name" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required">Branch Representative Name</label>
                        <input type="text" class="form-input" id="wizardBranchRepName" placeholder="Representative Name" required>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Representative Mobile Number</label>
                            <input type="tel" class="form-input" id="wizardBranchRepMobile" placeholder="+962 7XX XXX XXX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Representative Email Address</label>
                            <input type="email" class="form-input" id="wizardBranchRepEmail" placeholder="rep@example.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Team Leader</label>
                        <select class="form-input" id="wizardBranchTeamLeader">
                            <option value="">Select Team Leader</option>
                            <option value="Ahmad Al-Mousa">Ahmad Al-Mousa</option>
                            <option value="Mohammed Al-Hashimi">Mohammed Al-Hashimi</option>
                            <option value="Omar Al-Zahawi">Omar Al-Zahawi</option>
                            <option value="Khalid Al-Rashid">Khalid Al-Rashid</option>
                            <option value="Yousef Al-Mansouri">Yousef Al-Mansouri</option>
                        </select>
                    </div>
                    <!-- Is Active Toggle -->
                    <div class="form-group">
                        <label class="form-label">Is Active</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="wizardBranchIsActive" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="color: #374151; font-size: 14px;">Active</span>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Add Zones -->
                <div class="wizard-section" id="section5">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Add Main Zone</h4>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Zone Title</label>
                            <input type="text" class="form-input" id="wizardZoneTitle" placeholder="Zone Title" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Zone Number</label>
                            <input type="text" class="form-input" id="wizardZoneNumber" placeholder="Zone Number" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone Description</label>
                        <textarea class="form-input form-textarea" id="wizardZoneDescription" placeholder="Zone Description"></textarea>
                    </div>
                    <!-- Is Active Toggle -->
                    <div class="form-group">
                        <label class="form-label">Is Active</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="wizardZoneIsActive" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="color: #374151; font-size: 14px;">Active</span>
                        </div>
                    </div>
                </div>

                <!-- Section 6: Maintenance Services -->
                <div class="wizard-section" id="section6">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Maintenance Services</h4>
                    
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Main Service</label>
                            <div class="searchable-dropdown">
                                <input type="text" class="form-input" id="maintenanceMainService" placeholder="Search or select Main Service..." autocomplete="off" onfocus="showMainServiceDropdown()" oninput="filterMainServiceOptions()">
                                <div class="dropdown-list" id="mainServiceDropdown" style="display: none;">
                                    <!-- Options will be populated by JavaScript -->
                                </div>
                            </div>
                            <input type="hidden" id="maintenanceMainServiceValue" value="">
                            <input type="hidden" id="maintenanceMainServiceEn" value="">
                            <input type="hidden" id="maintenanceMainServiceAr" value="">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Sub Service</label>
                            <div class="searchable-dropdown">
                                <input type="text" class="form-input" id="maintenanceSubService" placeholder="Search or select Sub Service..." autocomplete="off" onfocus="showSubServiceDropdown()" oninput="filterSubServiceOptions()" disabled>
                                <div class="dropdown-list" id="subServiceDropdown" style="display: none;">
                                    <!-- Options will be populated by JavaScript -->
                                </div>
                            </div>
                            <input type="hidden" id="maintenanceSubServiceValue" value="">
                            <input type="hidden" id="maintenanceSubServiceEn" value="">
                            <input type="hidden" id="maintenanceSubServiceAr" value="">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button type="button" class="btn-primary" onclick="addMaintenanceService()" style="width: 100%;">Add</button>
                        </div>
                    </div>

                    <!-- Grid Table for Maintenance Services -->
                    <div class="maintenance-services-grid" style="margin-top: 30px;">
                        <table class="services-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f8fafc; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 80px;">Id</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Main Category Title (En-Ar)</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Sub Category Title (En-Ar)</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Delete</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceServicesTableBody">
                                <tr>
                                    <td colspan="4" style="padding: 20px; text-align: center; color: #6b7280; font-style: italic;">No maintenance services added yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Section 7: Working Hours -->
                <div class="wizard-section" id="section7">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Working Hours</h4>
                    <div class="form-group">
                        <label class="form-label">Allowed Time Slots</label>
                        <div class="time-slots-container" id="timeSlotsContainer">
                            <label class="time-slot-option" id="timeSlot_all_option">
                                <input type="checkbox" id="timeSlot_all" onclick="toggleAllTimeSlots(this)">
                                All
                            </label>
                            <label class="time-slot-option">
                                <input type="checkbox" class="time-slot-checkbox" value="08:00-10:00">
                                08:00 - 10:00
                            </label>
                            <label class="time-slot-option">
                                <input type="checkbox" class="time-slot-checkbox" value="10:00-12:00">
                                10:00 - 12:00
                            </label>
                            <label class="time-slot-option">
                                <input type="checkbox" class="time-slot-checkbox" value="12:00-14:00">
                                12:00 - 14:00
                            </label>
                            <label class="time-slot-option">
                                <input type="checkbox" class="time-slot-checkbox" value="14:00-16:00">
                                14:00 - 16:00
                            </label>
                            <label class="time-slot-option disabled">
                                <input type="checkbox" checked disabled>
                                Emergency Response: 90 - 120 Min (Response time)
                            </label>
                        </div>
                    </div>
                </div>
            <div class="modal-footer">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-secondary" id="prevBtn" onclick="prevStep()" style="display: none;">Previous</button>
                    <button class="btn-primary" id="nextBtn" onclick="nextStep()">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Users Modal -->
    <div class="modal-overlay" id="addUsersModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="addUsersModalTitle">Add Users to Company</h3>
                <button class="close-btn" onclick="closeAddUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="addUsersList"></div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeAddUsersModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="saveUsersToCompany()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Company Modal -->
    <div class="modal-overlay" id="editCompanyModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="editCompanyModalTitle">Edit Company</h3>
                <button class="close-btn" onclick="closeEditCompanyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCompanyForm">
                    <div class="form-group">
                        <label class="form-label form-group-required">Company Title</label>
                        <input type="text" class="form-input" id="editCompanyTitle" placeholder="Enter company title">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Company Name Arabic</label>
                            <input type="text" class="form-input" id="editCompanyNameAr" placeholder="  ">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Company Name English</label>
                            <input type="text" class="form-input" id="editCompanyNameEn" placeholder="Enter company name">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Country</label>
                            <select class="form-input country-select" id="editCompanyCountry">
                                <option value="Jordan">Jordan</option>
                                <option value="Saudi Arabia">Saudi Arabia</option>
                                <option value="UAE">UAE</option>
                                <option value="Egypt">Egypt</option>
                                <option value="Lebanon">Lebanon</option>
                                <option value="Kuwait">Kuwait</option>
                                <option value="Oman">Oman</option>
                                <option value="Qatar">Qatar</option>
                                <option value="Bahrain">Bahrain</option>
                                <option value="Iraq">Iraq</option>
                                <option value="Syria">Syria</option>
                                <option value="Yemen">Yemen</option>
                                <option value="Palestine">Palestine</option>
                                <option value="Tunisia">Tunisia</option>
                                <option value="Algeria">Algeria</option>
                                <option value="Morocco">Morocco</option>
                                <option value="Libya">Libya</option>
                                <option value="Sudan">Sudan</option>
                                <option value="Mauritania">Mauritania</option>
                                <option value="Djibouti">Djibouti</option>
                                <option value="Somalia">Somalia</option>
                                <option value="Comoros">Comoros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Established Type</label>
                            <select class="form-input" id="editCompanyType">
                                <option value=""> </option>
                                <option value=""></option>
                                <option value=""></option>
                                <option value=" "> </option>
                                <option value=" "> </option>
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">HO-Address</label>
                        <textarea class="form-input form-textarea" id="editHoAddress" placeholder="Enter head office address"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Logo</label>
                        <div class="file-upload-container" onclick="document.getElementById('editLogoUpload').click()">
                            <div class="file-upload-icon"></div>
                            <div class="file-upload-text">Click to upload logo</div>
                            <div class="file-upload-text" id="editLogoFileName" style="display: none; color: #F78F1E;"></div>
                            <input type="file" id="editLogoUpload" class="file-upload-input" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"> Contract Start Date</label>
                            <input type="date" class="form-input" id="editContractStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label"> Contract End Date</label>
                            <input type="date" class="form-input" id="editContractEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Contract Files</label>
                        <div class="file-upload-container" onclick="document.getElementById('editContractFilesUpload').click()">
                            <div class="file-upload-icon"></div>
                            <div class="file-upload-text">Click to upload contract files</div>
                            <div class="file-upload-text" id="editContractFilesName" style="display: none; color: #F78F1E;"></div>
                            <input type="file" id="editContractFilesUpload" class="file-upload-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                        </div>
                        <small style="color: #6b7280; font-size: 12px; margin-top: 5px; display: block;">Supported formats: PDF, DOC, DOCX, JPG, PNG (Multiple files allowed)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="editCompanyStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </form>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeEditCompanyModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="saveEditedCompany()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Branch Modal -->
    <div class="modal-overlay" id="editBranchModal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="editBranchModalTitle">Edit Branch</h3>
                <button class="close-btn" onclick="closeEditBranchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editBranchForm">
                    <div class="form-group">
                        <label class="form-label">Branch Title</label>
                        <input type="text" class="form-input" id="editBranchTitle" placeholder="Enter branch title">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Branch Name (Arabic)</label>
                            <input type="text" class="form-input" id="editBranchNameAr" placeholder=" ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Branch Name (English)</label>
                            <input type="text" class="form-input" id="editBranchNameEn" placeholder="Branch Name">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Main Service</label>
                            <select class="form-input" id="editMainCategory" onchange="updateEditBranchSubCategories()">
                                <option value="">Select Main Service</option>
                                <option value=" "> </option>
                                <option value="  ">  </option>
                                <option value=" "> </option>
                                <option value="  ">  </option>
                                <option value=""></option>
                                <option value="   ">   </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub Service</label>
                            <select class="form-input" id="editSubCategory">
                                <option value="">Select Sub Service</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Branch Representative Name</label>
                        <input type="text" class="form-input" id="editBranchRepName" placeholder="Representative Name">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"> Country</label>
                            <select class="form-input" id="editBranchRepCountry">
                                <option value="Jordan">Jordan (+962)</option>
                                <option value="Saudi Arabia">Saudi Arabia (+966)</option>
                                <option value="UAE">UAE (+971)</option>
                                <option value="Egypt">Egypt (+20)</option>
                                <option value="Kuwait">Kuwait (+965)</option>
                                <option value="Qatar">Qatar (+974)</option>
                                <option value="Bahrain">Bahrain (+973)</option>
                                <option value="Oman">Oman (+968)</option>
                                <option value="Lebanon">Lebanon (+961)</option>
                                <option value="Iraq">Iraq (+964)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Representative Mobile Number</label>
                            <input type="tel" class="form-input" id="editBranchRepMobile" placeholder="7XX XXX XXX">
                            <small style="color: #6b7280; font-size: 12px;">Mobile number only (without country code)</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Representative Email Address</label>
                        <input type="email" class="form-input" id="editBranchRepEmail" placeholder="rep@example.com">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"> Start Date</label>
                            <input type="date" class="form-input" id="editBranchStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label"> End Date</label>
                            <input type="date" class="form-input" id="editBranchEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Managed By</label>
                        <select class="form-input" id="editManagedBy">
                            <option value="">Select</option>
                            <option value="Client Team">Client Team</option>
                            <option value="WeFix Team">WeFix Team</option>
                        </select>
                    </div>
                </form>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeEditBranchModal()">Cancel</button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn-danger" onclick="deleteBranch()">Delete</button>
                        <button type="button" class="btn-primary" onclick="saveEditedBranch()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Single Zone Modal -->
    <div class="modal-overlay" id="editSingleZoneModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="editSingleZoneModalTitle">Edit Zone</h3>
                <button class="close-btn" onclick="closeEditSingleZoneModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editSingleZoneForm">
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Zone Title</label>
                            <input type="text" class="form-input" id="editSingleZoneTitle" placeholder="Enter zone title">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Zone Number</label>
                            <input type="text" class="form-input" id="editSingleZoneNumber" placeholder="Zone number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input form-textarea" id="editSingleZoneDescription" placeholder="Enter zone description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Technical Team</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="editSingleTech_electrical" value="Electrical">
                                <span>Electrical</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editSingleTech_plumbing" value="Plumbing">
                                <span>Plumbing</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editSingleTech_hvac" value="HVAC">
                                <span>HVAC</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editSingleTech_painting" value="Painting">
                                <span>Painting</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editSingleTech_carpentry" value="Carpentry">
                                <span>Carpentry</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editSingleTech_general" value="General Maintenance">
                                <span>General Maintenance</span>
                            </label>
                        </div>
                    </div>
                </form>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeEditSingleZoneModal()">Cancel</button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn-danger" onclick="deleteSingleZone()">Delete</button>
                        <button type="button" class="btn-primary" onclick="saveSingleZone()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Branch Modal -->
    <div class="modal-overlay" id="addBranchModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="addBranchModalTitle">Add Branch to Company</h3>
                <button class="close-btn" onclick="closeAddBranchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addBranchForm">
                    <div class="form-group">
                        <label class="form-label form-group-required">Select Contract Reference</label>
                        <select class="form-input" id="addBranchContract" required>
                            <option value="">Select Contract</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required">Branch Title</label>
                        <input type="text" class="form-input" id="addBranchTitle" placeholder="Enter branch title" required>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Branch Name (Arabic)</label>
                            <input type="text" class="form-input" id="addBranchNameAr" placeholder=" " required>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Branch Name (English)</label>
                            <input type="text" class="form-input" id="addBranchNameEn" placeholder="Branch Name" required>
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Main Service</label>
                            <select class="form-input" id="addMainCategory" onchange="updateAddBranchSubCategories()" required>
                                <option value="">Select Main Service</option>
                                <option value=" "> </option>
                                <option value="  ">  </option>
                                <option value=" "> </option>
                                <option value="  ">  </option>
                                <option value=""></option>
                                <option value="   ">   </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Sub Service</label>
                            <select class="form-input" id="addSubCategory" required>
                                <option value="">Select Sub Service</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required">Branch Representative Name</label>
                        <input type="text" class="form-input" id="addBranchRepName" placeholder="Representative Name" required>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"> Country</label>
                            <select class="form-input" id="addBranchRepCountry">
                                <option value="Jordan">Jordan (+962)</option>
                                <option value="Saudi Arabia">Saudi Arabia (+966)</option>
                                <option value="UAE">UAE (+971)</option>
                                <option value="Egypt">Egypt (+20)</option>
                                <option value="Kuwait">Kuwait (+965)</option>
                                <option value="Qatar">Qatar (+974)</option>
                                <option value="Bahrain">Bahrain (+973)</option>
                                <option value="Oman">Oman (+968)</option>
                                <option value="Lebanon">Lebanon (+961)</option>
                                <option value="Iraq">Iraq (+964)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Representative Mobile Number</label>
                            <input type="tel" class="form-input" id="addBranchRepMobile" placeholder="7XX XXX XXX" required>
                            <small style="color: #6b7280; font-size: 12px;">Mobile number only (without country code)</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Representative Email Address</label>
                        <input type="email" class="form-input" id="addBranchRepEmail" placeholder="rep@example.com">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required"> Start Date</label>
                            <input type="date" class="form-input" id="addBranchStartDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required"> End Date</label>
                            <input type="date" class="form-input" id="addBranchEndDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required">Managed By</label>
                        <select class="form-input" id="addManagedBy" required>
                            <option value="">Select</option>
                            <option value="Client Team">Client Team</option>
                            <option value="WeFix Team">WeFix Team</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Team Leader</label>
                        <select class="form-input" id="addBranchTeamLeader">
                            <option value="">Select Team Leader</option>
                            <option value="Ahmad Al-Mousa">Ahmad Al-Mousa</option>
                            <option value="Mohammed Al-Hashimi">Mohammed Al-Hashimi</option>
                            <option value="Omar Al-Zahawi">Omar Al-Zahawi</option>
                            <option value="Khalid Al-Rashid">Khalid Al-Rashid</option>
                            <option value="Yousef Al-Mansouri">Yousef Al-Mansouri</option>
                        </select>
                    </div>
                </form>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeAddBranchModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="saveNewBranch()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Team Leader Modal -->
    <div class="modal-overlay" id="editTeamLeaderModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="editTeamLeaderModalTitle">Edit Team Leader</h3>
                <button class="close-btn" onclick="closeEditTeamLeaderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editTeamLeaderForm">
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Team Leader Name (Arabic)</label>
                            <input type="text" class="form-input" id="editTLNameAr" placeholder="  ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Team Leader Name (English)</label>
                            <input type="text" class="form-input" id="editTLNameEn" placeholder="Team Leader Name">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"> Country</label>
                            <select class="form-input" id="editTLCountry">
                                <option value="Jordan">Jordan (+962)</option>
                                <option value="Saudi Arabia">Saudi Arabia (+966)</option>
                                <option value="UAE">UAE (+971)</option>
                                <option value="Egypt">Egypt (+20)</option>
                                <option value="Kuwait">Kuwait (+965)</option>
                                <option value="Qatar">Qatar (+974)</option>
                                <option value="Bahrain">Bahrain (+973)</option>
                                <option value="Oman">Oman (+968)</option>
                                <option value="Lebanon">Lebanon (+961)</option>
                                <option value="Iraq">Iraq (+964)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number</label>
                            <input type="tel" class="form-input" id="editTLMobile" placeholder="7XX XXX XXX">
                            <small style="color: #6b7280; font-size: 12px;">Mobile number only (without country code)</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categories</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="editTLCat_electrical" value="Electrical">
                                <label for="editTLCat_electrical">Electrical</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="editTLCat_plumbing" value="Plumbing">
                                <label for="editTLCat_plumbing">Plumbing</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="editTLCat_hvac" value="HVAC">
                                <label for="editTLCat_hvac">HVAC</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="editTLCat_painting" value="Painting">
                                <label for="editTLCat_painting">Painting</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="editTLCat_carpentry" value="Carpentry">
                                <label for="editTLCat_carpentry">Carpentry</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="editTLCat_general" value="General Maintenance">
                                <label for="editTLCat_general">General Maintenance</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input form-textarea" id="editTLDescription" placeholder="Team Leader Description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="toggle-container" style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <span id="editTLStatusLabel" style="font-weight: 500; color: #374151;">Active</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="editTLStatusToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </form>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeEditTeamLeaderModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="saveEditedTeamLeader()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Zones Modal -->
    <div class="modal-overlay" id="addZonesModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="addZonesModalTitle">Add Zones to Company</h3>
                <button class="close-btn" onclick="closeAddZonesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="addZonesList"></div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeAddZonesModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="saveNewZones()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contract Modal -->
    <div class="modal-overlay" id="addContractModal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="addContractModalTitle">Add Contract to Company</h3>
                <button class="close-btn" onclick="closeAddContractModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addContractForm">
                    <!-- Contract Number -->
                    <div class="form-group">
                        <label class="form-label"> Contract Reference</label>
                        <input type="text" class="form-input" id="addContractNumber" placeholder="Enter contract reference">
                    </div>

                    <!-- Business Model -->
                    <div class="form-group">
                        <label class="form-label form-group-required">Business Model</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="addBusinessModelB2B" name="addBusinessModel" value="B2B" required>
                                <label for="addBusinessModelB2B">B2B</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="addBusinessModelWhiteLabel" name="addBusinessModel" value="White Label" required>
                                <label for="addBusinessModelWhiteLabel">White Label</label>
                            </div>
                        </div>
                    </div>

                    <!-- Is Active Toggle -->
                    <div class="form-group">
                        <label class="form-label">Is Active</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="addContractIsActive" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="color: #374151; font-size: 14px;">Active</span>
                        </div>
                    </div>

                    <!-- Count Controls -->
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"># of Team Leader</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('addTeamLeaderCount')"></button>
                                <input type="number" class="count-input" id="addTeamLeaderCount" value="1" min="1" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('addTeamLeaderCount')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"># of Branch</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('addBranchCount')"></button>
                                <input type="number" class="count-input" id="addBranchCount" value="1" min="1" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('addBranchCount')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"># of Preventive Tickets</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('addPreventiveTicketsCount')"></button>
                                <input type="number" class="count-input" id="addPreventiveTicketsCount" value="1" min="0" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('addPreventiveTicketsCount')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"># of Corrective Tickets</label>
                            <div class="count-control">
                                <button type="button" class="count-btn" onclick="decrementCount('addCorrectiveTicketsCount')"></button>
                                <input type="number" class="count-input" id="addCorrectiveTicketsCount" value="1" min="0" readonly>
                                <button type="button" class="count-btn" onclick="incrementCount('addCorrectiveTicketsCount')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label"> Contract Start Date</label>
                            <input type="date" class="form-input" id="addContractStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label"> Contract End Date</label>
                            <input type="date" class="form-input" id="addContractEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Contract Files</label>
                        <div class="file-upload-container" onclick="document.getElementById('addContractFilesUpload').click()">
                            <div class="file-upload-icon"></div>
                            <div class="file-upload-text">Click to upload contract files</div>
                            <div class="file-upload-text" id="addContractFilesName" style="display: none; color: #F78F1E;"></div>
                            <input type="file" id="addContractFilesUpload" class="file-upload-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                        </div>
                        <small style="color: #6b7280; font-size: 12px; margin-top: 5px; display: block;">Supported formats: PDF, DOC, DOCX, JPG, PNG (Multiple files allowed)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Contract Description</label>
                        <textarea class="form-input form-textarea" id="addContractDescription" placeholder="Enter contract description or notes" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Contract Value</label>
                        <input type="text" class="form-input" id="addContractValue" placeholder="Enter contract value">
                    </div>
                </form>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeAddContractModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="saveNewContract()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Maintenance Services Modal -->
    <div class="modal-overlay" id="manageMaintenanceServicesModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="manageMaintenanceServicesModalTitle">Manage Maintenance Services</h3>
                <button class="close-btn" onclick="closeManageMaintenanceServicesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Add New Service Form -->
                <div style="margin-bottom: 30px; padding: 20px; background-color: #f8fafc; border-radius: 8px;">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Add New Service</h4>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Main Service</label>
                            <div class="searchable-dropdown">
                                <input type="text" class="form-input" id="manageMainService" placeholder="Search or select Main Service..." autocomplete="off" onfocus="showManageMainServiceDropdown()" oninput="filterManageMainServiceOptions()">
                                <div class="dropdown-list" id="manageMainServiceDropdown" style="display: none;">
                                    <!-- Options will be populated by JavaScript -->
                                </div>
                            </div>
                            <input type="hidden" id="manageMainServiceValue" value="">
                            <input type="hidden" id="manageMainServiceEn" value="">
                            <input type="hidden" id="manageMainServiceAr" value="">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Sub Service</label>
                            <div class="searchable-dropdown">
                                <input type="text" class="form-input" id="manageSubService" placeholder="Search or select Sub Service..." autocomplete="off" onfocus="showManageSubServiceDropdown()" oninput="filterManageSubServiceOptions()" disabled>
                                <div class="dropdown-list" id="manageSubServiceDropdown" style="display: none;">
                                    <!-- Options will be populated by JavaScript -->
                                </div>
                            </div>
                            <input type="hidden" id="manageSubServiceValue" value="">
                            <input type="hidden" id="manageSubServiceEn" value="">
                            <input type="hidden" id="manageSubServiceAr" value="">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button type="button" class="btn-primary" onclick="addManageMaintenanceService()" style="width: 100%;">Add</button>
                        </div>
                    </div>
                </div>

                <!-- Grid Table for Maintenance Services -->
                <div class="maintenance-services-grid">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Current Services</h4>
                    <table class="services-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f8fafc; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 80px;">Id</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Main Category Title (En-Ar)</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Sub Category Title (En-Ar)</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Delete</th>
                            </tr>
                        </thead>
                        <tbody id="manageMaintenanceServicesTableBody">
                            <tr>
                                <td colspan="4" style="padding: 20px; text-align: center; color: #6b7280; font-style: italic;">No maintenance services added yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeManageMaintenanceServicesModal()">Close</button>
                <button type="button" class="btn-primary" onclick="saveManageMaintenanceServices()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu toggle - Explicitly attach to window for global access
        window.toggleMobileMenu = function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            }
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.querySelector('.mobile-menu-toggle');
            const overlay = document.getElementById('mobileOverlay');
            
            if (window.innerWidth <= 767) {
                if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                }
            }
        });

        let currentStep = 1;
        const totalSteps = 7;
        let companies = [];
        let filteredCompanies = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentPage = 1;
        const rowsPerPage = 10;
        let teamLeaders = [];
        let zones = [];
        let users = [];
        let branches = [];
        let teamLeaderCounter = 0;
        let zoneCounter = 0;
        let userCounter = 0;
        let branchCounter = 0;
        const timeSlotsList = [
            { value: '08:00-10:00', label: '08:00 - 10:00' },
            { value: '10:00-12:00', label: '10:00 - 12:00' },
            { value: '12:00-14:00', label: '12:00 - 14:00' },
            { value: '14:00-16:00', label: '14:00 - 16:00' }
        ];
        const emergencyResponseSlot = { value: '90-120', label: '90 - 120', display: 'Emergency Response: 90 - 120 Min (Response time)' };

        function getShortCompanyName(title = '') {
            if (!title) return 'XX';
            const cleaned = title.replace(/[^A-Za-z0-9\s]/g, ' ').trim();
            if (!cleaned) return 'XX';

            const words = cleaned.split(/\s+/).filter(Boolean);
            let shortName = '';

            for (const word of words) {
                shortName += word.charAt(0).toUpperCase();
                if (shortName.length >= 3) break;
            }

            if (shortName.length < 3) {
                const fallback = cleaned.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
                shortName += fallback.slice(0, 3 - shortName.length);
            }

            if (shortName.length < 2) {
                shortName = (shortName + 'XX').slice(0, 2);
            }

            return shortName.slice(0, 3);
        }

        function getNextTicketShortCodeNumber(shortName, excludeId = null) {
            const prefix = `TKT-${shortName}-`;
            let maxNumber = 0;

            companies.forEach(company => {
                if (!company || !company.ticketShortCode) return;
                if (excludeId && company.id === excludeId) return;

                const code = company.ticketShortCode.toUpperCase();
                if (code.startsWith(prefix)) {
                    const parts = code.split('-');
                    const numericPart = parts[parts.length - 1];
                    const number = parseInt(numericPart, 10);
                    if (!isNaN(number) && number > maxNumber) {
                        maxNumber = number;
                    }
                }
            });

            return maxNumber + 1;
        }

        function generateTicketShortCodeForTitle(title, excludeId = null) {
            const shortName = getShortCompanyName(title);
            const nextNumber = getNextTicketShortCodeNumber(shortName, excludeId);
            return `TKT-${shortName}-${String(nextNumber).padStart(4, '0')}`;
        }

        function initializeTicketShortCodeAutoGeneration() {
            const titleInput = document.getElementById('companyTitle');
            const shortCodeInput = document.getElementById('ticketShortCode');

            if (!titleInput || !shortCodeInput) return;

            titleInput.addEventListener('input', () => {
                if (shortCodeInput.dataset.userEdited !== 'true') {
                    const excludeId = window.editingCompanyId || null;
                    shortCodeInput.value = generateTicketShortCodeForTitle(titleInput.value.trim(), excludeId);
                    shortCodeInput.dataset.autoGenerated = 'true';
                }
            });

            shortCodeInput.addEventListener('input', () => {
                shortCodeInput.dataset.userEdited = 'true';
                shortCodeInput.dataset.autoGenerated = 'false';
            });

            shortCodeInput.addEventListener('blur', () => {
                if (!shortCodeInput.value) return;
                shortCodeInput.value = shortCodeInput.value.trim().toUpperCase();
            });
        }

        // Sample company data
        const companyTitles = [
            'TechCorp', 'Global Solutions', 'Innovate Inc', 'Premier Services', 'Advanced Systems',
            'Enterprise Ltd', 'Mega Corp', 'Prime Industries', 'Dynamic Group', 'Excellence Co',
            'Venture Partners', 'Strategic Holdings', 'Elite Business', 'Proactive Solutions', 'Modern Enterprise',
            'Future Tech', 'Smart Business', 'Digital Ventures', 'Core Systems', 'Alpha Industries',
            'Beta Corp', 'Gamma Solutions', 'Delta Tech', 'Omega Group', 'Phoenix Co',
            'Apex Industries', 'Summit Corp', 'Peak Solutions', 'Crest Business', 'Zenith Group',
            'Nexus Corp', 'Fusion Tech', 'Quantum Solutions', 'Solar Industries', 'Lunar Group',
            'Stellar Corp', 'Cosmic Tech', 'Galaxy Solutions', 'Orbit Industries', 'Nova Group',
            'Star Corp', 'Astro Tech', 'Mars Solutions', 'Venus Industries', 'Jupiter Group',
            'Saturn Corp', 'Neptune Tech', 'Uranus Solutions', 'Pluto Industries', 'Comet Group',
            'Meteor Corp', 'Asteroid Tech', 'Meteorite Solutions', ' ', 'Diamond Group',
            'Ruby Corp', 'Emerald Tech', 'Sapphire Solutions', 'Pearl Industries', 'Gold Group',
            'Silver Corp', 'Bronze Tech', 'Platinum Solutions', 'Titanium Industries', 'Steel Group',
            'Iron Corp', 'Copper Tech', 'Aluminum Solutions', 'Brass Industries', 'Lead Group',
            'Zinc Corp', 'Nickel Tech', 'Chromium Solutions', 'Manganese Industries', 'Cobalt Group',
            'Tungsten Corp', 'Vanadium Tech', 'Titanium Solutions', 'Molybdenum Industries', 'Tantalum Group',
            'Niobium Corp', 'Hafnium Tech', 'Zirconium Solutions', 'Yttrium Industries', 'Scandium Group',
            'Lanthanum Corp', 'Cerium Tech', 'Praseodymium Solutions', 'Neodymium Industries', 'Promethium Group',
            'Samarium Corp', 'Europium Tech', 'Gadolinium Solutions', ' ', 'Dysprosium Group'
        ];

        const companyTypes = ['LLC', 'Corporation', 'Partnership', 'Sole Proprietorship'];

        // Generate 100 sample companies
        function generateSampleCompanies() {
            companies = []; // Clear existing companies
            for (let i = 1; i <= 100; i++) {
                const randomTitle = companyTitles[Math.floor(Math.random() * companyTitles.length)];
                const randomType = companyTypes[Math.floor(Math.random() * companyTypes.length)];
                const isActive = Math.random() > 0.3; // 70% active
                const branches = Math.floor(Math.random() * 4) + 2; // 2-5 branches
                const ticketShortCode = generateTicketShortCodeForTitle(randomTitle);
                
                // Generate sample team leaders (2-4 per company)
                const numTeamLeaders = Math.floor(Math.random() * 3) + 2; // 2-4 team leaders
                const teamLeaders = [];
                for (let j = 1; j <= numTeamLeaders; j++) {
                    teamLeaders.push({
                        id: `tl_${i}_${j}`,
                        name: `Team Leader ${j}`,
                        nameAr: `  ${j}`,
                        nameEn: `Team Leader ${j}`,
                        mobile: `+962 7${Math.floor(Math.random() * 90000000) + 10000000}`,
                        email: `tl${j}@${randomTitle.toLowerCase().replace(/\s+/g, '')}.com`,
                        image: '',
                        isActive: Math.random() > 0.2, // 80% active
                        startDate: '2023-01-01',
                        endDate: '',
                        categories: ['AC', 'Electric', 'Civils'].slice(0, Math.floor(Math.random() * 3) + 1),
                        description: Math.random() > 0.5 ? `Team Leader ${j} description and notes` : ''
                    });
                }

                // Generate sample zones (1-5 zones per company)
                const numZones = Math.floor(Math.random() * 5) + 1; // 1-5 zones
                const zones = [];
                for (let k = 1; k <= numZones; k++) {
                    const technicalTeam = ['WeFix TL1', 'WeFix TL2', 'WeFix TL3', 'WeFix TL4'].slice(0, Math.floor(Math.random() * 4) + 1);
                    zones.push({
                        id: `zone_${i}_${k}`,
                        title: `Zone ${k}`,
                        number: k.toString(),
                        description: `Description for Zone ${k} - This zone covers specific areas and responsibilities.`,
                        managedBy: Math.random() > 0.5 ? 'WeFix Team' : 'Client Team',
                        technicalTeam: technicalTeam
                    });
                }

                // Generate exactly 1 contract per company
                const contractStartDate = new Date(2023, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
                const contractStartDateStr = contractStartDate.toISOString().split('T')[0];
                const businessModels = ['B2B', 'White Label'];
                const contract = {
                    id: `CNT_${i}_1`,
                    contractNumber: `CNT-${String(i).padStart(3, '0')}`,
                    businessModel: businessModels[Math.floor(Math.random() * businessModels.length)],
                    isActive: Math.random() > 0.2, // 80% active
                    branchCount: branches,
                    preventiveTicketsCount: Math.floor(Math.random() * 50) + 10,
                    correctiveTicketsCount: Math.floor(Math.random() * 30) + 5,
                    startDate: contractStartDateStr,
                    endDate: '',
                    files: '',
                    description: `Contract for ${randomTitle}`,
                    value: '',
                    number: `CNT-${String(i).padStart(3, '0')}`,
                    createdAt: new Date().toISOString()
                };

                companies.push({
                    id: 'CMP' + String(i).padStart(5, '0'),
                    title: randomTitle,
                    nameAr: ` ${randomTitle}`,
                    nameEn: randomTitle,
                    country: 'Jordan',
                    establishedType: randomType,
                    hoAddress: `${Math.floor(Math.random() * 1000) + 1} Main Street, Amman, Jordan`,
                    isActive: isActive,
                    branches: branches,
                    logo: randomTitle.substring(0, 2).toUpperCase(),
                    teamLeaders: teamLeaders,
                    zones: zones,
                    contracts: [contract], // Exactly 1 contract per company
                    maintenanceServices: [],
                    workingHours: {
                        timeSlots: timeSlotsList.map(slot => slot.value),
                        emergencyResponseTime: emergencyResponseSlot.value
                    },
                    ticketShortCode: ticketShortCode,
                    // Branch data
                    branchTitle: `Main Branch`,
                    branchNameAr: ` `,
                    branchNameEn: `Main Branch`,
                    mainCategory: ['AC', 'Civils', 'Electric', 'Inspection'][Math.floor(Math.random() * 4)],
                    subCategory: ['Split AC', 'Package AC', 'VRF'][Math.floor(Math.random() * 3)],
                    branchRepName: `Representative ${i}`,
                    branchRepMobile: `+962 7${Math.floor(Math.random() * 90000000) + 10000000}`,
                    branchRepEmail: `rep${i}@${randomTitle.toLowerCase().replace(/\s+/g, '')}.com`,
                    managedBy: 'WeFix Team'
                });
            }
        }

        // Auto-translate from Arabic to English
        function translateToEnglish(arabicText) {
            // Simple transliteration for demo - In production, use proper translation API
            const transliterationMap = {
                '': 'a', '': 'i', '': 'a', '': 'a',
                '': 'b', '': 't', '': 'th', '': 'j',
                '': 'h', '': 'kh', '': 'd', '': 'dh',
                '': 'r', '': 'z', '': 's', '': 'sh',
                '': 's', '': 'd', '': 't', '': 'z',
                '': 'a', '': 'gh', '': 'f', '': 'q',
                '': 'k', '': 'l', '': 'm', '': 'n',
                '': 'h', '': 'w', '': 'y', '': 'a',
                '': 'a', '': 'a', ' ': ' '
            };
            
            let english = '';
            for (let char of arabicText) {
                english += transliterationMap[char] || char;
            }
            return english;
        }

        // Auto-translate on Arabic input
        document.addEventListener('DOMContentLoaded', function() {
            const arabicInput = document.getElementById('companyNameAr');
            const englishInput = document.getElementById('companyNameEn');
            
            if (arabicInput && englishInput) {
                arabicInput.addEventListener('input', function() {
                    if (this.value && !englishInput.value) {
                        englishInput.value = translateToEnglish(this.value);
                    }
                });
            }
        });

        // File upload handling
        document.addEventListener('DOMContentLoaded', function() {
            const logoUpload = document.getElementById('logoUpload');
            const logoFileName = document.getElementById('logoFileName');
            
            if (logoUpload && logoFileName) {
                logoUpload.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        logoFileName.textContent = e.target.files[0].name;
                        logoFileName.style.display = 'block';
                    }
                });
            }

            // User image upload handling
            const userImageUpload = document.getElementById('userImageUpload');
            const userImageFileName = document.getElementById('userImageFileName');
            
            if (userImageUpload && userImageFileName) {
                userImageUpload.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        userImageFileName.textContent = e.target.files[0].name;
                        userImageFileName.style.display = 'block';
                    }
                });
            }

            initializeWorkingHours();
            initializeTicketShortCodeAutoGeneration();
        });

        // Update Sub Services based on Main Service
        function updateSubCategories(branchId = '') {
            const mainCategorySelect = document.getElementById('mainCategory' + branchId);
            const subCategorySelect = document.getElementById('subCategory' + branchId);
            
            if (!mainCategorySelect || !subCategorySelect) return;
            
            const mainCategory = mainCategorySelect.value;
            
            // Clear existing options
            subCategorySelect.innerHTML = '<option value="">Select Sub Service</option>';
            
            if (mainCategory === ' ') {
                const acOptions = [
                    '      ',
                    '    ',
                    '  ',
                    '  ',
                    '   ',
                    '     ',
                    '  '
                ];
                acOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    subCategorySelect.appendChild(optionElement);
                });
            } else if (mainCategory === '  ') {
                const civilsOptions = [
                    '       ',
                    '   ',
                    '   ',
                    '       ',
                    '   '
                ];
                civilsOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    subCategorySelect.appendChild(optionElement);
                });
            } else if (mainCategory === ' ') {
                const electricOptions = [
                    '   ',
                    '   ',
                    '  ',
                    '  ',
                    '  '
                ];
                electricOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    subCategorySelect.appendChild(optionElement);
                });
            } else if (mainCategory === '  ') {
                const hvacOptions = [
                    '    ()',
                    '   ',
                    '   ',
                    '  ',
                    '  '
                ];
                hvacOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    subCategorySelect.appendChild(optionElement);
                });
            } else if (mainCategory === '') {
                const camOptions = [
                    ' ',
                    '     '
                ];
                camOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    subCategorySelect.appendChild(optionElement);
                });
            } else if (mainCategory === '   ') {
                const optionElement = document.createElement('option');
                optionElement.value = '   ';
                optionElement.textContent = '   ';
                subCategorySelect.appendChild(optionElement);
            }
        }

        // Toggle Team Leaders Section
        function toggleTeamLeadersSection(branchId = '') {
            const managedBySelect = document.getElementById('managedBy' + branchId);
            const teamLeadersSection = document.getElementById('teamLeadersSection' + branchId);
            
            if (!managedBySelect || !teamLeadersSection) return;
            
            const managedBy = managedBySelect.value;
            
            if (managedBy === 'Client Team') {
                teamLeadersSection.style.display = 'block';
            } else {
                teamLeadersSection.style.display = 'none';
            }
        }

        // Add Team Leader
        function addTeamLeader(branchId = '') {
            teamLeaderCounter++;
            const teamLeadersList = document.getElementById('teamLeadersList' + branchId);
            
            const teamLeaderHTML = `
                <div class="dynamic-section" id="teamLeader${teamLeaderCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">Team Leader ${teamLeaderCounter}</span>
                        <button type="button" class="btn-remove" onclick="removeTeamLeader(${teamLeaderCounter})">Remove</button>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Team Leader Name</label>
                            <input type="text" class="form-input" id="tlName${teamLeaderCounter}" placeholder="Team Leader Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Team Leader Mobile Number</label>
                            <input type="tel" class="form-input" id="tlMobile${teamLeaderCounter}" placeholder="+962 7XX XXX XXX">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Main Service (Multi-Select)</label>
                        <div class="multi-select-container">
                            <div class="multi-select-dropdown" id="tlCategoryDropdown${teamLeaderCounter}" onclick="toggleMultiSelect(${teamLeaderCounter})">
                                <span class="multi-select-text" id="tlCategoryText${teamLeaderCounter}">Select Categories</span>
                                <span class="multi-select-arrow"></span>
                            </div>
                            <div class="multi-select-options" id="tlCategoryOptions${teamLeaderCounter}">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="tlCategory${teamLeaderCounter}_all" value="All" onchange="toggleAllCategories(${teamLeaderCounter})">
                                    <label for="tlCategory${teamLeaderCounter}_all">All</label>
                                </div>
                                <div class="multi-select-option">
                                    <input type="checkbox" id="tlCategory${teamLeaderCounter}_ac" value="AC" onchange="updateMultiSelectText(${teamLeaderCounter})">
                                    <label for="tlCategory${teamLeaderCounter}_ac">AC</label>
                                </div>
                                <div class="multi-select-option">
                                    <input type="checkbox" id="tlCategory${teamLeaderCounter}_civils" value="Civils" onchange="updateMultiSelectText(${teamLeaderCounter})">
                                    <label for="tlCategory${teamLeaderCounter}_civils">Civils</label>
                                </div>
                                <div class="multi-select-option">
                                    <input type="checkbox" id="tlCategory${teamLeaderCounter}_electric" value="Electric" onchange="updateMultiSelectText(${teamLeaderCounter})">
                                    <label for="tlCategory${teamLeaderCounter}_electric">Electric</label>
                                </div>
                                <div class="multi-select-option">
                                    <input type="checkbox" id="tlCategory${teamLeaderCounter}_inspection" value="Inspection" onchange="updateMultiSelectText(${teamLeaderCounter})">
                                    <label for="tlCategory${teamLeaderCounter}_inspection">Inspection</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Team Leader Image</label>
                            <input type="file" class="form-input" id="tlImage${teamLeaderCounter}" accept="image/*">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="tlIsActive${teamLeaderCounter}" checked style="width: 18px; height: 18px; cursor: pointer;">
                                Team Leader Is Active
                            </label>
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Team Leader Started Date</label>
                            <input type="date" class="form-input" id="tlStartDate${teamLeaderCounter}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Team Leader End Date</label>
                            <input type="date" class="form-input" id="tlEndDate${teamLeaderCounter}">
                        </div>
                    </div>
                </div>
            `;
            
            teamLeadersList.insertAdjacentHTML('beforeend', teamLeaderHTML);
        }

        // Remove Team Leader
        function removeTeamLeader(id) {
            const teamLeader = document.getElementById('teamLeader' + id);
            if (teamLeader) {
                teamLeader.remove();
            }
        }

        // Toggle Multi-Select Dropdown
        function toggleMultiSelect(teamLeaderId) {
            const dropdown = document.getElementById('tlCategoryDropdown' + teamLeaderId);
            const options = document.getElementById('tlCategoryOptions' + teamLeaderId);
            
            // Close other open dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                if (dd.id !== 'tlCategoryDropdown' + teamLeaderId) {
                    dd.classList.remove('active');
                }
            });
            document.querySelectorAll('.multi-select-options').forEach(opt => {
                if (opt.id !== 'tlCategoryOptions' + teamLeaderId) {
                    opt.classList.remove('show');
                }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('active');
            options.classList.toggle('show');
        }

        // Toggle All Categories
        function toggleAllCategories(teamLeaderId) {
            const allCheckbox = document.getElementById('tlCategory' + teamLeaderId + '_all');
            const otherCheckboxes = [
                document.getElementById('tlCategory' + teamLeaderId + '_ac'),
                document.getElementById('tlCategory' + teamLeaderId + '_civils'),
                document.getElementById('tlCategory' + teamLeaderId + '_electric'),
                document.getElementById('tlCategory' + teamLeaderId + '_inspection')
            ];
            
            if (allCheckbox.checked) {
                // Check all other checkboxes
                otherCheckboxes.forEach(checkbox => {
                    if (checkbox) checkbox.checked = true;
                });
            } else {
                // Uncheck all other checkboxes
                otherCheckboxes.forEach(checkbox => {
                    if (checkbox) checkbox.checked = false;
                });
            }
            
            updateMultiSelectText(teamLeaderId);
        }

        // Update Multi-Select Text Display
        function updateMultiSelectText(teamLeaderId) {
            const textElement = document.getElementById('tlCategoryText' + teamLeaderId);
            const checkboxes = [
                document.getElementById('tlCategory' + teamLeaderId + '_ac'),
                document.getElementById('tlCategory' + teamLeaderId + '_civils'),
                document.getElementById('tlCategory' + teamLeaderId + '_electric'),
                document.getElementById('tlCategory' + teamLeaderId + '_inspection')
            ];
            
            const selectedCategories = [];
            checkboxes.forEach(checkbox => {
                if (checkbox && checkbox.checked) {
                    selectedCategories.push(checkbox.value);
                }
            });
            
            if (selectedCategories.length === 0) {
                textElement.textContent = 'Select Categories';
            } else if (selectedCategories.length === checkboxes.length) {
                textElement.textContent = 'All Categories';
            } else {
                textElement.textContent = selectedCategories.join(', ');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
                document.querySelectorAll('.multi-select-options').forEach(options => {
                    options.classList.remove('show');
                });
            }
        });

        // Working Hours Functions
        function initializeWorkingHours() {
            initializeWorkingTimeSlots();
        }

        function initializeWorkingTimeSlots() {
            const allCheckbox = document.getElementById('timeSlot_all');
            const slotCheckboxes = document.querySelectorAll('.time-slot-checkbox');
            if (!allCheckbox || !slotCheckboxes) {
                return;
            }

            allCheckbox.checked = true;
            slotCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
                checkbox.disabled = true;
            });
        }

        function toggleAllTimeSlots(allCheckbox) {
            const slotCheckboxes = document.querySelectorAll('.time-slot-checkbox');
            const isChecked = allCheckbox.checked;
            slotCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                checkbox.disabled = isChecked;
            });
        }

        function getSelectedTimeSlots() {
            const allSelected = document.getElementById('timeSlot_all')?.checked ?? false;
            if (allSelected) {
                return timeSlotsList.map(slot => slot.value);
            }
            const selectedSlots = [];
            const slotCheckboxes = document.querySelectorAll('.time-slot-checkbox');
            slotCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedSlots.push(checkbox.value);
                }
            });
            return selectedSlots;
        }

        function getWorkingHoursData() {
            return {
                timeSlots: getSelectedTimeSlots(),
                emergencyResponseTime: emergencyResponseSlot.value
            };
        }

        // Add Zone
        function addZone() {
            zoneCounter++;
            const zonesList = document.getElementById('zonesList');
            const managedBy = document.getElementById('managedBy')?.value || 'WeFix Team';
            
            // Get WeFix Team Leaders
            const wefixTLs = ['WeFix TL1', 'WeFix TL2', 'WeFix TL3', 'WeFix TL4'];
            
            // Get Client Team Team Leaders
            let inHouseTLs = [];
            for (let i = 1; i <= teamLeaderCounter; i++) {
                const tlName = document.getElementById('tlName' + i)?.value;
                if (tlName) {
                    inHouseTLs.push(tlName);
                }
            }
            
            const zonesHTML = `
                <div class="dynamic-section" id="zone${zoneCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">Zone ${zoneCounter}</span>
                        <button type="button" class="btn-remove" onclick="removeZone(${zoneCounter})">Remove</button>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Zone Title</label>
                            <input type="text" class="form-input" id="zoneTitle${zoneCounter}" placeholder="Zone Title">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Zone Number</label>
                            <input type="text" class="form-input" id="zoneNumber${zoneCounter}" placeholder="Zone Number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone Description</label>
                        <textarea class="form-input form-textarea" id="zoneDescription${zoneCounter}" placeholder="Zone Description"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone Managed by Team Leader</label>
                        <select class="form-input" id="zoneManagedBy${zoneCounter}">
                            <option value="">Select Team Leader</option>
                            ${managedBy === 'Client Team' ? inHouseTLs.map(tl => `<option value="${tl}">${tl}</option>`).join('') : wefixTLs.map(tl => `<option value="${tl}">${tl}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
            
            zonesList.insertAdjacentHTML('beforeend', zonesHTML);
        }

        // Remove Zone
        function removeZone(id) {
            const zone = document.getElementById('zone' + id);
            if (zone) {
                zone.remove();
            }
        }

        // Add User
        function addUser() {
            userCounter++;
            const usersList = document.getElementById('usersList');
            
            const userHTML = `
                <div class="dynamic-section" id="user${userCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">User ${userCounter}</span>
                        <button type="button" class="btn-remove" onclick="removeUser(${userCounter})">Remove</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required"> User Role</label>
                        <select class="form-input" id="userType${userCounter}">
                            <option value="">Select User Role</option>
                            <option value="Owner (Admin)">Owner (Admin)</option>
                            <option value="Team Leader">Team Leader</option>
                            <option value="Technician">Technician</option>
                        </select>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required"> Full Name Ar</label>
                            <input type="text" class="form-input" id="userNameAr${userCounter}" placeholder=" ">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required"> Full Name En</label>
                            <input type="text" class="form-input" id="userNameEn${userCounter}" placeholder="User Name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> User Image</label>
                        <div class="file-upload-container" onclick="document.getElementById('userImageUpload${userCounter}').click()">
                            <div class="file-upload-icon"></div>
                            <div class="file-upload-text">Click to upload user image</div>
                            <div class="file-upload-text" id="userImageFileName${userCounter}" style="display: none; color: #F78F1E;"></div>
                            <input type="file" id="userImageUpload${userCounter}" class="file-upload-input" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required"> Mobile Number</label>
                        <input type="tel" class="form-input" id="userMobile${userCounter}" placeholder="+962 7XX XXX XXX">
                        <small style="color: #6b7280; font-size: 12px;">Format: Country code + Mobile number</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Email Address</label>
                        <input type="email" class="form-input" id="userEmail${userCounter}" placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Description</label>
                        <textarea class="form-input form-textarea" id="userDescription${userCounter}" placeholder="Enter user description" rows="3"></textarea>
                    </div>
                </div>
            `;
            
            usersList.insertAdjacentHTML('beforeend', userHTML);
            
            // Add event listener for file upload
            const userImageUpload = document.getElementById('userImageUpload' + userCounter);
            const userImageFileName = document.getElementById('userImageFileName' + userCounter);
            
            if (userImageUpload && userImageFileName) {
                userImageUpload.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        userImageFileName.textContent = e.target.files[0].name;
                        userImageFileName.style.display = 'block';
                    }
                });
            }
        }

        // Remove User
        function removeUser(id) {
            const user = document.getElementById('user' + id);
            if (user) {
                user.remove();
            }
        }

        // Add Branch
        function addBranch() {
            branchCounter++;
            const branchesList = document.getElementById('branchesList');
            
            const branchHTML = `
                <div class="dynamic-section" id="branch${branchCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">Branch ${branchCounter}</span>
                        <button type="button" class="btn-remove" onclick="removeBranch(${branchCounter})">Remove</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Branch Title</label>
                        <input type="text" class="form-input" id="branchTitle${branchCounter}" placeholder="Enter branch title">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Branch Name (Arabic)</label>
                            <input type="text" class="form-input" id="branchNameAr${branchCounter}" placeholder=" ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Branch Name (English)</label>
                            <input type="text" class="form-input" id="branchNameEn${branchCounter}" placeholder="Branch Name">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Main Service</label>
                            <select class="form-input" id="mainCategory${branchCounter}" onchange="updateSubCategories(${branchCounter})">
                                <option value="">Select Main Service</option>
                                <option value=" "> </option>
                                <option value="  ">  </option>
                                <option value=" "> </option>
                                <option value="  ">  </option>
                                <option value=""></option>
                                <option value="   ">   </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub Service</label>
                            <select class="form-input" id="subCategory${branchCounter}">
                                <option value="">Select Sub Service</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Branch Representative Name</label>
                        <input type="text" class="form-input" id="branchRepName${branchCounter}" placeholder="Representative Name">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Representative Mobile Number</label>
                            <input type="tel" class="form-input" id="branchRepMobile${branchCounter}" placeholder="+962 7XX XXX XXX">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Representative Email Address</label>
                            <input type="email" class="form-input" id="branchRepEmail${branchCounter}" placeholder="rep@example.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Managed By</label>
                        <select class="form-input" id="managedBy${branchCounter}" onchange="toggleTeamLeadersSection(${branchCounter})">
                            <option value="">Select</option>
                            <option value="Client Team">Client Team</option>
                            <option value="WeFix Team">WeFix Team</option>
                        </select>
                    </div>
                    
                    <!-- Conditional Team Leaders Section -->
                    <div class="conditional-section" id="teamLeadersSection${branchCounter}" style="display: none;">
                        <h5 style="margin-bottom: 15px; color: #E67E00;">Add Team Leaders</h5>
                        <div id="teamLeadersList${branchCounter}"></div>
                        <button type="button" class="btn-add-item" onclick="addTeamLeader(${branchCounter})">+ Add Team Leader</button>
                    </div>
                </div>
            `;
            
            branchesList.insertAdjacentHTML('beforeend', branchHTML);
        }

        // Remove Branch
        function removeBranch(id) {
            const branch = document.getElementById('branch' + id);
            if (branch) {
                branch.remove();
            }
        }

        // Toggle Customers submenu
        const customersLink = document.querySelector('.customers-link');
        const customersSubmenu = document.getElementById('customersSubmenu');

        if (customersLink && customersSubmenu) {
            customersLink.addEventListener('click', function(e) {
                e.preventDefault();
                customersSubmenu.classList.toggle('open');
            });
        }

        // Modal Functions - Explicitly attach to window for global access
        window.openModal = function openModal() {
            try {
                const modal = document.getElementById('companyModal');
                if (!modal) {
                    console.error('Company modal element not found');
                    return;
                }
                modal.classList.add('active');
                currentStep = 1;
                const ticketShortCodeInput = document.getElementById('ticketShortCode');
                if (ticketShortCodeInput) {
                    let initialShortCode = '';
                    if (window.editingCompanyId) {
                        const existingCompany = companies.find(c => c.id === window.editingCompanyId);
                        if (existingCompany && existingCompany.ticketShortCode) {
                            initialShortCode = existingCompany.ticketShortCode.toUpperCase();
                            ticketShortCodeInput.dataset.userEdited = 'true';
                            ticketShortCodeInput.dataset.autoGenerated = 'false';
                        }
                    }
                    if (!initialShortCode) {
                        ticketShortCodeInput.dataset.userEdited = 'false';
                        ticketShortCodeInput.dataset.autoGenerated = 'true';
                        const titleInput = document.getElementById('companyTitle');
                        const titleValue = titleInput ? titleInput.value.trim() : '';
                        const excludeId = window.editingCompanyId || null;
                        initialShortCode = generateTicketShortCodeForTitle(titleValue, excludeId);
                    }
                    ticketShortCodeInput.value = initialShortCode;
                }
                // Only update wizard UI if elements exist
                setTimeout(() => {
                    try {
                        updateWizardUI();
                        initializeWorkingHours();
                        // Auto-fill contract reference if not editing
                        if (!window.editingCompany) {
                            const nextContractNumber = getNextContractNumber();
                            const contractInput = document.getElementById('contractNumber');
                            if (contractInput && !contractInput.value) {
                                contractInput.value = nextContractNumber;
                            }
                        }
                    } catch (e) {
                        console.error('Error updating wizard UI:', e);
                    }
                }, 50);
            } catch (error) {
                console.error('Error opening modal:', error);
            }
        }

        window.closeModal = function closeModal() {
            document.getElementById('companyModal').classList.remove('active');
            // Reset form after closing
            setTimeout(() => {
                currentStep = 1;
                updateWizardUI();
                document.querySelectorAll('.form-input').forEach(input => input.value = '');
                document.querySelectorAll('.form-textarea').forEach(textarea => textarea.value = '');
                document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
                const ticketShortCodeInput = document.getElementById('ticketShortCode');
                if (ticketShortCodeInput) {
                    ticketShortCodeInput.dataset.userEdited = 'false';
                    ticketShortCodeInput.dataset.autoGenerated = 'false';
                }
                
                // Reset dynamic sections
                document.getElementById('teamLeadersList').innerHTML = '';
                document.getElementById('zonesList').innerHTML = '';
                document.getElementById('teamLeadersSection').classList.remove('show');
                teamLeaderCounter = 0;
                zoneCounter = 0;
                
                // Reset maintenance services
                maintenanceServicesList = [];
                maintenanceServiceCounter = 0;
                if (document.getElementById('maintenanceServicesTableBody')) {
                    updateMaintenanceServicesTable();
                }
                if (document.getElementById('maintenanceMainService')) {
                    document.getElementById('maintenanceMainService').value = '';
                    document.getElementById('maintenanceMainServiceValue').value = '';
                    document.getElementById('maintenanceSubService').value = '';
                    document.getElementById('maintenanceSubService').disabled = true;
                    document.getElementById('maintenanceSubServiceValue').value = '';
                }
                initializeWorkingHours();
                
                // Reset subcategory dropdown
                document.getElementById('subCategory').innerHTML = '<option value="">Select Sub Category</option>';
                
                // Clear editing state
                window.editingCompany = null;
                window.editingCompanyId = null;
                
                // Reset file upload
                const logoFileName = document.getElementById('logoFileName');
                if (logoFileName) {
                    logoFileName.style.display = 'none';
                }
            }, 300);
        }

        // Count Control Functions
        function incrementCount(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                const currentValue = parseInt(input.value) || 0;
                const minValue = parseInt(input.min) || 0;
                input.value = Math.max(minValue, currentValue + 1);
            }
        }

        function decrementCount(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                const currentValue = parseInt(input.value) || 0;
                const minValue = parseInt(input.min) || 0;
                input.value = Math.max(minValue, currentValue - 1);
            }
        }

        // Add error border and focus to element
        function showValidationError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.borderColor = '#EF4444';
                element.style.borderWidth = '2px';
                element.focus();
                
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: message,
                    confirmButtonColor: '#E67E00'
                });
                
                // Remove error border after 3 seconds
                setTimeout(() => {
                    element.style.borderColor = '';
                    element.style.borderWidth = '';
                }, 3000);
            }
        }

        // Validate current step
        function validateCurrentStep() {
            if (currentStep === 2) {
                // Validate Business Model (required)
                const businessModelB2B = document.getElementById('businessModelB2B');
                const businessModelWhiteLabel = document.getElementById('businessModelWhiteLabel');
                const radioGroup = businessModelB2B.closest('.radio-group');
                if (!businessModelB2B.checked && !businessModelWhiteLabel.checked) {
                    if (radioGroup) {
                        radioGroup.classList.add('error');
                        setTimeout(() => {
                            radioGroup.classList.remove('error');
                        }, 3000);
                    }
                    businessModelB2B.focus();
                    Swal.fire({
                        icon: 'error',
                        title: 'Validation Error',
                        text: 'Please select a Business Model',
                        confirmButtonColor: '#E67E00'
                    });
                    return false;
                }
            }
            return true;
        }

        // Wizard Navigation
        function nextStep() {
            // Validate current step before proceeding
            if (!validateCurrentStep()) {
                return;
            }
            
            if (currentStep < totalSteps) {
                currentStep++;
                updateWizardUI();
            } else {
                saveCompany();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizardUI();
            }
        }

        function updateWizardUI() {
            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });

            // Update sections
            document.querySelectorAll('.wizard-section').forEach((section, index) => {
                section.classList.remove('active');
                if (index + 1 === currentStep) {
                    section.classList.add('active');
                    // Update team leader dropdown when section 4 (Branch) is displayed
                    if (index + 1 === 4) {
                        setTimeout(() => updateWizardBranchTeamLeaderDropdown(), 100);
                    }
                }
            });

            // Update buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.style.display = currentStep === 1 ? 'none' : 'block';
            nextBtn.textContent = currentStep === totalSteps ? 'Save' : 'Next';
        }

        // Function to handle wizard step clicks
        // Maintenance Services Data
        const maintenanceServicesData = {
            ' ': {
                en: 'Electrical Works',
                ar: ' ',
                subServices: {
                    '      ': { en: 'Repair or replace electrical products, sockets and switches', ar: '      ' },
                    '    ': { en: 'Install or replace lighting units', ar: '    ' },
                    '  ': { en: 'Maintenance of electrical panels', ar: '  ' },
                    '  ': { en: 'Maintenance of circuit breakers', ar: '  ' },
                    '   ': { en: 'Extend new ground point', ar: '   ' },
                    '     ': { en: 'Extend new electrical point or sockets', ar: '     ' },
                    '  ': { en: 'Other electrical works', ar: '  ' }
                }
            },
            '  ': {
                en: 'Mechanical and Sanitary Works',
                ar: '  ',
                subServices: {
                    '       ': { en: 'Maintenance or repair of water network and sewage', ar: '       ' },
                    '   ': { en: 'Maintenance of water cycle pumps', ar: '   ' },
                    '   ': { en: 'Maintenance and installation of water heaters', ar: '   ' },
                    '       ': { en: 'Maintenance and repairs of water tanks, external connections, boilers and cleaners', ar: '       ' },
                    '   ': { en: 'Other sanitary and mechanical works', ar: '   ' }
                }
            },
            ' ': {
                en: 'Civil Works',
                ar: ' ',
                subServices: {
                    '   ': { en: 'Painting and wallpaper works', ar: '   ' },
                    '   ': { en: 'Treatment of moisture and mold problems', ar: '   ' },
                    '  ': { en: 'Internal and external insulation', ar: '  ' },
                    '  ': { en: 'Maintenance of windows and doors', ar: '  ' },
                    '  ': { en: 'Other civil works', ar: '  ' }
                }
            },
            '  ': {
                en: 'Ventilation and Air Conditioning Works',
                ar: '  ',
                subServices: {
                    '    ()': { en: 'Maintenance of internal air conditioning units (split)', ar: '    ()' },
                    '   ': { en: 'Maintenance of central air conditioning units', ar: '   ' },
                    '   ': { en: 'Maintenance of ventilation systems and exhausts', ar: '   ' },
                    '  ': { en: 'Replace air filters', ar: '  ' },
                    '  ': { en: 'Other air conditioning works', ar: '  ' }
                }
            },
            '': {
                en: 'Cameras',
                ar: '',
                subServices: {
                    ' ': { en: 'Camera maintenance', ar: ' ' },
                    '     ': { en: 'Install new smart or regular cameras', ar: '     ' }
                }
            },
            '   ': {
                en: 'Design and Decoration Maintenance',
                ar: '   ',
                subServices: {
                    '   ': { en: 'Design and decoration maintenance', ar: '   ' }
                }
            }
        };

        let maintenanceServicesList = [];
        let maintenanceServiceCounter = 0;

        // Initialize Maintenance Services dropdowns
        function initializeMaintenanceServices() {
            const mainServiceDropdown = document.getElementById('mainServiceDropdown');
            if (!mainServiceDropdown) return;

            mainServiceDropdown.innerHTML = '';
            Object.keys(maintenanceServicesData).forEach(key => {
                const service = maintenanceServicesData[key];
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-value', key);
                item.setAttribute('data-en', service.en);
                item.setAttribute('data-ar', service.ar);
                item.innerHTML = `${service.en} / ${service.ar}`;
                item.onclick = () => selectMainService(key, service.en, service.ar);
                mainServiceDropdown.appendChild(item);
            });
        }

        // Show Main Service Dropdown
        function showMainServiceDropdown() {
            const dropdown = document.getElementById('mainServiceDropdown');
            if (dropdown) {
                dropdown.style.display = 'block';
                initializeMaintenanceServices();
            }
        }

        // Filter Main Service Options
        function filterMainServiceOptions() {
            const input = document.getElementById('maintenanceMainService');
            const filter = input.value.toLowerCase();
            const items = document.querySelectorAll('#mainServiceDropdown .dropdown-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Select Main Service
        function selectMainService(value, en, ar) {
            document.getElementById('maintenanceMainService').value = `${en} / ${ar}`;
            document.getElementById('maintenanceMainServiceValue').value = value;
            document.getElementById('maintenanceMainServiceEn').value = en;
            document.getElementById('maintenanceMainServiceAr').value = ar;
            document.getElementById('mainServiceDropdown').style.display = 'none';
            
            // Enable and populate Sub Service dropdown
            const subServiceInput = document.getElementById('maintenanceSubService');
            subServiceInput.disabled = false;
            subServiceInput.value = '';
            document.getElementById('maintenanceSubServiceValue').value = '';
            document.getElementById('maintenanceSubServiceEn').value = '';
            document.getElementById('maintenanceSubServiceAr').value = '';
            
            populateSubServices(value);
        }

        // Populate Sub Services
        function populateSubServices(mainServiceKey) {
            const subServiceDropdown = document.getElementById('subServiceDropdown');
            if (!subServiceDropdown) return;

            subServiceDropdown.innerHTML = '';
            const subServices = maintenanceServicesData[mainServiceKey].subServices;
            
            Object.keys(subServices).forEach(key => {
                const subService = subServices[key];
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-value', key);
                item.setAttribute('data-en', subService.en);
                item.setAttribute('data-ar', subService.ar);
                item.innerHTML = `${subService.en} / ${subService.ar}`;
                item.onclick = () => selectSubService(key, subService.en, subService.ar);
                subServiceDropdown.appendChild(item);
            });
        }

        // Show Sub Service Dropdown
        function showSubServiceDropdown() {
            const mainServiceValue = document.getElementById('maintenanceMainServiceValue').value;
            if (!mainServiceValue) {
                alert('Please select Main Service first');
                return;
            }
            const dropdown = document.getElementById('subServiceDropdown');
            if (dropdown) {
                dropdown.style.display = 'block';
            }
        }

        // Filter Sub Service Options
        function filterSubServiceOptions() {
            const input = document.getElementById('maintenanceSubService');
            const filter = input.value.toLowerCase();
            const items = document.querySelectorAll('#subServiceDropdown .dropdown-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Select Sub Service
        function selectSubService(value, en, ar) {
            document.getElementById('maintenanceSubService').value = `${en} / ${ar}`;
            document.getElementById('maintenanceSubServiceValue').value = value;
            document.getElementById('maintenanceSubServiceEn').value = en;
            document.getElementById('maintenanceSubServiceAr').value = ar;
            document.getElementById('subServiceDropdown').style.display = 'none';
        }

        // Add Maintenance Service
        function addMaintenanceService() {
            const mainServiceValue = document.getElementById('maintenanceMainServiceValue').value;
            const mainServiceEn = document.getElementById('maintenanceMainServiceEn').value;
            const mainServiceAr = document.getElementById('maintenanceMainServiceAr').value;
            const subServiceValue = document.getElementById('maintenanceSubServiceValue').value;
            const subServiceEn = document.getElementById('maintenanceSubServiceEn').value;
            const subServiceAr = document.getElementById('maintenanceSubServiceAr').value;

            if (!mainServiceValue || !subServiceValue) {
                alert('Please select both Main Service and Sub Service');
                return;
            }

            maintenanceServiceCounter++;
            const service = {
                id: maintenanceServiceCounter,
                mainServiceValue: mainServiceValue,
                mainServiceEn: mainServiceEn,
                mainServiceAr: mainServiceAr,
                subServiceValue: subServiceValue,
                subServiceEn: subServiceEn,
                subServiceAr: subServiceAr
            };

            maintenanceServicesList.push(service);
            updateMaintenanceServicesTable();
            
            // Clear inputs
            document.getElementById('maintenanceMainService').value = '';
            document.getElementById('maintenanceMainServiceValue').value = '';
            document.getElementById('maintenanceMainServiceEn').value = '';
            document.getElementById('maintenanceMainServiceAr').value = '';
            document.getElementById('maintenanceSubService').value = '';
            document.getElementById('maintenanceSubService').disabled = true;
            document.getElementById('maintenanceSubServiceValue').value = '';
            document.getElementById('maintenanceSubServiceEn').value = '';
            document.getElementById('maintenanceSubServiceAr').value = '';
        }

        // Update Maintenance Services Table
        function updateMaintenanceServicesTable() {
            const tbody = document.getElementById('maintenanceServicesTableBody');
            if (!tbody) return;

            if (maintenanceServicesList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7280; font-style: italic;">No maintenance services added yet</td></tr>';
                return;
            }

            tbody.innerHTML = maintenanceServicesList.map(service => `
                <tr>
                    <td>${service.id}</td>
                    <td>${service.mainServiceEn} / ${service.mainServiceAr}</td>
                    <td>${service.subServiceEn} / ${service.subServiceAr}</td>
                    <td style="text-align: center;">
                        <button class="btn-delete" onclick="deleteMaintenanceService(${service.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Delete Maintenance Service
        function deleteMaintenanceService(id) {
            maintenanceServicesList = maintenanceServicesList.filter(service => service.id !== id);
            updateMaintenanceServicesTable();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.searchable-dropdown')) {
                document.getElementById('mainServiceDropdown').style.display = 'none';
                document.getElementById('subServiceDropdown').style.display = 'none';
            }
        });

        function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= totalSteps) {
                currentStep = stepNumber;
                updateWizardUI();
            }
        }

        // Save Company
        function saveCompany() {
            const title = document.getElementById('companyTitle').value;
            const nextId = companies.length + 1;
            
            // Collect Team Leaders data
            const teamLeadersData = [];
            for (let i = 1; i <= teamLeaderCounter; i++) {
                const tlElement = document.getElementById('teamLeader' + i);
                if (tlElement) {
                    // Collect selected categories
                    const selectedCategories = [];
                    const categoryCheckboxes = [
                        document.getElementById('tlCategory' + i + '_ac'),
                        document.getElementById('tlCategory' + i + '_civils'),
                        document.getElementById('tlCategory' + i + '_electric'),
                        document.getElementById('tlCategory' + i + '_inspection')
                    ];
                    
                    categoryCheckboxes.forEach(checkbox => {
                        if (checkbox && checkbox.checked) {
                            selectedCategories.push(checkbox.value);
                        }
                    });
                    
                    teamLeadersData.push({
                        name: document.getElementById('tlName' + i)?.value || '',
                        mobile: document.getElementById('tlMobile' + i)?.value || '',
                        image: document.getElementById('tlImage' + i)?.files[0]?.name || '',
                        isActive: document.getElementById('tlIsActive' + i)?.checked || false,
                        startDate: document.getElementById('tlStartDate' + i)?.value || '',
                        endDate: document.getElementById('tlEndDate' + i)?.value || '',
                        categories: selectedCategories
                    });
                }
            }
            
            // Collect Zones data
            const zonesData = [];
            for (let i = 1; i <= zoneCounter; i++) {
                const zoneElement = document.getElementById('zone' + i);
                if (zoneElement) {
                    // Collect technical team checkboxes
                    const technicalTeam = [];
                    const checkboxes = [
                        'electrical', 'plumbing', 'hvac', 'painting', 'carpentry', 'general'
                    ];
                    checkboxes.forEach(tech => {
                        const checkbox = document.getElementById(`tech${i}_${tech}`);
                        if (checkbox && checkbox.checked) {
                            technicalTeam.push(checkbox.value);
                        }
                    });
                    
                    zonesData.push({
                        title: document.getElementById('zoneTitle' + i)?.value || '',
                        number: document.getElementById('zoneNumber' + i)?.value || '',
                        description: document.getElementById('zoneDescription' + i)?.value || '',
                        managedBy: document.getElementById('zoneManagedBy' + i)?.value || '',
                        technicalTeam: technicalTeam
                    });
                }
            }
            
            // Get user/owner info from wizard section 5
            const userType = document.getElementById('wizardUserType').value;
            const userNameAr = document.getElementById('wizardUserNameAr').value;
            const userNameEn = document.getElementById('wizardUserNameEn').value;
            const userMobile = document.getElementById('wizardUserMobile').value;
            const userCountry = document.getElementById('wizardUserCountry').value;
            const userEmail = document.getElementById('wizardUserEmail').value;
            const userDescription = document.getElementById('wizardUserDescription').value;
            
            // Get contract info from wizard section 2
            const contractNumber = document.getElementById('contractNumber').value;
            const contractTitle = document.getElementById('contractTitle') ? document.getElementById('contractTitle').value : '';
            
            const businessModelB2B = document.getElementById('businessModelB2B');
            const businessModelWhiteLabel = document.getElementById('businessModelWhiteLabel');
            const businessModel = businessModelB2B.checked ? businessModelB2B.value : (businessModelWhiteLabel.checked ? businessModelWhiteLabel.value : '');
            
            const contractIsActive = document.getElementById('contractIsActive').checked;
            const ownerCount = parseInt(document.getElementById('ownerCount') ? document.getElementById('ownerCount').value : 1) || 1;
            const teamLeaderCount = parseInt(document.getElementById('teamLeaderCount').value) || 1;
            const branchCount = parseInt(document.getElementById('branchCount').value) || 1;
            const preventiveTicketsCount = parseInt(document.getElementById('preventiveTicketsCount').value) || 1;
            const correctiveTicketsCount = parseInt(document.getElementById('correctiveTicketsCount').value) || 1;
            const emergencyTicketsCount = parseInt(document.getElementById('emergencyTicketsCount').value) || 1;
            
            const contractStartDate = document.getElementById('contractStartDate').value;
            const contractEndDate = document.getElementById('contractEndDate').value;
            const wizardManagedBy = document.querySelector('input[name="wizardManagedBy"]:checked')?.value || '';
            const contractFiles = document.getElementById('contractFilesUpload').files;
            const contractDescription = document.getElementById('contractDescription').value;
            const contractValue = document.getElementById('contractValue').value;
            const ticketShortCodeInput = document.getElementById('ticketShortCode');
            let ticketShortCode = ticketShortCodeInput ? ticketShortCodeInput.value.trim().toUpperCase() : '';
            if (ticketShortCodeInput) {
                ticketShortCodeInput.value = ticketShortCode;
            }
            
            // Get branch info from wizard section 3
            const branchTitle = document.getElementById('wizardBranchTitle').value;
            const branchNameAr = document.getElementById('wizardBranchNameAr').value;
            const branchNameEn = document.getElementById('wizardBranchNameEn').value;
            
            const branchRepName = document.getElementById('wizardBranchRepName').value;
            const branchRepMobile = document.getElementById('wizardBranchRepMobile').value;
            const branchRepEmail = document.getElementById('wizardBranchRepEmail').value;
            const branchTeamLeader = document.getElementById('wizardBranchTeamLeader')?.value || '';
            const branchIsActive = document.getElementById('wizardBranchIsActive')?.checked ?? true;
            
            // Collect wizard team leaders data
            const wizardTeamLeadersData = [];
            for (let i = 1; i <= wizardTeamLeaderCounter; i++) {
                const tlElement = document.getElementById('wizardTeamLeader' + i);
                if (tlElement) {
                    const selectedCategories = [];
                    const categoryCheckboxes = [
                        document.getElementById('wizardTLCategory' + i + '_ac'),
                        document.getElementById('wizardTLCategory' + i + '_civils'),
                        document.getElementById('wizardTLCategory' + i + '_electric'),
                        document.getElementById('wizardTLCategory' + i + '_inspection')
                    ];
                    categoryCheckboxes.forEach(checkbox => {
                        if (checkbox && checkbox.checked) {
                            selectedCategories.push(checkbox.value);
                        }
                    });
                    wizardTeamLeadersData.push({
                        name: document.getElementById('wizardTLName' + i)?.value || '',
                        nameEn: document.getElementById('wizardTLNameEn' + i)?.value || '',
                        mobile: document.getElementById('wizardTLMobile' + i)?.value || '',
                        userType: document.getElementById('wizardTLUserType' + i)?.value || 'Team Leader',
                        image: document.getElementById('wizardTLImage' + i)?.files[0]?.name || '',
                        isActive: document.getElementById('wizardTLIsActive' + i)?.checked || false,
                        startDate: document.getElementById('wizardTLStartDate' + i)?.value || '',
                        endDate: document.getElementById('wizardTLEndDate' + i)?.value || '',
                        description: document.getElementById('wizardTLDescription' + i)?.value || '',
                        categories: selectedCategories
                    });
                }
            }
            
            // Get zone info from wizard section 5
            const zoneTitle = document.getElementById('wizardZoneTitle').value;
            const zoneNumber = document.getElementById('wizardZoneNumber').value;
            const zoneDescription = document.getElementById('wizardZoneDescription').value;
            const zoneIsActive = document.getElementById('wizardZoneIsActive')?.checked ?? true;
            const workingHoursData = getWorkingHoursData();
            
            // Technical team removed - set to empty array
            const wizardTechnicalTeam = [];
            
            // Validate required fields
            if (!contractStartDate) {
                showValidationError('contractStartDate', 'Please select Contract Start Date');
                return;
            }
            if (!contractEndDate) {
                showValidationError('contractEndDate', 'Please select Contract End Date');
                return;
            }
            if (!wizardManagedBy) {
                showValidationError('wizardManagedByClientTeam', 'Please select Managed By');
                return;
            }
            if (!ticketShortCode) {
                showValidationError('ticketShortCode', 'Please enter Ticket ShortCode');
                return;
            }
            const ticketShortCodePattern = /^TKT-[A-Z0-9]{2,}-\d{4}$/;
            if (!ticketShortCodePattern.test(ticketShortCode)) {
                showValidationError('ticketShortCode', 'Ticket ShortCode must follow the format TKT-XXX-0001');
                return;
            }
            const duplicateShortCode = companies.some(c => c.ticketShortCode && c.ticketShortCode.toUpperCase() === ticketShortCode && (!window.editingCompanyId || c.id !== window.editingCompanyId));
            if (duplicateShortCode) {
                showValidationError('ticketShortCode', 'Ticket ShortCode must be unique');
                return;
            }
            if (!branchTitle) {
                showValidationError('wizardBranchTitle', 'Please enter Branch Title');
                return;
            }
            if (!branchNameAr) {
                showValidationError('wizardBranchNameAr', 'Please enter Branch Name (Arabic)');
                return;
            }
            if (!branchNameEn) {
                showValidationError('wizardBranchNameEn', 'Please enter Branch Name (English)');
                return;
            }
            if (!branchRepName) {
                showValidationError('wizardBranchRepName', 'Please enter Branch Representative Name');
                return;
            }
            if (!branchRepMobile) {
                showValidationError('wizardBranchRepMobile', 'Please enter Representative Mobile Number');
                return;
            }
            if (!zoneTitle) {
                showValidationError('wizardZoneTitle', 'Please enter Zone Title');
                return;
            }
            if (!zoneNumber) {
                showValidationError('wizardZoneNumber', 'Please enter Zone Number');
                return;
            }
            
            const company = {
                id: 'CMP' + String(nextId).padStart(5, '0'),
                title: title,
                nameAr: document.getElementById('companyNameAr').value,
                nameEn: document.getElementById('companyNameEn').value,
                country: document.getElementById('companyCountry').value,
                establishedType: document.getElementById('companyType').value,
                hoAddress: document.getElementById('hoAddress').value,
                logo: document.getElementById('logoUpload').files[0]?.name || title.substring(0, 2).toUpperCase(),
                // User/Owner info
                ownerNameAr: userNameAr,
                ownerNameEn: userNameEn,
                ownerMobile: userMobile ? `${userCountry} ${userMobile}` : '',
                ownerEmail: userEmail,
                ownerUserType: userType,
                ownerDescription: userDescription,
                // Contract info
                contractNumber: contractNumber,
                contractTitle: contractTitle,
                businessModel: businessModel,
                contractIsActive: contractIsActive,
                ownerCount: ownerCount,
                teamLeaderCount: teamLeaderCount,
                branchCount: branchCount,
                preventiveTicketsCount: preventiveTicketsCount,
                correctiveTicketsCount: correctiveTicketsCount,
                emergencyTicketsCount: emergencyTicketsCount,
                contractStartDate: contractStartDate,
                contractEndDate: contractEndDate,
                contractFiles: contractFiles?.length > 0 ? Array.from(contractFiles).map(f => f.name).join(', ') : '',
                contractDescription: contractDescription,
                contractValue: contractValue,
                // Branch info
                branchTitle: branchTitle,
                branchNameAr: branchNameAr,
                branchNameEn: branchNameEn,
                branchRepName: branchRepName,
                branchRepMobile: branchRepMobile,
                branchRepEmail: branchRepEmail,
                managedBy: wizardManagedBy,
                branchTeamLeader: branchTeamLeader,
                branchIsActive: branchIsActive,
                teamLeaders: wizardTeamLeadersData,
                // Zone info
                zones: [{
                    id: `zone_${Date.now()}_1`,
                    title: zoneTitle,
                    number: zoneNumber,
                    description: zoneDescription,
                    technicalTeam: wizardTechnicalTeam,
                    isActive: zoneIsActive
                }],
                maintenanceServices: maintenanceServicesList.map(service => ({
                    id: service.id,
                    mainServiceValue: service.mainServiceValue,
                    mainServiceEn: service.mainServiceEn,
                    mainServiceAr: service.mainServiceAr,
                    subServiceValue: service.subServiceValue,
                    subServiceEn: service.subServiceEn,
                    subServiceAr: service.subServiceAr
                })),
                workingHours: workingHoursData,
                ticketShortCode: ticketShortCode,
                isActive: true,
                branches: 1
            };

            // Check if we're editing an existing company
            if (window.editingCompanyId) {
                // Find and update existing company
                const index = companies.findIndex(c => c.id === window.editingCompanyId);
                if (index !== -1) {
                    companies[index] = company;
                }
                
                // Clear editing state
                window.editingCompany = null;
                window.editingCompanyId = null;
                
                // Show update success message
                Swal.fire({
                    icon: 'success',
                    title: 'Updated!',
                    text: 'Company updated successfully',
                    confirmButtonColor: '#E67E00',
                    confirmButtonText: 'OK',
                    timer: 3000,
                    timerProgressBar: true
                });
            } else {
                // Add new company
                companies.push(company);
                
                // Show add success message
                showSuccessMessage();
            }
            
            // Save to localStorage
            saveCompaniesToStorage();
            
            filterCompanies();
            closeModal();
        }

        // Show Success Message using SweetAlert2
        function showSuccessMessage() {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Company added successfully',
                confirmButtonColor: '#E67E00',
                confirmButtonText: 'OK',
                timer: 3000,
                timerProgressBar: true,
                showClass: {
                    popup: 'animate__animated animate__fadeInUp'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutDown'
                }
            });
        }

        // Edit Company
        function editCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) {
                console.log('Company not found with ID:', companyId);
                return;
            }

            // Store the company being edited
            window.editingCompany = company;
            window.editingCompanyId = companyId;

            // Open the edit company modal
            openEditCompanyModal(companyId);
        }

        // Add User to Company
        function addUserToCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) {
                console.log('Company not found with ID:', companyId);
                return;
            }

            // Store the company ID for adding user
            window.addingUserToCompanyId = companyId;
            
            // Open the add users modal
            openAddUsersModal(companyId);
        }

        // Add Branch to Company
        function addBranchToCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) {
                console.log('Company not found with ID:', companyId);
                return;
            }

            // Store the company ID for adding branch
            window.addingBranchToCompanyId = companyId;
            
            // Clear form fields
            document.getElementById('addBranchForm').reset();
            
            // Load contracts into dropdown
            loadContractsIntoDropdown('addBranchContract');
            
            // Update modal title
            document.getElementById('addBranchModalTitle').textContent = `Add Branch to ${company.title}`;
            
            // Open the add branch modal
            document.getElementById('addBranchModal').classList.add('active');
            document.querySelector('.modal-overlay').classList.add('active');
        }

        // Get contract reference from contract object
        function getContractReferenceForDisplay(contract) {
            if (contract.reference) {
                return contract.reference;
            }
            if (contract.number && contract.title) {
                return `${contract.number}-${contract.title}`;
            }
            if (contract.number) {
                return contract.number;
            }
            if (contract.title) {
                return contract.title;
            }
            return 'N/A';
        }

        // Load contracts into dropdown
        function loadContractsIntoDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            // Clear existing options except the first one
            dropdown.innerHTML = '<option value="">Select Contract</option>';

            // Load contracts from localStorage
            try {
                const storedContracts = localStorage.getItem('wefixContracts');
                if (storedContracts) {
                    const contracts = JSON.parse(storedContracts);
                    contracts.forEach(contract => {
                        const option = document.createElement('option');
                        option.value = contract.id;
                        // Display contract reference
                        const contractReference = getContractReferenceForDisplay(contract);
                        option.textContent = contractReference;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading contracts:', error);
            }
        }

        // Placeholder function for onchange (can be used for future enhancements)
        function loadBranchContracts() {
            // This function can be used to load branch-specific contracts if needed
        }

        // Add Zone to Company
        function addZoneToCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) {
                console.log('Company not found with ID:', companyId);
                return;
            }

            // Store the company ID for adding zone
            window.addingZoneToCompanyId = companyId;
            
            // Open the add zones modal
            openAddZonesModal(companyId);
        }

        // Manage Maintenance Services
        let currentManageCompanyId = null;
        let manageMaintenanceServicesList = [];
        let manageMaintenanceServiceCounter = 0;

        function manageMaintenanceServices(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            currentManageCompanyId = companyId;
            manageMaintenanceServiceCounter = 0;
            
            // Load existing maintenance services
            manageMaintenanceServicesList = company.maintenanceServices ? [...company.maintenanceServices] : [];
            
            // Update counter to be higher than existing IDs
            if (manageMaintenanceServicesList.length > 0) {
                manageMaintenanceServiceCounter = Math.max(...manageMaintenanceServicesList.map(s => s.id || 0));
            }
            
            document.getElementById('manageMaintenanceServicesModalTitle').textContent = `Manage Maintenance Services - ${company.title}`;
            
            // Clear form
            document.getElementById('manageMainService').value = '';
            document.getElementById('manageMainServiceValue').value = '';
            document.getElementById('manageMainServiceEn').value = '';
            document.getElementById('manageMainServiceAr').value = '';
            document.getElementById('manageSubService').value = '';
            document.getElementById('manageSubService').disabled = true;
            document.getElementById('manageSubServiceValue').value = '';
            document.getElementById('manageSubServiceEn').value = '';
            document.getElementById('manageSubServiceAr').value = '';
            initializeManageMainServiceDropdown();
            const manageMainDropdown = document.getElementById('manageMainServiceDropdown');
            const manageSubDropdown = document.getElementById('manageSubServiceDropdown');
            if (manageMainDropdown) manageMainDropdown.style.display = 'none';
            if (manageSubDropdown) manageSubDropdown.style.display = 'none';
            
            // Update table
            updateManageMaintenanceServicesTable();
            
            // Open modal
            document.getElementById('manageMaintenanceServicesModal').classList.add('active');
        }

        function closeManageMaintenanceServicesModal() {
            document.getElementById('manageMaintenanceServicesModal').classList.remove('active');
            currentManageCompanyId = null;
            manageMaintenanceServicesList = [];
            manageMaintenanceServiceCounter = 0;
            if (document.getElementById('manageMainService')) {
                document.getElementById('manageMainService').value = '';
                document.getElementById('manageMainServiceValue').value = '';
                document.getElementById('manageMainServiceEn').value = '';
                document.getElementById('manageMainServiceAr').value = '';
            }
            if (document.getElementById('manageSubService')) {
                document.getElementById('manageSubService').value = '';
                document.getElementById('manageSubService').disabled = true;
                document.getElementById('manageSubServiceValue').value = '';
                document.getElementById('manageSubServiceEn').value = '';
                document.getElementById('manageSubServiceAr').value = '';
            }
        }

        // Initialize Manage Main Service Dropdown
        function initializeManageMainServiceDropdown() {
            const dropdown = document.getElementById('manageMainServiceDropdown');
            if (!dropdown) return;

            dropdown.innerHTML = '';
            Object.keys(maintenanceServicesData).forEach(key => {
                const service = maintenanceServicesData[key];
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-value', key);
                item.setAttribute('data-en', service.en);
                item.setAttribute('data-ar', service.ar);
                item.innerHTML = `${service.en} / ${service.ar}`;
                item.onclick = () => selectManageMainService(key, service.en, service.ar);
                dropdown.appendChild(item);
            });
        }

        function showManageMainServiceDropdown() {
            const dropdown = document.getElementById('manageMainServiceDropdown');
            if (dropdown) {
                dropdown.style.display = 'block';
                initializeManageMainServiceDropdown();
            }
        }

        function filterManageMainServiceOptions() {
            const input = document.getElementById('manageMainService');
            const filter = input.value.toLowerCase();
            const items = document.querySelectorAll('#manageMainServiceDropdown .dropdown-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function selectManageMainService(value, en, ar) {
            document.getElementById('manageMainService').value = `${en} / ${ar}`;
            document.getElementById('manageMainServiceValue').value = value;
            document.getElementById('manageMainServiceEn').value = en;
            document.getElementById('manageMainServiceAr').value = ar;
            document.getElementById('manageMainServiceDropdown').style.display = 'none';
            
            // Enable and populate Sub Service dropdown
            const subServiceInput = document.getElementById('manageSubService');
            subServiceInput.disabled = false;
            subServiceInput.value = '';
            document.getElementById('manageSubServiceValue').value = '';
            document.getElementById('manageSubServiceEn').value = '';
            document.getElementById('manageSubServiceAr').value = '';
            
            populateManageSubServices(value);
        }

        function populateManageSubServices(mainServiceKey) {
            const dropdown = document.getElementById('manageSubServiceDropdown');
            if (!dropdown) return;

            dropdown.innerHTML = '';
            const subServices = maintenanceServicesData[mainServiceKey].subServices;
            
            Object.keys(subServices).forEach(key => {
                const subService = subServices[key];
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-value', key);
                item.setAttribute('data-en', subService.en);
                item.setAttribute('data-ar', subService.ar);
                item.innerHTML = `${subService.en} / ${subService.ar}`;
                item.onclick = () => selectManageSubService(key, subService.en, subService.ar);
                dropdown.appendChild(item);
            });
        }

        function showManageSubServiceDropdown() {
            const mainServiceValue = document.getElementById('manageMainServiceValue').value;
            if (!mainServiceValue) {
                alert('Please select Main Service first');
                return;
            }
            const dropdown = document.getElementById('manageSubServiceDropdown');
            if (dropdown) {
                dropdown.style.display = 'block';
            }
        }

        function filterManageSubServiceOptions() {
            const input = document.getElementById('manageSubService');
            const filter = input.value.toLowerCase();
            const items = document.querySelectorAll('#manageSubServiceDropdown .dropdown-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function selectManageSubService(value, en, ar) {
            document.getElementById('manageSubService').value = `${en} / ${ar}`;
            document.getElementById('manageSubServiceValue').value = value;
            document.getElementById('manageSubServiceEn').value = en;
            document.getElementById('manageSubServiceAr').value = ar;
            document.getElementById('manageSubServiceDropdown').style.display = 'none';
        }

        function addManageMaintenanceService() {
            const mainServiceValue = document.getElementById('manageMainServiceValue').value;
            const mainServiceEn = document.getElementById('manageMainServiceEn').value;
            const mainServiceAr = document.getElementById('manageMainServiceAr').value;
            const subServiceValue = document.getElementById('manageSubServiceValue').value;
            const subServiceEn = document.getElementById('manageSubServiceEn').value;
            const subServiceAr = document.getElementById('manageSubServiceAr').value;

            if (!mainServiceValue || !subServiceValue) {
                alert('Please select both Main Service and Sub Service');
                return;
            }

            manageMaintenanceServiceCounter++;
            const service = {
                id: manageMaintenanceServiceCounter,
                mainServiceValue: mainServiceValue,
                mainServiceEn: mainServiceEn,
                mainServiceAr: mainServiceAr,
                subServiceValue: subServiceValue,
                subServiceEn: subServiceEn,
                subServiceAr: subServiceAr
            };

            manageMaintenanceServicesList.push(service);
            updateManageMaintenanceServicesTable();
            
            // Clear inputs
            document.getElementById('manageMainService').value = '';
            document.getElementById('manageMainServiceValue').value = '';
            document.getElementById('manageMainServiceEn').value = '';
            document.getElementById('manageMainServiceAr').value = '';
            document.getElementById('manageSubService').value = '';
            document.getElementById('manageSubService').disabled = true;
            document.getElementById('manageSubServiceValue').value = '';
            document.getElementById('manageSubServiceEn').value = '';
            document.getElementById('manageSubServiceAr').value = '';
        }

        function updateManageMaintenanceServicesTable() {
            const tbody = document.getElementById('manageMaintenanceServicesTableBody');
            if (!tbody) return;

            if (manageMaintenanceServicesList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7280; font-style: italic;">No maintenance services added yet</td></tr>';
                return;
            }

            tbody.innerHTML = manageMaintenanceServicesList.map(service => `
                <tr>
                    <td>${service.id}</td>
                    <td>${service.mainServiceEn} / ${service.mainServiceAr}</td>
                    <td>${service.subServiceEn} / ${service.subServiceAr}</td>
                    <td style="text-align: center;">
                        <button class="btn-delete" onclick="deleteManageMaintenanceService(${service.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteManageMaintenanceService(id) {
            manageMaintenanceServicesList = manageMaintenanceServicesList.filter(service => service.id !== id);
            updateManageMaintenanceServicesTable();
        }

        function saveManageMaintenanceServices() {
            if (!currentManageCompanyId) return;

            const company = companies.find(c => c.id === currentManageCompanyId);
            if (!company) return;

            // Update company's maintenance services
            company.maintenanceServices = manageMaintenanceServicesList.map(service => ({
                id: service.id,
                mainServiceValue: service.mainServiceValue,
                mainServiceEn: service.mainServiceEn,
                mainServiceAr: service.mainServiceAr,
                subServiceValue: service.subServiceValue,
                subServiceEn: service.subServiceEn,
                subServiceAr: service.subServiceAr
            }));

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Refresh display
            displayCompanies();
            
            // Close modal
            closeManageMaintenanceServicesModal();
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Services Updated!',
                text: 'Maintenance services have been updated successfully',
                confirmButtonColor: '#E67E00',
                timer: 3000,
                timerProgressBar: true
            });
        }

        // Close manage dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.searchable-dropdown')) {
                const manageMainDropdown = document.getElementById('manageMainServiceDropdown');
                const manageSubDropdown = document.getElementById('manageSubServiceDropdown');
                if (manageMainDropdown) manageMainDropdown.style.display = 'none';
                if (manageSubDropdown) manageSubDropdown.style.display = 'none';
            }
        });

        // Add Contract to Company
        function addContractToCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) {
                console.log('Company not found with ID:', companyId);
                return;
            }

            // Store the company ID for adding contract
            window.addingContractToCompanyId = companyId;
            
            // Open the add contract modal
            openAddContractModal(companyId);
        }

        // Add Branch Modal Functions
        function closeAddBranchModal() {
            document.getElementById('addBranchModal').classList.remove('active');
            document.querySelector('.modal-overlay').classList.remove('active');
        }

        function updateAddBranchSubCategories() {
            const mainCategory = document.getElementById('addMainCategory').value;
            const subCategorySelect = document.getElementById('addSubCategory');
            
            // Clear existing options
            subCategorySelect.innerHTML = '<option value="">Select Sub Service</option>';
            
            // Add sub categories based on main category
            if (mainCategory === ' ') {
                subCategorySelect.innerHTML += `
                    <option value="      ">      </option>
                    <option value="    ">    </option>
                    <option value="  ">  </option>
                    <option value="  ">  </option>
                    <option value="   ">   </option>
                    <option value="     ">     </option>
                    <option value="  ">  </option>
                `;
            } else if (mainCategory === '  ') {
                subCategorySelect.innerHTML += `
                    <option value="       ">       </option>
                    <option value="   ">   </option>
                    <option value="   ">   </option>
                    <option value="       ">       </option>
                    <option value="   ">   </option>
                `;
            } else if (mainCategory === ' ') {
                subCategorySelect.innerHTML += `
                    <option value="   ">   </option>
                    <option value="   ">   </option>
                    <option value="  ">  </option>
                    <option value="  ">  </option>
                    <option value="  ">  </option>
                `;
            } else if (mainCategory === '  ') {
                subCategorySelect.innerHTML += `
                    <option value="    ()">    ()</option>
                    <option value="   ">   </option>
                    <option value="   ">   </option>
                    <option value="  ">  </option>
                    <option value="  ">  </option>
                `;
            } else if (mainCategory === '') {
                subCategorySelect.innerHTML += `
                    <option value=" "> </option>
                    <option value="     ">     </option>
                `;
            } else if (mainCategory === '   ') {
                subCategorySelect.innerHTML += `
                    <option value="   ">   </option>
                `;
            }
        }



        let addBranchTeamLeaderCounter = 0;

        function addBranchTeamLeader() {
            addBranchTeamLeaderCounter++;
            const teamLeadersList = document.getElementById('addBranchTeamLeadersList');
            
            const teamLeaderHTML = `
                <div class="dynamic-section" id="addBranchTeamLeader${addBranchTeamLeaderCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">Team Leader ${addBranchTeamLeaderCounter}</span>
                        <button type="button" class="btn-remove" onclick="removeAddBranchTeamLeader(${addBranchTeamLeaderCounter})">Remove</button>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Team Leader Name (Arabic)</label>
                            <input type="text" class="form-input" id="addBranchTLNameAr${addBranchTeamLeaderCounter}" placeholder="  ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Team Leader Name (English)</label>
                            <input type="text" class="form-input" id="addBranchTLNameEn${addBranchTeamLeaderCounter}" placeholder="Team Leader Name">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Mobile Number</label>
                            <input type="tel" class="form-input" id="addBranchTLMobile${addBranchTeamLeaderCounter}" placeholder="+962 7XX XXX XXX">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="addBranchTLEmail${addBranchTeamLeaderCounter}" placeholder="tl@example.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categories</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="addBranchTLCat${addBranchTeamLeaderCounter}_electrical" value="Electrical">
                                <label for="addBranchTLCat${addBranchTeamLeaderCounter}_electrical">Electrical</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="addBranchTLCat${addBranchTeamLeaderCounter}_plumbing" value="Plumbing">
                                <label for="addBranchTLCat${addBranchTeamLeaderCounter}_plumbing">Plumbing</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="addBranchTLCat${addBranchTeamLeaderCounter}_hvac" value="HVAC">
                                <label for="addBranchTLCat${addBranchTeamLeaderCounter}_hvac">HVAC</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="addBranchTLCat${addBranchTeamLeaderCounter}_painting" value="Painting">
                                <label for="addBranchTLCat${addBranchTeamLeaderCounter}_painting">Painting</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="addBranchTLCat${addBranchTeamLeaderCounter}_carpentry" value="Carpentry">
                                <label for="addBranchTLCat${addBranchTeamLeaderCounter}_carpentry">Carpentry</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="addBranchTLCat${addBranchTeamLeaderCounter}_general" value="General Maintenance">
                                <label for="addBranchTLCat${addBranchTeamLeaderCounter}_general">General Maintenance</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input form-textarea" id="addBranchTLDescription${addBranchTeamLeaderCounter}" placeholder="Team Leader Description" rows="2"></textarea>
                    </div>
                </div>
            `;
            
            teamLeadersList.insertAdjacentHTML('beforeend', teamLeaderHTML);
            
            // Add event listeners to update dropdown when names are entered
            const nameEnInput = document.getElementById('addBranchTLNameEn' + addBranchTeamLeaderCounter);
            const nameArInput = document.getElementById('addBranchTLNameAr' + addBranchTeamLeaderCounter);
            
            if (nameEnInput) {
                nameEnInput.addEventListener('input', updateAddBranchTeamLeaderDropdown);
            }
            if (nameArInput) {
                nameArInput.addEventListener('input', updateAddBranchTeamLeaderDropdown);
            }
            
            // Update dropdown after adding
            updateAddBranchTeamLeaderDropdown();
        }

        function removeAddBranchTeamLeader(teamLeaderId) {
            const teamLeaderElement = document.getElementById(`addBranchTeamLeader${teamLeaderId}`);
            if (teamLeaderElement) {
                teamLeaderElement.remove();
                // Update dropdown after removing
                updateAddBranchTeamLeaderDropdown();
            }
        }

        function saveNewBranch() {
            if (!window.addingBranchToCompanyId) return;

            const company = companies.find(c => c.id === window.addingBranchToCompanyId);
            if (!company) return;

            // Get form values
            const branchContract = document.getElementById('addBranchContract').value;
            const branchTitle = document.getElementById('addBranchTitle').value.trim();
            const branchNameAr = document.getElementById('addBranchNameAr').value.trim();
            const branchNameEn = document.getElementById('addBranchNameEn').value.trim();
            const mainCategory = document.getElementById('addMainCategory').value;
            const subCategory = document.getElementById('addSubCategory').value;
            const branchRepName = document.getElementById('addBranchRepName').value.trim();
            const branchRepMobile = document.getElementById('addBranchRepMobile').value.trim();
            const branchRepEmail = document.getElementById('addBranchRepEmail').value.trim();
            const managedBy = document.getElementById('addManagedBy').value;
            const branchTeamLeader = document.getElementById('addBranchTeamLeader')?.value || '';
            const branchStartDate = document.getElementById('addBranchStartDate').value;
            const branchEndDate = document.getElementById('addBranchEndDate').value;

            // Validate required fields
            if (!branchTitle) {
                showValidationError('addBranchTitle', 'Please enter Branch Title');
                return;
            }
            if (!branchNameAr) {
                showValidationError('addBranchNameAr', 'Please enter Branch Name (Arabic)');
                return;
            }
            if (!branchNameEn) {
                showValidationError('addBranchNameEn', 'Please enter Branch Name (English)');
                return;
            }
            if (!mainCategory) {
                showValidationError('addMainCategory', 'Please select Main Service');
                return;
            }
            if (!subCategory) {
                showValidationError('addSubCategory', 'Please select Sub Service');
                return;
            }
            if (!branchRepName) {
                showValidationError('addBranchRepName', 'Please enter Branch Representative Name');
                return;
            }
            if (!branchRepMobile) {
                showValidationError('addBranchRepMobile', 'Please enter Branch Representative Mobile');
                return;
            }
            if (!branchStartDate) {
                showValidationError('addBranchStartDate', 'Please select Start Date');
                return;
            }
            if (!branchEndDate) {
                showValidationError('addBranchEndDate', 'Please select End Date');
                return;
            }
            if (!managedBy) {
                showValidationError('addManagedBy', 'Please select Managed By');
                return;
            }

            // Team leaders section removed - set to empty array
            const teamLeaders = [];

            // Create new branch
            const newBranch = {
                id: `branch_${Date.now()}`,
                contractId: branchContract,
                title: branchTitle,
                nameAr: branchNameAr,
                nameEn: branchNameEn,
                mainCategory: mainCategory,
                subCategory: subCategory,
                repName: branchRepName,
                repMobile: branchRepMobile,
                repEmail: branchRepEmail,
                startDate: branchStartDate,
                endDate: branchEndDate,
                managedBy: managedBy,
                branchTeamLeader: branchTeamLeader,
                teamLeaders: teamLeaders
            };

            // Add branch to company
            if (!company.branches) {
                company.branches = [];
            }
            company.branches.push(newBranch);

            // Update company in the array
            const companyIndex = companies.findIndex(c => c.id === window.addingBranchToCompanyId);
            if (companyIndex !== -1) {
                companies[companyIndex] = company;
            }

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Refresh display
            displayCompanies();

            // Close modal
            closeAddBranchModal();

            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Branch Added!',
                text: 'Branch has been added successfully',
                confirmButtonColor: '#E67E00',
                timer: 3000,
                timerProgressBar: true
            });
        }

        // Edit Team Leader Modal Functions
        let currentEditingTeamLeader = null;
        let currentEditingTeamLeaderCompanyId = null;

        function editTeamLeader(teamLeaderId) {
            console.log('Edit Team Leader clicked:', teamLeaderId);
            console.log('Available companies:', companies.length);
            
            // Find the team leader in all companies
            let foundTeamLeader = null;
            let foundCompany = null;
            
            for (const company of companies) {
                console.log('Checking company:', company.id, 'teamLeaders:', company.teamLeaders?.length);
                
                if (company.teamLeaders) {
                    const teamLeader = company.teamLeaders.find(tl => tl.id === teamLeaderId);
                    if (teamLeader) {
                        console.log('Found team leader in company teamLeaders:', teamLeader);
                        foundTeamLeader = teamLeader;
                        foundCompany = company;
                        break;
                    }
                }
                // Check if company has branches array (not just a number)
                if (company.branches && Array.isArray(company.branches)) {
                    for (const branch of company.branches) {
                        if (branch.teamLeaders) {
                            const teamLeader = branch.teamLeaders.find(tl => tl.id === teamLeaderId);
                            if (teamLeader) {
                                console.log('Found team leader in branch teamLeaders:', teamLeader);
                                foundTeamLeader = teamLeader;
                                foundCompany = company;
                                break;
                            }
                        }
                    }
                }
            }

            if (!foundTeamLeader || !foundCompany) {
                console.log('Team leader not found!');
                return;
            }

            currentEditingTeamLeader = foundTeamLeader;
            currentEditingTeamLeaderCompanyId = foundCompany.id;

            // Populate form with team leader data
            document.getElementById('editTLNameAr').value = foundTeamLeader.nameAr || '';
            document.getElementById('editTLNameEn').value = foundTeamLeader.nameEn || foundTeamLeader.name || '';
            document.getElementById('editTLMobile').value = foundTeamLeader.mobile || '';
            document.getElementById('editTLEmail').value = foundTeamLeader.email || '';
            document.getElementById('editTLDescription').value = foundTeamLeader.description || '';
            // Set toggle status
            const toggle = document.getElementById('editTLStatusToggle');
            const statusLabel = document.getElementById('editTLStatusLabel');
            toggle.checked = foundTeamLeader.isActive;
            statusLabel.textContent = foundTeamLeader.isActive ? 'Active' : 'Inactive';
            
            // Add event listener for toggle
            toggle.addEventListener('change', function() {
                statusLabel.textContent = this.checked ? 'Active' : 'Inactive';
            });

            // Clear and set categories checkboxes
            const checkboxes = document.querySelectorAll('#editTeamLeaderForm input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            if (foundTeamLeader.categories && foundTeamLeader.categories.length > 0) {
                foundTeamLeader.categories.forEach(category => {
                    const checkbox = document.getElementById(`editTLCat_${category.toLowerCase().replace(' ', '_')}`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
            }

            document.getElementById('editTeamLeaderModalTitle').textContent = `Edit ${foundTeamLeader.nameEn || foundTeamLeader.name || 'Team Leader'}`;

            document.getElementById('editTeamLeaderModal').classList.add('active');
            document.querySelector('.modal-overlay').classList.add('active');
        }

        function closeEditTeamLeaderModal() {
            document.getElementById('editTeamLeaderModal').classList.remove('active');
            document.querySelector('.modal-overlay').classList.remove('active');
            currentEditingTeamLeader = null;
            currentEditingTeamLeaderCompanyId = null;
        }

        function saveEditedTeamLeader() {
            if (!currentEditingTeamLeader || !currentEditingTeamLeaderCompanyId) return;

            // Get form values
            const nameAr = document.getElementById('editTLNameAr').value.trim();
            const nameEn = document.getElementById('editTLNameEn').value.trim();
            const mobile = document.getElementById('editTLMobile').value.trim();
            const email = document.getElementById('editTLEmail').value.trim();
            const description = document.getElementById('editTLDescription').value.trim();
            const isActive = document.getElementById('editTLStatusToggle').checked;

            // Collect categories checkboxes
            const categories = [];
            const checkboxes = document.querySelectorAll('#editTeamLeaderForm input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    categories.push(checkbox.value);
                }
            });

            // Update team leader data
            currentEditingTeamLeader.nameAr = nameAr || currentEditingTeamLeader.nameAr;
            currentEditingTeamLeader.nameEn = nameEn || currentEditingTeamLeader.nameEn;
            currentEditingTeamLeader.name = nameEn || currentEditingTeamLeader.name;
            currentEditingTeamLeader.mobile = mobile || currentEditingTeamLeader.mobile;
            currentEditingTeamLeader.email = email || currentEditingTeamLeader.email;
            currentEditingTeamLeader.description = description;
            currentEditingTeamLeader.categories = categories;
            currentEditingTeamLeader.isActive = isActive;

            // Update company in the array
            const companyIndex = companies.findIndex(c => c.id === currentEditingTeamLeaderCompanyId);
            if (companyIndex !== -1) {
                companies[companyIndex] = companies[companyIndex];
            }

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Refresh display
            displayCompanies();

            // Close modal
            closeEditTeamLeaderModal();

            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Team Leader Updated!',
                text: 'Team leader has been updated successfully',
                confirmButtonColor: '#E67E00',
                timer: 3000,
                timerProgressBar: true
            });
        }

        // Wizard Form Functions - Multi-Select for Main Service and Sub Service
        
        // Toggle Main Service dropdown
        function toggleWizardMainService() {
            const dropdown = document.getElementById('wizardMainServiceDropdown');
            const options = document.getElementById('wizardMainServiceOptions');
            
            // Close Sub Service dropdown if open
            document.getElementById('wizardSubServiceDropdown').classList.remove('active');
            document.getElementById('wizardSubServiceOptions').classList.remove('show');
            
            // Close other open dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                if (dd.id !== 'wizardMainServiceDropdown') {
                    dd.classList.remove('active');
                }
            });
            document.querySelectorAll('.multi-select-options').forEach(opt => {
                if (opt.id !== 'wizardMainServiceOptions') {
                    opt.classList.remove('show');
                }
            });
            
            dropdown.classList.toggle('active');
            options.classList.toggle('show');
        }
        
        // Toggle Sub Service dropdown
        function toggleWizardSubService() {
            const dropdown = document.getElementById('wizardSubServiceDropdown');
            const options = document.getElementById('wizardSubServiceOptions');
            
            // Close Main Service dropdown if open
            document.getElementById('wizardMainServiceDropdown').classList.remove('active');
            document.getElementById('wizardMainServiceOptions').classList.remove('show');
            
            // Close other open dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                if (dd.id !== 'wizardSubServiceDropdown') {
                    dd.classList.remove('active');
                }
            });
            document.querySelectorAll('.multi-select-options').forEach(opt => {
                if (opt.id !== 'wizardSubServiceOptions') {
                    opt.classList.remove('show');
                }
            });
            
            dropdown.classList.toggle('active');
            options.classList.toggle('show');
        }
        
        // Update Main Service text display
        function updateWizardMainServiceText() {
            const checkboxes = document.querySelectorAll('#wizardMainServiceOptions input[type="checkbox"]:not(#wizardMainService_all)');
            const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            const textElement = document.getElementById('wizardMainServiceText');
            
            if (selected.length === 0) {
                textElement.textContent = 'Select Main Service';
            } else if (selected.length === 1) {
                textElement.textContent = selected[0];
            } else {
                textElement.textContent = `${selected.length} selected`;
            }
        }
        
        // Toggle All Main Services
        function toggleAllMainServices() {
            const allCheckbox = document.getElementById('wizardMainService_all');
            const otherCheckboxes = document.querySelectorAll('#wizardMainServiceOptions input[type="checkbox"]:not(#wizardMainService_all)');
            
            otherCheckboxes.forEach(cb => {
                cb.checked = allCheckbox.checked;
            });
            
            updateWizardMainServiceText();
            updateWizardSubServices();
        }
        
        // Update Sub Services based on selected Main Services
        function updateWizardSubServices() {
            const mainServiceCheckboxes = document.querySelectorAll('#wizardMainServiceOptions input[type="checkbox"]:not(#wizardMainService_all)');
            const selectedMainServices = Array.from(mainServiceCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            const subServiceOptions = document.getElementById('wizardSubServiceOptions');
            
            // Keep only the "All" option
            const allOption = subServiceOptions.querySelector('#wizardSubService_all').parentElement;
            subServiceOptions.innerHTML = '';
            subServiceOptions.appendChild(allOption);
            
            if (selectedMainServices.length === 0) {
                return;
            }
            
            // Sub-services mapping
            const subServicesMap = {
                ' ': [
                    '      ',
                    '    ',
                    '  ',
                    '  ',
                    '   ',
                    '     ',
                    '  '
                ],
                '  ': [
                    '       ',
                    '   ',
                    '   ',
                    '       ',
                    '   '
                ],
                ' ': [
                    '   ',
                    '   ',
                    '  ',
                    '  ',
                    '  '
                ],
                '  ': [
                    '    ()',
                    '   ',
                    '   ',
                    '  ',
                    '  '
                ],
                '': [
                    ' ',
                    '     '
                ],
                '   ': [
                    '   '
                ]
            };
            
            // Collect all unique sub-services from selected main services
            const allSubServices = new Set();
            selectedMainServices.forEach(mainService => {
                if (subServicesMap[mainService]) {
                    subServicesMap[mainService].forEach(sub => allSubServices.add(sub));
                }
            });
            
            // Add sub-service options
            Array.from(allSubServices).sort().forEach((subService, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.innerHTML = `
                    <input type="checkbox" id="wizardSubService_${index}" value="${subService}" onchange="updateWizardSubServiceText();">
                    <label for="wizardSubService_${index}">${subService}</label>
                `;
                subServiceOptions.appendChild(optionDiv);
            });
        }
        
        // Update Sub Service text display
        function updateWizardSubServiceText() {
            const checkboxes = document.querySelectorAll('#wizardSubServiceOptions input[type="checkbox"]:not(#wizardSubService_all)');
            const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            const textElement = document.getElementById('wizardSubServiceText');
            
            if (selected.length === 0) {
                textElement.textContent = 'Select Sub Service';
            } else if (selected.length === 1) {
                textElement.textContent = selected[0];
            } else {
                textElement.textContent = `${selected.length} selected`;
            }
        }
        
        // Toggle All Sub Services
        function toggleAllSubServices() {
            const allCheckbox = document.getElementById('wizardSubService_all');
            const otherCheckboxes = document.querySelectorAll('#wizardSubServiceOptions input[type="checkbox"]:not(#wizardSubService_all)');
            
            otherCheckboxes.forEach(cb => {
                cb.checked = allCheckbox.checked;
            });
            
            updateWizardSubServiceText();
        }

        function toggleWizardTeamLeadersSection() {
            const managedBy = document.querySelector('input[name="wizardManagedBy"]:checked')?.value || '';
            const teamLeadersSection = document.getElementById('wizardTeamLeadersSection');
            
            if (managedBy === 'WeFix Team') {
                teamLeadersSection.style.display = 'block';
                // Update dropdown when section is shown
                setTimeout(() => updateWizardBranchTeamLeaderDropdown(), 100);
            } else {
                teamLeadersSection.style.display = 'none';
                // Clear dropdown when section is hidden but keep sample names
                const dropdown = document.getElementById('wizardBranchTeamLeader');
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">Select Team Leader</option>' +
                        '<option value="Ahmad Al-Mousa">Ahmad Al-Mousa</option>' +
                        '<option value="Mohammed Al-Hashimi">Mohammed Al-Hashimi</option>' +
                        '<option value="Omar Al-Zahawi">Omar Al-Zahawi</option>' +
                        '<option value="Khalid Al-Rashid">Khalid Al-Rashid</option>' +
                        '<option value="Yousef Al-Mansouri">Yousef Al-Mansouri</option>';
                    dropdown.value = '';
                }
            }
        }

        let wizardTeamLeaderCounter = 0;

        // Update the branch team leader dropdown with team leaders from the wizard
        function updateWizardBranchTeamLeaderDropdown() {
            const dropdown = document.getElementById('wizardBranchTeamLeader');
            if (!dropdown) return;
            
            // Store the currently selected value
            const currentValue = dropdown.value;
            
            // Clear existing options except the first one and sample names
            dropdown.innerHTML = '<option value="">Select Team Leader</option>' +
                '<option value="Ahmad Al-Mousa">Ahmad Al-Mousa</option>' +
                '<option value="Mohammed Al-Hashimi">Mohammed Al-Hashimi</option>' +
                '<option value="Omar Al-Zahawi">Omar Al-Zahawi</option>' +
                '<option value="Khalid Al-Rashid">Khalid Al-Rashid</option>' +
                '<option value="Yousef Al-Mansouri">Yousef Al-Mansouri</option>';
            
            // Get all team leader elements from wizardTeamLeadersList
            for (let i = 1; i <= wizardTeamLeaderCounter; i++) {
                const teamLeaderElement = document.getElementById('wizardTeamLeader' + i);
                if (teamLeaderElement) {
                    const nameEn = document.getElementById('wizardTLNameEn' + i)?.value.trim();
                    const nameAr = document.getElementById('wizardTLNameAr' + i)?.value.trim();
                    
                    if (nameEn || nameAr) {
                        const option = document.createElement('option');
                        option.value = nameEn || nameAr;
                        option.textContent = nameEn || nameAr || `Team Leader ${i}`;
                        dropdown.appendChild(option);
                    }
                }
            }
            
            // Restore the previously selected value if it still exists
            if (currentValue) {
                dropdown.value = currentValue;
            }
        }

        function addWizardTeamLeader() {
            wizardTeamLeaderCounter++;
            const teamLeadersList = document.getElementById('wizardTeamLeadersList');
            
            const teamLeaderHTML = `
                <div class="dynamic-section" id="wizardTeamLeader${wizardTeamLeaderCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">Team Leader ${wizardTeamLeaderCounter}</span>
                        <button type="button" class="btn-remove" onclick="removeWizardTeamLeader(${wizardTeamLeaderCounter})">Remove</button>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Team Leader Name (Arabic)</label>
                            <input type="text" class="form-input" id="wizardTLNameAr${wizardTeamLeaderCounter}" placeholder="  ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Team Leader Name (English)</label>
                            <input type="text" class="form-input" id="wizardTLNameEn${wizardTeamLeaderCounter}" placeholder="Team Leader Name">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Mobile Number</label>
                            <input type="tel" class="form-input" id="wizardTLMobile${wizardTeamLeaderCounter}" placeholder="+962 7XX XXX XXX">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="wizardTLEmail${wizardTeamLeaderCounter}" placeholder="tl@example.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categories</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="wizardTLCat${wizardTeamLeaderCounter}_electrical" value="Electrical">
                                <label for="wizardTLCat${wizardTeamLeaderCounter}_electrical">Electrical</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="wizardTLCat${wizardTeamLeaderCounter}_plumbing" value="Plumbing">
                                <label for="wizardTLCat${wizardTeamLeaderCounter}_plumbing">Plumbing</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="wizardTLCat${wizardTeamLeaderCounter}_hvac" value="HVAC">
                                <label for="wizardTLCat${wizardTeamLeaderCounter}_hvac">HVAC</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="wizardTLCat${wizardTeamLeaderCounter}_painting" value="Painting">
                                <label for="wizardTLCat${wizardTeamLeaderCounter}_painting">Painting</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="wizardTLCat${wizardTeamLeaderCounter}_carpentry" value="Carpentry">
                                <label for="wizardTLCat${wizardTeamLeaderCounter}_carpentry">Carpentry</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="wizardTLCat${wizardTeamLeaderCounter}_general" value="General Maintenance">
                                <label for="wizardTLCat${wizardTeamLeaderCounter}_general">General Maintenance</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input form-textarea" id="wizardTLDescription${wizardTeamLeaderCounter}" placeholder="Team Leader Description" rows="2"></textarea>
                    </div>
                </div>
            `;
            
            teamLeadersList.insertAdjacentHTML('beforeend', teamLeaderHTML);
            
            // Add event listeners to update dropdown when names are entered
            const nameEnInput = document.getElementById('wizardTLNameEn' + wizardTeamLeaderCounter);
            const nameArInput = document.getElementById('wizardTLNameAr' + wizardTeamLeaderCounter);
            
            if (nameEnInput) {
                nameEnInput.addEventListener('input', updateWizardBranchTeamLeaderDropdown);
            }
            if (nameArInput) {
                nameArInput.addEventListener('input', updateWizardBranchTeamLeaderDropdown);
            }
            
            // Update dropdown after adding
            updateWizardBranchTeamLeaderDropdown();
        }

        function removeWizardTeamLeader(teamLeaderId) {
            const teamLeaderElement = document.getElementById(`wizardTeamLeader${teamLeaderId}`);
            if (teamLeaderElement) {
                teamLeaderElement.remove();
                // Update dropdown after removing
                updateWizardBranchTeamLeaderDropdown();
            }
        }

        // Add Users Modal Functions
        let addUsersCounter = 0;
        let currentAddUsersCompanyId = null;

        function openAddUsersModal(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            currentAddUsersCompanyId = companyId;
            addUsersCounter = 0;
            
            document.getElementById('addUsersModalTitle').textContent = `Add Users to ${company.title}`;
            document.getElementById('addUsersList').innerHTML = '';
            
            // Add first user by default
            addNewUser();
            
            document.getElementById('addUsersModal').classList.add('active');
            document.querySelector('.modal-overlay').classList.add('active');
        }

        function closeAddUsersModal() {
            document.getElementById('addUsersModal').classList.remove('active');
            document.querySelector('.modal-overlay').classList.remove('active');
            currentAddUsersCompanyId = null;
            addUsersCounter = 0;
        }

        function addNewUser() {
            addUsersCounter++;
            const usersList = document.getElementById('addUsersList');
            
            const userHTML = `
                <div class="dynamic-section" id="addUser${addUsersCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">User ${addUsersCounter}</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required"> User Role</label>
                        <select class="form-input" id="addUserType${addUsersCounter}">
                            <option value="">Select User Role</option>
                            <option value="Owner (Admin)">Owner (Admin)</option>
                            <option value="Team Leader">Team Leader</option>
                            <option value="Technician">Technician</option>
                        </select>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required"> Full Name Ar</label>
                            <input type="text" class="form-input" id="addUserNameAr${addUsersCounter}" placeholder=" ">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required"> Full Name En</label>
                            <input type="text" class="form-input" id="addUserNameEn${addUsersCounter}" placeholder="User Name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> User Image</label>
                        <div class="file-upload-container" onclick="document.getElementById('addUserImageUpload${addUsersCounter}').click()">
                            <div class="file-upload-icon"></div>
                            <div class="file-upload-text">Click to upload user image</div>
                            <div class="file-upload-text" id="addUserImageFileName${addUsersCounter}" style="display: none; color: #F78F1E;"></div>
                            <input type="file" id="addUserImageUpload${addUsersCounter}" class="file-upload-input" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required"> Country</label>
                            <select class="form-input" id="addUserCountry${addUsersCounter}">
                                <option value="Jordan">Jordan (+962)</option>
                                <option value="Saudi Arabia">Saudi Arabia (+966)</option>
                                <option value="UAE">UAE (+971)</option>
                                <option value="Egypt">Egypt (+20)</option>
                                <option value="Kuwait">Kuwait (+965)</option>
                                <option value="Qatar">Qatar (+974)</option>
                                <option value="Bahrain">Bahrain (+973)</option>
                                <option value="Oman">Oman (+968)</option>
                                <option value="Lebanon">Lebanon (+961)</option>
                                <option value="Iraq">Iraq (+964)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required"> Mobile Number</label>
                            <input type="tel" class="form-input" id="addUserMobile${addUsersCounter}" placeholder="7XX XXX XXX">
                            <small style="color: #6b7280; font-size: 12px;">Mobile number only (without country code)</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Email Address</label>
                        <input type="email" class="form-input" id="addUserEmail${addUsersCounter}" placeholder="user@example.com">
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required"> Start Date</label>
                            <input type="date" class="form-input" id="addUserStartDate${addUsersCounter}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required"> End Date</label>
                            <input type="date" class="form-input" id="addUserEndDate${addUsersCounter}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> Description</label>
                        <textarea class="form-input form-textarea" id="addUserDescription${addUsersCounter}" placeholder="Enter user description" rows="3"></textarea>
                    </div>
                </div>
            `;
            
            usersList.insertAdjacentHTML('beforeend', userHTML);
        }


        function saveUsersToCompany() {
            if (!currentAddUsersCompanyId) return;

            const company = companies.find(c => c.id === currentAddUsersCompanyId);
            if (!company) return;

            const usersToAdd = [];
            
            // Collect all user data
            for (let i = 1; i <= addUsersCounter; i++) {
                const userElement = document.getElementById(`addUser${i}`);
                if (!userElement) continue;

                const userType = document.getElementById(`addUserType${i}`)?.value;
                const nameAr = document.getElementById(`addUserNameAr${i}`)?.value;
                const nameEn = document.getElementById(`addUserNameEn${i}`)?.value;
                const mobile = document.getElementById(`addUserMobile${i}`)?.value;
                const email = document.getElementById(`addUserEmail${i}`)?.value;
                const startDate = document.getElementById(`addUserStartDate${i}`)?.value;
                const endDate = document.getElementById(`addUserEndDate${i}`)?.value;
                const description = document.getElementById(`addUserDescription${i}`)?.value;

                // Validate required fields
                if (userType && nameAr && nameEn && mobile && startDate && endDate) {
                    const newUser = {
                        id: `user_${Date.now()}_${i}`,
                        type: userType,
                        nameAr: nameAr,
                        nameEn: nameEn,
                        mobile: mobile,
                        email: email || '',
                        startDate: startDate,
                        endDate: endDate,
                        description: description || '',
                        image: '', // Handle image upload if needed
                        isActive: true
                    };
                    usersToAdd.push(newUser);
                }
            }

            if (usersToAdd.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Users Added',
                    text: 'Please add at least one user with required fields filled.',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            // Add users to company
            if (!company.users) {
                company.users = [];
            }
            company.users.push(...usersToAdd);

            // Update company in the array
            const companyIndex = companies.findIndex(c => c.id === currentAddUsersCompanyId);
            if (companyIndex !== -1) {
                companies[companyIndex] = company;
            }

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Refresh display
            displayCompanies();

            // Close modal
            closeAddUsersModal();

            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Users Added!',
                text: `${usersToAdd.length} user(s) added to ${company.title}`,
                confirmButtonColor: '#E67E00',
                timer: 3000,
                timerProgressBar: true
            });
        }

        // Edit Company Modal Functions
        function openEditCompanyModal(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            // Populate form with existing company data
            document.getElementById('editCompanyTitle').value = company.title || '';
            document.getElementById('editCompanyNameAr').value = company.nameAr || '';
            document.getElementById('editCompanyNameEn').value = company.nameEn || '';
            document.getElementById('editCompanyCountry').value = company.country || 'Jordan';
            document.getElementById('editCompanyType').value = company.establishedType || '';
            document.getElementById('editHoAddress').value = company.hoAddress || '';
            document.getElementById('editCompanyStatus').value = company.isActive ? 'true' : 'false';

            // Update modal title
            document.getElementById('editCompanyModalTitle').textContent = `Edit ${company.title}`;

            // Open modal
            document.getElementById('editCompanyModal').classList.add('active');
            document.querySelector('.modal-overlay').classList.add('active');
        }

        // Branch Edit Handlers
        function editBranch(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            // Prefill values from company (single-branch data model for mockup)
            document.getElementById('editBranchTitle').value = company.branchTitle || '';
            document.getElementById('editBranchNameAr').value = company.branchNameAr || '';
            document.getElementById('editBranchNameEn').value = company.branchNameEn || '';
            document.getElementById('editMainCategory').value = company.mainCategory || '';
            updateEditBranchSubCategories(company.subCategory || '');
            document.getElementById('editBranchRepName').value = company.branchRepName || '';
            document.getElementById('editBranchRepMobile').value = company.branchRepMobile || '';
            document.getElementById('editBranchRepEmail').value = company.branchRepEmail || '';
            document.getElementById('editManagedBy').value = company.managedBy || '';

            document.getElementById('editBranchModalTitle').textContent = `Edit Branch - ${company.title}`;

            document.getElementById('editBranchModal').classList.add('active');
            document.querySelector('.modal-overlay').classList.add('active');
            window.editingBranchCompanyId = companyId;
        }

        function closeEditBranchModal() {
            document.getElementById('editBranchModal').classList.remove('active');
            document.querySelector('.modal-overlay').classList.remove('active');
            window.editingBranchCompanyId = null;
        }

        function updateEditBranchSubCategories(preselect = '') {
            const main = document.getElementById('editMainCategory').value;
            const subSelect = document.getElementById('editSubCategory');
            const optionsMap = {
                ' ': [
                    '      ',
                    '    ',
                    '  ',
                    '  ',
                    '   ',
                    '     ',
                    '  '
                ],
                '  ': [
                    '       ',
                    '   ',
                    '   ',
                    '       ',
                    '   '
                ],
                ' ': [
                    '   ',
                    '   ',
                    '  ',
                    '  ',
                    '  '
                ],
                '  ': [
                    '    ()',
                    '   ',
                    '   ',
                    '  ',
                    '  '
                ],
                '': [
                    ' ',
                    '     '
                ],
                '   ': [
                    '   '
                ]
            };
            subSelect.innerHTML = '<option value="">Select Sub Service</option>';
            if (optionsMap[main]) {
                optionsMap[main].forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o;
                    opt.textContent = o;
                    subSelect.appendChild(opt);
                });
            }
            if (preselect) subSelect.value = preselect;
        }

        function saveEditedBranch() {
            if (!window.editingBranchCompanyId) return;
            const company = companies.find(c => c.id === window.editingBranchCompanyId);
            if (!company) return;

            // Read values
            company.branchTitle = document.getElementById('editBranchTitle').value.trim();
            company.branchNameAr = document.getElementById('editBranchNameAr').value.trim();
            company.branchNameEn = document.getElementById('editBranchNameEn').value.trim();
            company.mainCategory = document.getElementById('editMainCategory').value;
            company.subCategory = document.getElementById('editSubCategory').value;
            company.branchRepName = document.getElementById('editBranchRepName').value.trim();
            company.branchRepMobile = document.getElementById('editBranchRepMobile').value.trim();
            company.branchRepEmail = document.getElementById('editBranchRepEmail').value.trim();
            company.managedBy = document.getElementById('editManagedBy').value;

            // Persist
            saveCompaniesToStorage();
            displayCompanies();
            closeEditBranchModal();

            Swal.fire({
                icon: 'success',
                title: 'Branch Updated!',
                text: 'Branch information has been updated successfully.',
                confirmButtonColor: '#E67E00',
                timer: 2500,
                timerProgressBar: true
            });
        }

        function closeEditCompanyModal() {
            document.getElementById('editCompanyModal').classList.remove('active');
            document.querySelector('.modal-overlay').classList.remove('active');
            window.editingCompany = null;
            window.editingCompanyId = null;
        }

        function saveEditedCompany() {
            if (!window.editingCompanyId) return;

            const company = companies.find(c => c.id === window.editingCompanyId);
            if (!company) return;

            // Get form values
            const title = document.getElementById('editCompanyTitle').value.trim();
            const nameAr = document.getElementById('editCompanyNameAr').value.trim();
            const nameEn = document.getElementById('editCompanyNameEn').value.trim();
            const country = document.getElementById('editCompanyCountry').value;
            const establishedType = document.getElementById('editCompanyType').value;
            const hoAddress = document.getElementById('editHoAddress').value.trim();
            const isActive = document.getElementById('editCompanyStatus').value === 'true';

            // Validate required fields
            if (!title || !nameAr || !nameEn || !establishedType) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Information',
                    text: 'Please fill in all required fields.',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            // Update company data
            company.title = title;
            company.nameAr = nameAr;
            company.nameEn = nameEn;
            company.country = country;
            company.establishedType = establishedType;
            company.hoAddress = hoAddress;
            company.isActive = isActive;

            // Handle logo upload if file is selected
            const logoFile = document.getElementById('editLogoUpload').files[0];
            if (logoFile) {
                company.logo = logoFile.name;
            }

            // Update company in the array
            const companyIndex = companies.findIndex(c => c.id === window.editingCompanyId);
            if (companyIndex !== -1) {
                companies[companyIndex] = company;
            }

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Refresh display
            displayCompanies();

            // Close modal
            closeEditCompanyModal();

            // Show success message
                    Swal.fire({
                        icon: 'success',
                title: 'Company Updated!',
                text: `${company.title} has been updated successfully`,
                        confirmButtonColor: '#E67E00',
                timer: 3000,
                        timerProgressBar: true
                    });
                }

        // Zones Edit Functions
        let editZonesCounter = 0;
        let currentEditZonesCompanyId = null;

        function editZones(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            currentEditZonesCompanyId = companyId;
            editZonesCounter = 0;
            
            document.getElementById('editZonesModalTitle').textContent = `Edit Zones - ${company.title}`;
            document.getElementById('editZonesList').innerHTML = '';
            
            // Add existing zones
            if (company.zones && company.zones.length > 0) {
                company.zones.forEach(zone => {
                    addNewZone(zone);
                });
            } else {
                // Add first zone by default
                addNewZone();
            }
            
            document.getElementById('editZonesModal').classList.add('active');
            document.querySelector('.modal-overlay').classList.add('active');
        }

        function closeEditZonesModal() {
            document.getElementById('editZonesModal').classList.remove('active');
            document.querySelector('.modal-overlay').classList.remove('active');
            currentEditZonesCompanyId = null;
            editZonesCounter = 0;
        }

        function addNewZone(existingZone = null) {
            editZonesCounter++;
            const zonesList = document.getElementById('editZonesList');
            
            const zoneHTML = `
                <div class="dynamic-section" id="editZone${editZonesCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">Zone ${editZonesCounter}</span>
                        <button type="button" class="btn-remove" onclick="removeEditZone(${editZonesCounter})">Remove</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone Title</label>
                        <input type="text" class="form-input" id="editZoneTitle${editZonesCounter}" placeholder="Enter zone title" value="${existingZone?.title || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone Number</label>
                        <input type="text" class="form-input" id="editZoneNumber${editZonesCounter}" placeholder="Zone number" value="${existingZone?.number || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input form-textarea" id="editZoneDescription${editZonesCounter}" placeholder="Enter zone description" rows="3">${existingZone?.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Managed By</label>
                        <select class="form-input" id="editZoneManagedBy${editZonesCounter}">
                            <option value="">Select</option>
                            <option value="Client Team" ${existingZone?.managedBy === 'Client Team' ? 'selected' : ''}>Client Team</option>
                            <option value="WeFix Team" ${existingZone?.managedBy === 'WeFix Team' ? 'selected' : ''}>WeFix Team</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Technical Team</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="editTech${editZonesCounter}_WeFix TL1" value="WeFix TL1" ${existingZone?.technicalTeam?.includes('WeFix TL1') ? 'checked' : ''}>
                                <span>WeFix TL1</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editTech${editZonesCounter}_WeFix TL2" value="WeFix TL2" ${existingZone?.technicalTeam?.includes('WeFix TL2') ? 'checked' : ''}>
                                <span>WeFix TL2</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editTech${editZonesCounter}_WeFix TL3" value="WeFix TL3" ${existingZone?.technicalTeam?.includes('WeFix TL3') ? 'checked' : ''}>
                                <span>WeFix TL3</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="editTech${editZonesCounter}_WeFix TL4" value="WeFix TL4" ${existingZone?.technicalTeam?.includes('WeFix TL4') ? 'checked' : ''}>
                                <span>WeFix TL4</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            zonesList.insertAdjacentHTML('beforeend', zoneHTML);
        }

        function removeEditZone(zoneId) {
            const zoneElement = document.getElementById(`editZone${zoneId}`);
            if (zoneElement) {
                zoneElement.remove();
            }
        }

        function saveEditedZones() {
            if (!currentEditZonesCompanyId) return;

            const company = companies.find(c => c.id === currentEditZonesCompanyId);
            if (!company) return;

            const zonesToSave = [];
            
            // Collect all zone data
            for (let i = 1; i <= editZonesCounter; i++) {
                const zoneElement = document.getElementById(`editZone${i}`);
                if (!zoneElement) continue;

                const title = document.getElementById(`editZoneTitle${i}`)?.value.trim();
                const number = document.getElementById(`editZoneNumber${i}`)?.value.trim();
                const description = document.getElementById(`editZoneDescription${i}`)?.value.trim();
                const managedBy = document.getElementById(`editZoneManagedBy${i}`)?.value;

                // Collect technical team checkboxes
                const technicalTeam = [];
                const checkboxes = zoneElement.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        technicalTeam.push(checkbox.value);
                    }
                });

                if (title || number || description) {
                    const newZone = {
                        id: `zone_${Date.now()}_${i}`,
                        title: title || `Zone ${i}`,
                        number: number || i.toString(),
                        description: description || '',
                        managedBy: managedBy || '',
                        technicalTeam: technicalTeam
                    };
                    zonesToSave.push(newZone);
                }
            }

            // Update company zones
            company.zones = zonesToSave;

            // Update company in the array
            const companyIndex = companies.findIndex(c => c.id === currentEditZonesCompanyId);
            if (companyIndex !== -1) {
                companies[companyIndex] = company;
            }

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Refresh display
            displayCompanies();

            // Close modal
            closeEditZonesModal();

            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Zones Updated!',
                text: `${zonesToSave.length} zone(s) updated successfully`,
                confirmButtonColor: '#E67E00',
                timer: 3000,
                timerProgressBar: true
            });
        }

        // Add Zones Modal Functions
        let addZonesCounter = 0;
        let currentAddZonesCompanyId = null;

        function openAddZonesModal(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            currentAddZonesCompanyId = companyId;
            addZonesCounter = 0;
            
            document.getElementById('addZonesModalTitle').textContent = `Add Zones to ${company.title}`;
            document.getElementById('addZonesList').innerHTML = '';
            
            // Add first zone by default
            addNewZoneToCompany();
            
            document.getElementById('addZonesModal').classList.add('active');
            document.querySelector('.modal-overlay').classList.add('active');
        }

        function closeAddZonesModal() {
            document.getElementById('addZonesModal').classList.remove('active');
            document.querySelector('.modal-overlay').classList.remove('active');
            currentAddZonesCompanyId = null;
            addZonesCounter = 0;
        }

        // Add Contract Modal Functions
        let currentAddContractCompanyId = null;

        // Get next contract number based on existing contracts
        function getNextContractNumber() {
            try {
                // Get all companies from localStorage
                const storedCompanies = localStorage.getItem('wefixCompanies');
                if (!storedCompanies) {
                    return 'CNT-001';
                }
                
                const allCompanies = JSON.parse(storedCompanies);
                let maxNumber = 0;
                
                // Iterate through all companies and their contracts
                allCompanies.forEach(company => {
                    // Check company-level contract number
                    if (company.contractNumber) {
                        const match = company.contractNumber.match(/CNT-(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (num > maxNumber) {
                                maxNumber = num;
                            }
                        }
                    }
                    
                    // Check contracts array
                    if (company.contracts && Array.isArray(company.contracts)) {
                        company.contracts.forEach(contract => {
                            if (contract.contractNumber) {
                                const match = contract.contractNumber.match(/CNT-(\d+)/);
                                if (match) {
                                    const num = parseInt(match[1]);
                                    if (num > maxNumber) {
                                        maxNumber = num;
                                    }
                                }
                            }
                            // Also check number field
                            if (contract.number) {
                                const match = contract.number.match(/CNT-(\d+)/);
                                if (match) {
                                    const num = parseInt(match[1]);
                                    if (num > maxNumber) {
                                        maxNumber = num;
                                    }
                                }
                            }
                        });
                    }
                });
                
                // Return next number
                maxNumber++;
                return 'CNT-' + String(maxNumber).padStart(3, '0');
            } catch (error) {
                console.error('Error getting next contract number:', error);
                return 'CNT-001';
            }
        }

        function openAddContractModal(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            currentAddContractCompanyId = companyId;
            
            document.getElementById('addContractModalTitle').textContent = `Add Contract to ${company.title}`;
            
            // Reset form
            document.getElementById('addContractForm').reset();
            document.getElementById('addContractIsActive').checked = true;
            document.getElementById('addTeamLeaderCount').value = 1;
            document.getElementById('addBranchCount').value = 1;
            document.getElementById('addPreventiveTicketsCount').value = 1;
            document.getElementById('addCorrectiveTicketsCount').value = 1;
            
            // Auto-fill contract reference based on last number
            const nextContractNumber = getNextContractNumber();
            document.getElementById('addContractNumber').value = nextContractNumber;
            
            document.getElementById('addContractModal').classList.add('active');
            document.querySelector('.modal-overlay').classList.add('active');
        }

        function closeAddContractModal() {
            document.getElementById('addContractModal').classList.remove('active');
            document.querySelector('.modal-overlay').classList.remove('active');
            currentAddContractCompanyId = null;
            document.getElementById('addContractForm').reset();
        }

        function saveNewContract() {
            if (!currentAddContractCompanyId) return;

            const company = companies.find(c => c.id === currentAddContractCompanyId);
            if (!company) return;

            // Validate Business Model (required)
            const businessModelB2B = document.getElementById('addBusinessModelB2B');
            const businessModelWhiteLabel = document.getElementById('addBusinessModelWhiteLabel');
            const radioGroup = businessModelB2B.closest('.radio-group');
            if (!businessModelB2B.checked && !businessModelWhiteLabel.checked) {
                if (radioGroup) {
                    radioGroup.classList.add('error');
                    setTimeout(() => {
                        radioGroup.classList.remove('error');
                    }, 3000);
                }
                businessModelB2B.focus();
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Please select a Business Model',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            // Get contract data
            const contractNumber = document.getElementById('addContractNumber').value;
            const businessModel = businessModelB2B.checked ? businessModelB2B.value : (businessModelWhiteLabel.checked ? businessModelWhiteLabel.value : '');

            const contractIsActive = document.getElementById('addContractIsActive').checked;
            const teamLeaderCount = parseInt(document.getElementById('addTeamLeaderCount').value) || 1;
            const branchCount = parseInt(document.getElementById('addBranchCount').value) || 1;
            const preventiveTicketsCount = parseInt(document.getElementById('addPreventiveTicketsCount').value) || 1;
            const correctiveTicketsCount = parseInt(document.getElementById('addCorrectiveTicketsCount').value) || 1;
            
            const contractStartDate = document.getElementById('addContractStartDate').value;
            const contractEndDate = document.getElementById('addContractEndDate').value;
            const contractFiles = document.getElementById('addContractFilesUpload').files;
            const contractDescription = document.getElementById('addContractDescription').value;
            const contractValue = document.getElementById('addContractValue').value;

            // Create contract object
            const newContract = {
                id: 'CNT' + Date.now(),
                contractNumber: contractNumber,
                businessModel: businessModel,
                isActive: contractIsActive,
                teamLeaderCount: teamLeaderCount,
                branchCount: branchCount,
                preventiveTicketsCount: preventiveTicketsCount,
                correctiveTicketsCount: correctiveTicketsCount,
                startDate: contractStartDate,
                endDate: contractEndDate,
                files: contractFiles?.length > 0 ? Array.from(contractFiles).map(f => f.name).join(', ') : '',
                description: contractDescription,
                value: contractValue,
                number: contractNumber,
                createdAt: new Date().toISOString()
            };

            // Initialize contracts array if it doesn't exist
            if (!company.contracts) {
                company.contracts = [];
            }

            // Add contract to company
            company.contracts.push(newContract);

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Refresh display
            displayCompanies();
            
            // Close modal
            closeAddContractModal();

            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Contract Added!',
                text: 'Contract has been added successfully to ' + company.title,
                confirmButtonColor: '#E67E00',
                timer: 3000,
                timerProgressBar: true
            });
        }

        function addNewZoneToCompany() {
            addZonesCounter++;
            const zonesList = document.getElementById('addZonesList');
            
            const zoneHTML = `
                <div class="dynamic-section" id="addZone${addZonesCounter}">
                    <div class="dynamic-section-header">
                        <span class="dynamic-section-title">Zone ${addZonesCounter}</span>
                    </div>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label">Zone Title</label>
                            <input type="text" class="form-input" id="addZoneTitle${addZonesCounter}" placeholder="Zone Title">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Zone Number</label>
                            <input type="text" class="form-input" id="addZoneNumber${addZonesCounter}" placeholder="Zone Number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone Description</label>
                        <textarea class="form-input form-textarea" id="addZoneDescription${addZonesCounter}" placeholder="Zone Description"></textarea>
                    </div>
                </div>
            `;
            
            zonesList.insertAdjacentHTML('beforeend', zoneHTML);
        }


        function saveNewZones() {
            if (!currentAddZonesCompanyId) return;

            const company = companies.find(c => c.id === currentAddZonesCompanyId);
            if (!company) return;

            const zonesToAdd = [];
            
            // Collect all zone data
            for (let i = 1; i <= addZonesCounter; i++) {
                const zoneElement = document.getElementById(`addZone${i}`);
                if (!zoneElement) continue;

                const title = document.getElementById(`addZoneTitle${i}`)?.value.trim();
                const number = document.getElementById(`addZoneNumber${i}`)?.value.trim();
                const description = document.getElementById(`addZoneDescription${i}`)?.value.trim();

                // Technical team removed - set to empty array
                const technicalTeam = [];

                if (title || number || description) {
                    const newZone = {
                        id: `zone_${Date.now()}_${i}`,
                        title: title || `Zone ${i}`,
                        number: number || i.toString(),
                        description: description || '',
                        technicalTeam: technicalTeam
                    };
                    zonesToAdd.push(newZone);
                }
            }

            if (zonesToAdd.length === 0) {
            Swal.fire({
                    icon: 'warning',
                    title: 'No Zones Added',
                    text: 'Please add at least one zone with required fields filled.',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            // Add zones to company
            if (!company.zones) {
                company.zones = [];
            }
            company.zones.push(...zonesToAdd);

            // Update company in the array
            const companyIndex = companies.findIndex(c => c.id === currentAddZonesCompanyId);
            if (companyIndex !== -1) {
                companies[companyIndex] = company;
            }

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Refresh display
            displayCompanies();

            // Close modal
            closeAddZonesModal();

            // Show success message
                    Swal.fire({
                        icon: 'success',
                title: 'Zones Added!',
                text: `${zonesToAdd.length} zone(s) added to ${company.title}`,
                        confirmButtonColor: '#E67E00',
                timer: 3000,
                        timerProgressBar: true
                    });
                }

        // Single Zone Edit Functions
        let currentEditingZone = null;
        let currentEditingZoneCompanyId = null;

        function editSingleZone(companyId, zoneId) {
            const company = companies.find(c => c.id === companyId);
            if (!company || !company.zones) return;

            const zone = company.zones.find(z => z.id === zoneId);
            if (!zone) return;

            currentEditingZone = zone;
            currentEditingZoneCompanyId = companyId;

            // Populate form with zone data
            document.getElementById('editSingleZoneTitle').value = zone.title || '';
            document.getElementById('editSingleZoneNumber').value = zone.number || '';
            document.getElementById('editSingleZoneDescription').value = zone.description || '';

            // Clear and set technical team checkboxes
            const checkboxes = document.querySelectorAll('#editSingleZoneForm input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            if (zone.technicalTeam && zone.technicalTeam.length > 0) {
                zone.technicalTeam.forEach(tech => {
                    const checkbox = document.getElementById(`editSingleTech_${tech.toLowerCase().replace(' ', '_')}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }

            document.getElementById('editSingleZoneModalTitle').textContent = `Edit Zone : ${zone.title || 'Zone'}`;

            const modal = document.getElementById('editSingleZoneModal');
            modal.classList.add('active');
        }

        function closeEditSingleZoneModal() {
            const modal = document.getElementById('editSingleZoneModal');
            modal.classList.remove('active');
            currentEditingZone = null;
            currentEditingZoneCompanyId = null;
        }

        function saveSingleZone() {
            if (!currentEditingZone || !currentEditingZoneCompanyId) return;

            const company = companies.find(c => c.id === currentEditingZoneCompanyId);
            if (!company || !company.zones) return;

            // Get form values
            const title = document.getElementById('editSingleZoneTitle').value.trim();
            const number = document.getElementById('editSingleZoneNumber').value.trim();
            const description = document.getElementById('editSingleZoneDescription').value.trim();

            // Collect technical team checkboxes
            const technicalTeam = [];
            const checkboxes = document.querySelectorAll('#editSingleZoneForm input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    technicalTeam.push(checkbox.value);
                }
            });

            // Store zone ID before closing modal
            const updatedZoneId = currentEditingZone.id;

            // Update zone data
            currentEditingZone.title = title || currentEditingZone.title;
            currentEditingZone.number = number || currentEditingZone.number;
            currentEditingZone.description = description;
            currentEditingZone.technicalTeam = technicalTeam;

            // Update company in the array
            const companyIndex = companies.findIndex(c => c.id === currentEditingZoneCompanyId);
            if (companyIndex !== -1) {
                companies[companyIndex] = company;
            }

            // Save to localStorage
            saveCompaniesToStorage();
            
            // Close modal first
            closeEditSingleZoneModal();

            // Refresh display with company expanded
            displayCompanies(currentEditingZoneCompanyId);

            // Wait for DOM to update, then scroll to the updated zone
            setTimeout(() => {
                const zoneElement = document.getElementById(`zone_${updatedZoneId}`);
                if (zoneElement) {
                    zoneElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add highlight effect
                    zoneElement.style.transition = 'box-shadow 0.3s ease';
                    zoneElement.style.boxShadow = '0 0 0 3px rgba(230, 126, 0, 0.3)';
                    setTimeout(() => {
                        zoneElement.style.boxShadow = '';
                    }, 2000);
                }
            }, 100);

            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Zone Updated!',
                text: 'Zone has been updated successfully',
                confirmButtonColor: '#E67E00',
                timer: 3000,
                timerProgressBar: true
            });
        }

        function deleteSingleZone() {
            if (!currentEditingZone || !currentEditingZoneCompanyId) return;

            Swal.fire({
                title: 'Delete Zone',
                text: `Are you sure you want to delete "${currentEditingZone.title || 'this zone'}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    const company = companies.find(c => c.id === currentEditingZoneCompanyId);
                    if (company && company.zones) {
                        // Remove zone from company
                        company.zones = company.zones.filter(z => z.id !== currentEditingZone.id);

                        // Update company in the array
                        const companyIndex = companies.findIndex(c => c.id === currentEditingZoneCompanyId);
                        if (companyIndex !== -1) {
                            companies[companyIndex] = company;
                        }

                        // Save to localStorage
                        saveCompaniesToStorage();
                        
                        // Refresh display
                        displayCompanies();

                        // Close modal
                        closeEditSingleZoneModal();

                        // Show success message
                    Swal.fire({
                        icon: 'success',
                            title: 'Zone Deleted!',
                            text: 'Zone has been deleted successfully',
                        confirmButtonColor: '#E67E00',
                            timer: 3000,
                        timerProgressBar: true
                    });
                    }
                }
            });
        }

        // Save companies to localStorage
        function saveCompaniesToStorage() {
            try {
                localStorage.setItem('wefixCompanies', JSON.stringify(companies));
            } catch (error) {
                console.error('Error saving companies to localStorage:', error);
            }
        }

        // Load companies from localStorage
        function loadCompaniesFromStorage() {
            try {
                const storedCompanies = localStorage.getItem('wefixCompanies');
                if (storedCompanies) {
                    return JSON.parse(storedCompanies);
                }
            } catch (error) {
                console.error('Error loading companies from localStorage:', error);
            }
            return null;
        }

        // Toggle contract details
        function toggleContractDetails(companyId) {
            const contractDetails = document.getElementById('contractDetails_' + companyId);
            if (contractDetails.style.display === 'none') {
                contractDetails.style.display = 'block';
            } else {
                contractDetails.style.display = 'none';
            }
        }

        // Toggle branch details for a specific contract
        function toggleBranchDetailsForContract(companyId, contractId) {
            const branchDetails = document.getElementById('branchDetails_' + companyId + '_' + contractId);
            const contractToggle = document.getElementById('contractToggle_' + companyId + '_' + contractId);
            if (branchDetails.style.display === 'none') {
                branchDetails.style.display = 'block';
                if (contractToggle) contractToggle.textContent = '-';
            } else {
                branchDetails.style.display = 'none';
                if (contractToggle) contractToggle.textContent = '+';
            }
        }

        // Toggle branch content
        function toggleBranchContent(branchId) {
            const content = document.getElementById(`branchContent_${branchId}`);
            const toggle = document.getElementById(`branchToggle_${branchId}`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '-';
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
            }
        }

        // Generate contract details HTML
        function generateContractDetails(company) {
            if (!company.contracts || company.contracts.length === 0) {
                return '<div class="contract-details-header">No contracts available</div>';
            }

            let html = `
                <div class="contract-details-header">
                    <span>Contract Details</span>
                </div>
            `;
            
            // Generate contract items
            company.contracts.forEach((contract, index) => {
                const contractId = contract.id || `contract_${index}`;
                const businessModel = contract.businessModel || 'Not specified';
                const isActive = contract.isActive !== undefined ? contract.isActive : true;
                const branchCount = contract.branchCount || 0;
                const preventiveTicketsCount = contract.preventiveTicketsCount || 0;
                const correctiveTicketsCount = contract.correctiveTicketsCount || 0;
                const startDate = contract.startDate || 'Not specified';
                const contractNumber = contract.contractNumber || contract.number || `CNT-${index + 1}`;
                
                html += `
                    <div class="contract-item">
                        <div class="contract-header" onclick="toggleBranchDetailsForContract('${company.id}', '${contractId}')" style="cursor: pointer;">
                            <div style="font-weight: 600; font-size: 16px; color: #1f2937;">${contractNumber}</div>
                            <div class="contract-toggle" id="contractToggle_${company.id}_${contractId}" style="font-size: 18px; color: #E67E00; font-weight: bold;">+</div>
                        </div>
                        <div class="contract-info" onclick="toggleBranchDetailsForContract('${company.id}', '${contractId}')" style="cursor: pointer;">
                            <div class="contract-info-item">
                                <div class="contract-info-label">Business Model</div>
                                <div class="contract-info-value">${businessModel}</div>
                            </div>
                            <div class="contract-info-item">
                                <div class="contract-info-label">Is Active</div>
                                <div class="contract-info-value">
                                    <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                        ${isActive ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                            </div>
                            <div class="contract-info-item">
                                <div class="contract-info-label"># of Branch</div>
                                <div class="contract-info-value">${branchCount}</div>
                            </div>
                            <div class="contract-info-item">
                                <div class="contract-info-label"># of Preventive Tickets</div>
                                <div class="contract-info-value">${preventiveTicketsCount}</div>
                            </div>
                            <div class="contract-info-item">
                                <div class="contract-info-label"># of Corrective Tickets</div>
                                <div class="contract-info-value">${correctiveTicketsCount}</div>
                            </div>
                            <div class="contract-info-item">
                                <div class="contract-info-label">Contract Start Date</div>
                                <div class="contract-info-value">${startDate}</div>
                            </div>
                        </div>
                        <div class="branch-details" id="branchDetails_${company.id}_${contractId}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            ${generateBranchDetails(company, contractId)}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        // Generate branch details HTML
        function generateBranchDetails(company, contractId = null) {
            if (!company.branches || company.branches === 0) {
                return '<div class="branch-details-header">No branches available</div>';
            }

            let html = `
                <div class="branch-details-header">
                    <span>Branch Details</span>
                </div>
            `;
            
            // Generate branch items based on the number of branches
            for (let i = 1; i <= company.branches; i++) {
                const branchTitle = company.branchTitle || `Branch ${i}`;
                const branchNameAr = company.branchNameAr || ` ${i}`;
                const branchNameEn = company.branchNameEn || `Branch ${i}`;
                const repName = company.branchRepName || `Representative ${i}`;
                const repMobile = company.branchRepMobile || `+962 7${Math.floor(Math.random() * 90000000) + 10000000}`;
                const repEmail = company.branchRepEmail || `rep${i}@${company.title.toLowerCase().replace(/\s+/g, '')}.com`;
                
                // Get team leaders for this branch (limit to 2-3 per branch)
                const teamLeaders = company.teamLeaders || [];
                const branchTeamLeaders = teamLeaders.slice(0, Math.min(3, teamLeaders.length));
                
                const branchId = `${company.id}_branch_${i}`;
                html += `
                    <div class="branch-item">
                        <div class="branch-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="branch-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%; cursor: pointer;" onclick="event.stopPropagation(); toggleBranchContent('${branchId}')">
                                <span>${branchTitle}</span>
                                <button class="branch-toggle" id="branchToggle_${branchId}">-</button>
                            </div>
                            <button class="btn-edit" onclick="event.stopPropagation(); editBranch('${company.id}')" style="margin-left: 12px;">Edit Branch</button>
                        </div>
                        <div class="branch-content" id="branchContent_${branchId}">
                            <div class="branch-info">
                                <div class="branch-info-item">
                                    <div class="branch-info-label">Branch Name (Arabic)</div>
                                    <div class="branch-info-value">${branchNameAr}</div>
                                </div>
                                <div class="branch-info-item">
                                    <div class="branch-info-label">Branch Name (English)</div>
                                    <div class="branch-info-value">${branchNameEn}</div>
                                </div>
                                <div class="branch-info-item">
                                    <div class="branch-info-label">Main Service</div>
                                    <div class="branch-info-value">${company.mainCategory || 'Not specified'}</div>
                                </div>
                                <div class="branch-info-item">
                                    <div class="branch-info-label">Sub Service</div>
                                    <div class="branch-info-value">${company.subCategory || 'Not specified'}</div>
                                </div>
                                <div class="branch-info-item">
                                    <div class="branch-info-label">Representative Name</div>
                                    <div class="branch-info-value">${repName}</div>
                                </div>
                                <div class="branch-info-item">
                                    <div class="branch-info-label">Representative Mobile</div>
                                    <div class="branch-info-value">${repMobile}</div>
                                </div>
                            </div>
                            <div class="team-leaders-section">
                                <div class="team-leaders-title">Team Leaders (${branchTeamLeaders.length})</div>
                                ${generateTeamLeadersHTML(branchTeamLeaders)}
                            </div>
                            <div class="zones-section">
                                ${generateZonesHTML(company.zones || [], company.id)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        // Generate team leaders HTML
        function generateTeamLeadersHTML(teamLeaders) {
            if (!teamLeaders || teamLeaders.length === 0) {
                return '<div style="color: #6b7280; font-size: 12px; font-style: italic; text-align: center; padding: 20px;">No team leaders assigned</div>';
            }

            const cardsHTML = teamLeaders.map(tl => {
                const status = tl.isActive ? 'active' : 'inactive';
                const statusText = tl.isActive ? 'Active' : 'Inactive';
                
                // Use default avatar icon if no image provided
                const avatarContent = tl.image ? 
                    `<img src="${tl.image}" alt="Team Leader" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div class="default-avatar" style="display: none;"></div>` :
                    `<div class="default-avatar"></div>`;
                
                const categoriesText = tl.categories && tl.categories.length > 0 ? 
                    tl.categories.join(', ') : 'No categories';
                
                return `
                    <div class="team-leader-card">
                        <div class="team-leader-card-header">
                            <div class="team-leader-avatar-large status-${status}">
                                ${avatarContent}
                            </div>
                        <div class="team-leader-info">
                                <div class="team-leader-name">${tl.nameEn || tl.name || 'Not specified'}</div>
                                <div class="team-leader-job-title">${tl.nameAr || ' '}</div>
                            <div class="team-leader-mobile">${tl.mobile || 'Not specified'}</div>
                            </div>
                        </div>
                        <div class="team-leader-card-body">
                            <div class="team-leader-field">
                                <span class="field-label">Email:</span>
                                <span class="field-value">${tl.email || 'Not specified'}</span>
                            </div>
                            <div class="team-leader-field">
                                <span class="field-label">Categories:</span>
                                <span class="field-value">${categoriesText}</span>
                            </div>
                            ${tl.description ? `
                                <div class="team-leader-field">
                                    <span class="field-label">Notes:</span>
                                    <span class="field-value">
                                        <span class="note-icon" title="${tl.description}"></span>
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right; margin-top: 12px; padding: 0 16px 16px;">
                            <button class="btn-edit" onclick="event.stopPropagation(); editTeamLeader('${tl.id}')">Edit</button>
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="team-leaders-grid">${cardsHTML}</div>`;
        }

        // Generate zones HTML
        function generateZonesHTML(zones, companyId) {
            if (!zones || zones.length === 0) {
                return '<div style="color: #6b7280; font-size: 12px; font-style: italic; text-align: center; padding: 20px;">No zones available</div>';
            }

            const zonesHTML = zones.map((zone, index) => {
                const technicalTeamText = zone.technicalTeam && zone.technicalTeam.length > 0 ? 
                    zone.technicalTeam.join(', ') : 'No technical team assigned';
                
                return `
                    <div class="zone-item" id="zone_${zone.id}">
                        <div class="zone-header">
                            <div class="zone-title">${zone.title || `Zone ${index + 1}`}</div>
                            <div class="zone-number">#${zone.number || (index + 1)}</div>
                        </div>
                        <div class="zone-info">
                            <div class="zone-info-item">
                                <div class="zone-info-label">Description:</div>
                                <div class="zone-info-value">${zone.description || 'No description'}</div>
                            </div>
                            <div class="zone-info-item">
                                <div class="zone-info-label">Managed By:</div>
                                <div class="zone-info-value">${zone.managedBy || 'Not specified'}</div>
                            </div>
                            <div class="zone-info-item">
                                <div class="zone-info-label">Technical Team:</div>
                                <div class="zone-info-value">${technicalTeamText}</div>
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 12px; padding: 0 16px 16px;">
                            <button class="btn-edit" onclick="event.stopPropagation(); editSingleZone('${companyId}', '${zone.id}')">Edit</button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="zones-header" style="margin-bottom: 15px;">
                    <span style="font-weight: 700; color: #1f2937; font-size: 16px;">Zones (${zones.length})</span>
                </div>
                <div class="zones-list">${zonesHTML}</div>
            `;
        }

        // Generate team leaders avatars for the list view
        function generateTeamLeadersAvatars(company) {
            if (!company.teamLeaders || company.teamLeaders.length === 0) {
                return '<div style="color: #6b7280; font-size: 11px; font-style: italic;">No TL</div>';
            }

            // Limit to show maximum 5 avatars to avoid overcrowding
            const maxAvatars = 5;
            const teamLeaders = company.teamLeaders.slice(0, maxAvatars);
            const remainingCount = company.teamLeaders.length - maxAvatars;

            let html = teamLeaders.map((tl, index) => {
                const initials = tl.name ? tl.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'TL';
                const branchName = `Branch ${index + 1}`;
                
                return `
                    <div class="team-leader-avatar-small" title="${tl.name || 'Team Leader'} - ${branchName} - ${tl.mobile || 'No mobile'}">
                        ${initials}
                        <div class="team-leader-tooltip">
                            <div class="tooltip-name">${tl.name || 'Team Leader'}</div>
                            <div class="tooltip-branch">${branchName}</div>
                            <div class="tooltip-mobile">${tl.mobile || 'No mobile'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add "+X more" indicator if there are more team leaders
            if (remainingCount > 0) {
                html += `<div class="team-leader-avatar-small" style="background: #6b7280;" title="${remainingCount} more team leaders">+${remainingCount}</div>`;
            }

            return html;
        }

        // Filter Companies
        function filterCompanies() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            filteredCompanies = companies.filter(company => {
                const matchesSearch = !searchTerm || 
                    company.title.toLowerCase().includes(searchTerm) ||
                    company.id.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || 
                    company.isActive.toString() === statusFilter;
                
                const matchesType = !typeFilter || 
                    company.establishedType === typeFilter;

                return matchesSearch && matchesStatus && matchesType;
            });

            // Reset to page 1 when filtering
            currentPage = 1;
            applySorting();
            displayCompanies();
        }

        // Apply Sorting
        function applySorting() {
            if (!sortColumn) return;

            filteredCompanies.sort((a, b) => {
                let aVal, bVal;

                switch(sortColumn) {
                    case 'id':
                        aVal = a.id;
                        bVal = b.id;
                        break;
                    case 'title':
                        aVal = a.title.toLowerCase();
                        bVal = b.title.toLowerCase();
                        break;
                    case 'isActive':
                        aVal = a.isActive ? 1 : 0;
                        bVal = b.isActive ? 1 : 0;
                        break;
                    case 'establishedType':
                        aVal = a.establishedType;
                        bVal = b.establishedType;
                        break;
                    case 'branches':
                        aVal = a.branches;
                        bVal = b.branches;
                        break;
                    default:
                        return 0;
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Sort Handler
        function handleSort(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Update sort icons
            document.querySelectorAll('.grid-header-cell').forEach(cell => {
                cell.classList.remove('sorted');
                const icon = cell.querySelector('.sort-icon');
                if (icon) icon.textContent = '';
            });

            const activeCell = document.querySelector(`[data-sort="${column}"]`);
            if (activeCell) {
                activeCell.classList.add('sorted');
                const icon = activeCell.querySelector('.sort-icon');
                if (icon) {
                    icon.textContent = sortDirection === 'asc' ? '' : '';
                }
            }

            applySorting();
            displayCompanies();
        }

        // Display Companies
        function displayCompanies(expandCompanyId = null) {
            try {
                const gridContainer = document.getElementById('companiesGrid');
                const resultsCount = document.getElementById('resultsCount');
                const paginationContainer = document.getElementById('paginationContainer');
                
                if (!gridContainer || !resultsCount || !paginationContainer) {
                    console.error('Required DOM elements not found for displayCompanies');
                    return;
                }
                
                resultsCount.textContent = `Showing ${filteredCompanies.length} results`;

            if (filteredCompanies.length === 0) {
                gridContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No companies found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                paginationContainer.style.display = 'none';
                return;
            }

            // Reverse the entire filtered companies array (newest first)
            const reversedFilteredCompanies = [...filteredCompanies].reverse();
            
            // Calculate pagination
            const totalPages = Math.ceil(reversedFilteredCompanies.length / rowsPerPage);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, reversedFilteredCompanies.length);
            const paginatedCompanies = reversedFilteredCompanies.slice(startIndex, endIndex);

            // Display companies for current page (newest first)
            gridContainer.innerHTML = paginatedCompanies.map(company => {
                const shouldExpand = expandCompanyId === company.id;
                return `
                <div class="company-row" data-company-id="${company.id}">
                    <div class="grid-row clickable-row" onclick="toggleContractDetails('${company.id}')">
                        <div class="grid-cell" data-label="Logo">
                            <div class="company-logo">${company.logo}</div>
                        </div>
                        <div class="grid-cell" data-label="Company ID">${company.id}</div>
                        <div class="grid-cell" data-label="Company Title">${company.title}</div>
                        <div class="grid-cell" data-label="Is Active">
                            <span class="status-badge ${company.isActive ? 'status-active' : 'status-inactive'}">
                                ${company.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div class="grid-cell" data-label="Established Type">${company.establishedType}</div>
                    <div class="grid-cell branches-count" data-label="# of Branches">${company.branches}</div>
                    <div class="grid-cell" data-label="Team Leaders">
                        <div class="team-leaders-avatars">
                            ${generateTeamLeadersAvatars(company)}
                        </div>
                    </div>
                    <div class="grid-cell" data-label="Actions">
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="event.stopPropagation(); editCompany('${company.id}')" title="Edit Company">
                                Edit
                            </button>
                            <button class="btn-add-user" onclick="event.stopPropagation(); addUserToCompany('${company.id}')" title="Add User">
                                Add User
                            </button>
                            <button class="btn-add-branch" onclick="event.stopPropagation(); addBranchToCompany('${company.id}')" title="Add Branch">
                                Add Branch
                            </button>
                            <button class="btn-add-zone" onclick="event.stopPropagation(); addZoneToCompany('${company.id}')" title="Add Zone">
                                Add Zone
                            </button>
                            <button class="btn-add-contract" onclick="event.stopPropagation(); manageMaintenanceServices('${company.id}')" title="Manage Maintenance Services">
                                Manage Maintenance Services
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="contract-details" id="contractDetails_${company.id}" style="display: ${shouldExpand ? 'block' : 'none'};">
                        ${generateContractDetails(company)}
                    </div>
                </div>
            `;
            }).join('');

            // Update pagination info
            document.getElementById('paginationInfo').textContent = 
                `Showing ${startIndex + 1} - ${endIndex} of ${filteredCompanies.length}`;

            // Show pagination controls
            paginationContainer.style.display = 'flex';
            
            // Render pagination buttons
            renderPagination(totalPages);
            } catch (error) {
                console.error('Error in displayCompanies:', error);
                const gridContainer = document.getElementById('companiesGrid');
                if (gridContainer) {
                    gridContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <h3>Error loading companies</h3>
                            <p>Please refresh the page</p>
                        </div>
                    `;
                }
            }
        }

        // Render Pagination Controls
        function renderPagination(totalPages) {
            const controls = document.getElementById('paginationControls');
            let buttons = '';

            // Previous button
            buttons += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;

            // Page number buttons
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                buttons += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    buttons += `<span style="padding: 8px 4px;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                buttons += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    buttons += `<span style="padding: 8px 4px;">...</span>`;
                }
                buttons += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            // Next button
            buttons += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;

            controls.innerHTML = buttons;
        }

        // Go to Page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredCompanies.length / rowsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayCompanies();
                // Scroll to top of grid
                document.getElementById('companiesGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Note: Modal only closes via Cancel button or X button, not by clicking outside

        // Initialize when DOM is ready
        function initializeCompaniesPage() {
            try {
                // Event Listeners for Filtering
                const searchInput = document.getElementById('searchInput');
                const statusFilter = document.getElementById('statusFilter');
                const typeFilter = document.getElementById('typeFilter');
                
                if (searchInput) {
                    searchInput.addEventListener('input', filterCompanies);
                }
                if (statusFilter) {
                    statusFilter.addEventListener('change', filterCompanies);
                }
                if (typeFilter) {
                    typeFilter.addEventListener('change', filterCompanies);
                }

                // Event Listeners for Sorting
                document.querySelectorAll('.grid-header-cell').forEach(cell => {
                    const sortColumn = cell.getAttribute('data-sort');
                    if (sortColumn && sortColumn !== 'logo') {
                        cell.addEventListener('click', () => handleSort(sortColumn));
                    }
                });

                // Initialize data
                // Try to load companies from localStorage first
                const storedCompanies = loadCompaniesFromStorage();
                if (storedCompanies && storedCompanies.length > 0) {
                    companies = storedCompanies;
                } else {
                    // Generate sample companies if no stored data
                    generateSampleCompanies();
                    // Save sample companies to localStorage
                    saveCompaniesToStorage();
                }
                
                filteredCompanies = [...companies];
                displayCompanies();
            } catch (error) {
                console.error('Error initializing companies page:', error);
                // Fallback: try to generate sample companies
                try {
                    generateSampleCompanies();
                    saveCompaniesToStorage();
                    filteredCompanies = [...companies];
                    displayCompanies();
                } catch (e) {
                    console.error('Failed to generate sample companies:', e);
                }
            }
        }

        // Run initialization - since script is at end of body, DOM should be ready
        // But use DOMContentLoaded as fallback for safety
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCompaniesPage);
        } else {
            // DOM is already loaded, run immediately
            initializeCompaniesPage();
        }
    </script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>



