<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeFix Platform - Tickets</title>
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #32281d 0%, #E67E00 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo span {
            color: #FCD34D;
        }

        .menu {
            list-style: none;
        }

        .menu-item {
            margin-bottom: 5px;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .menu-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: #FCD34D;
        }

        .menu-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: #FCD34D;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 18px;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #E67E00;
        }

        .btn-add {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(247, 143, 30, 0.4);
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Modal Popup Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 22px;
            color: #E67E00;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #374151;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-group-required::after {
            content: ' *';
            color: #EF4444;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #F78F1E;
            box-shadow: 0 0 0 3px rgba(247, 143, 30, 0.1);
        }

        .form-input:disabled {
            background-color: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #F78F1E;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .location-map-container {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9fafb;
            margin-bottom: 10px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-map-placeholder {
            color: #6b7280;
            font-size: 14px;
        }

        .edit-location-link {
            color: #F78F1E;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .edit-location-link:hover {
            text-decoration: underline;
        }

        .technician-item.unavailable {
            opacity: 0.5;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .technician-item.unavailable input {
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(247, 143, 30, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Wizard Form Styles */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }

        .wizard-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 8px;
        }

        .wizard-step:hover {
            background-color: rgba(230, 126, 0, 0.1);
            transform: translateY(-2px);
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-title {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 500;
        }

        .wizard-step.active .step-number {
            background-color: #E67E00;
            color: white;
        }

        .wizard-step.active .step-title {
            color: #E67E00;
            font-weight: 600;
        }

        .wizard-step.completed .step-number {
            background-color: #10B981;
            color: white;
        }

        .wizard-step.completed .step-title {
            color: #10B981;
        }

        .wizard-step.disabled {
            pointer-events: none;
            opacity: 0.4;
        }

        .wizard-section {
            display: none;
        }

        .wizard-section.active {
            display: block;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: white;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .sub-services-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .sub-service-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            background: white;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .sub-service-card:hover {
            border-color: #F78F1E;
            box-shadow: 0 4px 10px rgba(247, 143, 30, 0.12);
        }

        .sub-service-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .sub-service-header label {
            flex: 1;
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }

        .sub-service-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #6b7280;
        }

        .sub-service-price {
            font-weight: 600;
            color: #065F46;
        }

        .sub-service-badge {
            display: inline-block;
            background: #eff6ff;
            color: #1d4ed8;
            border-radius: 9999px;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .conditional-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .conditional-section.show {
            display: block;
        }

        /* Tools Section Styles */
        .tools-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }

        .tool-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .tool-checkbox-item:hover {
            background-color: #f3f4f6;
        }

        .tool-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .tool-checkbox-item label {
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            margin: 0;
            flex: 1;
        }

        .tool-checkbox-item.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .tools-container {
                grid-template-columns: 1fr;
            }
        }

        /* Tickets Grid Styles */
        .filter-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex: 1;
        }

        .filter-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #F78F1E;
            box-shadow: 0 0 0 3px rgba(247, 143, 30, 0.1);
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #F78F1E;
        }

        .results-count {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .tickets-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #F78F1E;
            color: #E67E00;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            border-color: #E67E00;
        }

        .pagination-page-numbers {
            display: flex;
            gap: 5px;
        }

        .ticket-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ticket-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .ticket-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .ticket-id {
            font-weight: 600;
            color: #E67E00;
            font-size: 16px;
        }

        .ticket-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-in-progress {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-completed {
            background: #D1FAE5;
            color: #065F46;
        }

        .ticket-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .ticket-info-item {
            display: flex;
            flex-direction: column;
        }

        .ticket-info-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .ticket-info-value {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .ticket-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #EFF6FF;
            color: #2563EB;
        }

        .btn-edit:hover {
            background: #DBEAFE;
        }

        .btn-delete {
            background: #FEF2F2;
            color: #DC2626;
        }

        .btn-delete:hover {
            background: #FEE2E2;
        }

        .btn-timeline {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
        }

        .btn-timeline:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(247, 143, 30, 0.3);
        }

        .btn-update {
            background: #ECFDF5;
            color: #059669;
        }

        .btn-update:hover {
            background: #D1FAE5;
        }

        .btn-additional-work {
            background: #F0F9FF;
            color: #0369A1;
        }

        .btn-additional-work:hover {
            background: #E0F2FE;
        }

        /* Additional Work List Styles */
        .additional-work-list {
            margin-top: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .additional-work-list-header {
            background: #f9fafb;
            padding: 12px 16px;
            display: grid;
            grid-template-columns: 250px 130px 280px 200px;
            gap: 20px;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .additional-work-list-body {
            max-height: 300px;
            overflow-y: auto;
        }

        .additional-work-list-item {
            padding: 12px 16px;
            display: grid;
            grid-template-columns: 250px 130px 280px 200px;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s ease;
        }

        .additional-work-list-item:last-child {
            border-bottom: none;
        }

        .additional-work-list-item:hover {
            background-color: #f9fafb;
        }

        .additional-work-item-name {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .additional-work-item-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
        }

        .additional-work-item-file {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            min-width: 0;
        }

        .additional-work-item-file-link {
            color: #0369A1;
            text-decoration: none;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .additional-work-item-file-link:hover {
            color: #E67E00;
            text-decoration: underline;
        }

        .additional-work-item-file-icon {
            font-size: 16px;
        }

        .additional-work-item-date {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            gap: 2px;
            white-space: nowrap;
        }

        .additional-work-item-date-time {
            font-size: 11px;
            color: #9ca3af;
        }

        .status-inprogress {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-canceled {
            background: #FEE2E2;
            color: #991B1B;
        }

        .status-approved {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-rejected {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* Timeline Modal Styles */
        .timeline-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .timeline-modal.active {
            display: flex;
        }

        .timeline-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .timeline-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .timeline-header h3 {
            font-size: 22px;
            color: #E67E00;
        }

        .timeline-body {
            padding: 30px;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            padding-left: 50px;
        }

        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 24px;
            top: 60px;
            width: 2px;
            height: calc(100% + 10px);
            background: linear-gradient(to bottom, #E67E00, #e5e7eb);
        }

        .timeline-avatar {
            position: absolute;
            left: 0;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            z-index: 2;
        }

        .timeline-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(247, 143, 30, 0.4);
        }

        .timeline-arrow {
            position: absolute;
            left: 20px;
            top: 58px;
            color: #E67E00;
            font-size: 20px;
            z-index: 1;
            animation: pulse 2s infinite;
        }

        .timeline-content-box {
            flex: 1;
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .timeline-content-box:hover {
            background: #f3f4f6;
            border-color: #E67E00;
            transform: translateX(5px);
        }

        .timeline-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .timeline-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .timeline-datetime {
            font-size: 13px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timeline-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #f9fafb;
            color: #374151;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: #f3f4f6;
            border-color: #F78F1E;
            color: #E67E00;
        }

        .calendar-today-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-today-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }

        .calendar-date-display {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            flex: 1;
            text-align: center;
        }

        .calendar-view-selector {
            display: flex;
            gap: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #d1d5db;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: #f9fafb;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid #d1d5db;
        }

        .view-btn:last-child {
            border-right: none;
        }

        .view-btn:hover {
            background: #f3f4f6;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
        }

        .calendar-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Month View */
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 1px;
        }

        .calendar-weekday {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            color: #6b7280;
            background: #f9fafb;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            min-height: 120px;
            background: white;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: #f9fafb;
        }

        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }

        .calendar-day.today {
            background: #EFF6FF;
            border: 2px solid #6366F1;
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .calendar-day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-event {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-event:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .calendar-event.more {
            background: #e5e7eb;
            color: #374151;
            text-align: center;
            font-weight: 500;
        }

        /* Week View */
        .calendar-week-header {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
        }

        .calendar-week-time-column {
            width: 60px;
            border-right: 1px solid #e5e7eb;
        }

        .calendar-week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            flex: 1;
        }

        .calendar-week-day-header {
            padding: 12px;
            text-align: center;
            border-right: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .calendar-week-day-header.today {
            background: #EFF6FF;
            color: #6366F1;
        }

        .calendar-week-body {
            display: flex;
            height: 600px;
            overflow-y: auto;
        }

        .calendar-week-time-slots {
            width: 60px;
            border-right: 1px solid #e5e7eb;
            padding-top: 40px;
        }

        .calendar-week-time-slot {
            height: 60px;
            border-bottom: 1px solid #e5e7eb;
            padding: 4px;
            font-size: 11px;
            color: #6b7280;
        }

        .calendar-week-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            position: relative;
        }

        .calendar-week-day-column {
            border-right: 1px solid #e5e7eb;
            position: relative;
        }

        .calendar-week-event {
            position: absolute;
            left: 2px;
            right: 2px;
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            overflow: hidden;
            z-index: 1;
        }

        /* Day View */
        .calendar-day-header {
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
            font-size: 18px;
            font-weight: 600;
            color: #374151;
        }

        .calendar-day-body {
            display: flex;
            height: 700px;
            overflow-y: auto;
        }

        .calendar-day-time-column {
            width: 80px;
            border-right: 1px solid #e5e7eb;
            padding-top: 40px;
        }

        .calendar-day-time-slot {
            height: 60px;
            border-bottom: 1px solid #e5e7eb;
            padding: 4px;
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .calendar-day-grid {
            flex: 1;
            position: relative;
        }

        .calendar-day-event {
            position: absolute;
            left: 4px;
            right: 4px;
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            padding: 8px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .calendar-day-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Calendar Ticket Tooltip */
        .calendar-ticket-tooltip {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            min-width: 320px;
            max-width: 400px;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            overflow: hidden;
        }

        .calendar-ticket-tooltip.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .tooltip-header {
            background: linear-gradient(135deg, #F78F1E 0%, #E67E00 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .tooltip-header-icon {
            font-size: 18px;
        }

        .tooltip-body {
            padding: 16px;
        }

        .tooltip-detail-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 10px;
        }

        .tooltip-detail-item:last-child {
            margin-bottom: 0;
        }

        .tooltip-icon {
            font-size: 18px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .tooltip-detail-content {
            flex: 1;
        }

        .tooltip-detail-label {
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .tooltip-detail-value {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .tooltip-detail-value.italic {
            font-style: italic;
        }

        /* Icon colors */
        .tooltip-icon.clock {
            color: #F97316; /* Orange */
        }

        .tooltip-icon.person {
            color: #3B82F6; /* Blue */
        }

        .tooltip-icon.ticket {
            color: #3B82F6; /* Blue */
        }

        .tooltip-icon.pushpin {
            color: #EF4444; /* Red */
        }

        .tooltip-icon.female-engineer {
            color: #10B981; /* Green */
        }

        .tooltip-icon.money {
            color: #F59E0B; /* Yellow */
        }

        .tooltip-icon.notes {
            color: #F59E0B; /* Yellow */
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .form-group-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script>
        // Fallback to ensure the handler exists before full initialization
        if (typeof window.openCreateTicketModal !== 'function') {
            window.openCreateTicketModal = function() {
                console.warn('Create Ticket modal handler is initializing...');
            };
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>We<span>Fix</span></h1>
            </div>
            <ul class="menu">
                <li class="menu-item">
                    <a href="index.html" class="menu-link">
                        <span class="menu-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link">
                        <span class="menu-icon">üìÖ</span>
                        <span>Calendar</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="tickets.html" class="menu-link active">
                        <span class="menu-icon">üé´</span>
                        <span>Tickets</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link customers-link">
                        <span class="menu-icon">üë•</span>
                        <span>Customers</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="contracts.html" class="menu-link">
                        <span class="menu-icon">üìã</span>
                        <span>Contracts</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="permissions.html" class="menu-link">
                        <span class="menu-icon">üîê</span>
                        <span>Roles</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h2>Tickets</h2>
                <button class="btn-add" onclick="window.openCreateTicketModal()">
                    <span>‚ûï</span>
                    <span>Create New Ticket</span>
                </button>
            </div>
            <div class="content-area">
                <!-- Calendar Header with View Selector -->
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">
                            <span>‚Äπ</span>
                        </button>
                        <button class="calendar-today-btn" onclick="goToToday()">Today</button>
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">
                            <span>‚Ä∫</span>
                        </button>
                    </div>
                    <div class="calendar-date-display" id="calendarDateDisplay">
                        NOVEMBER 2025
                    </div>
                    <div class="calendar-view-selector">
                        <button class="view-btn active" id="viewMonth" onclick="switchView('month')">Month</button>
                        <button class="view-btn" id="viewWeek" onclick="switchView('week')">Week</button>
                        <button class="view-btn" id="viewDay" onclick="switchView('day')">Day</button>
                        <button class="view-btn" id="viewList" onclick="switchView('list')">List</button>
                    </div>
                </div>

                <!-- Calendar Month View -->
                <div class="calendar-view" id="calendarMonthView" style="display: none;">
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">Sun</div>
                        <div class="calendar-weekday">Mon</div>
                        <div class="calendar-weekday">Tue</div>
                        <div class="calendar-weekday">Wed</div>
                        <div class="calendar-weekday">Thu</div>
                        <div class="calendar-weekday">Fri</div>
                        <div class="calendar-weekday">Sat</div>
                    </div>
                    <div class="calendar-grid" id="calendarMonthGrid">
                        <!-- Calendar days will be populated here -->
                    </div>
                </div>

                <!-- Calendar Week View -->
                <div class="calendar-view" id="calendarWeekView" style="display: none;">
                    <div class="calendar-week-header">
                        <div class="calendar-week-time-column"></div>
                        <div class="calendar-week-days" id="calendarWeekDays">
                            <!-- Week days will be populated here -->
                        </div>
                    </div>
                    <div class="calendar-week-body">
                        <div class="calendar-week-time-column">
                            <!-- Time slots will be populated here -->
                        </div>
                        <div class="calendar-week-grid" id="calendarWeekGrid">
                            <!-- Week grid will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Calendar Day View -->
                <div class="calendar-view" id="calendarDayView" style="display: none;">
                    <div class="calendar-day-header" id="calendarDayHeader">
                        <!-- Day header will be populated here -->
                    </div>
                    <div class="calendar-day-body">
                        <div class="calendar-day-time-column">
                            <!-- Time slots will be populated here -->
                        </div>
                        <div class="calendar-day-grid" id="calendarDayGrid">
                            <!-- Day grid will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- List View (Existing Grid View) -->
                <div class="calendar-view" id="calendarListView">
                    <!-- Filter and Sort Section -->
                    <div class="filter-section">
                    <div class="filter-row">
                        <input type="text" class="filter-input" id="ticketFilter" placeholder="Search tickets..." onkeyup="filterTickets()">
                        <select class="filter-select" id="sortTickets" onchange="sortTickets()">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="client">Company Name (A-Z)</option>
                            <option value="type">Ticket Type</option>
                            <option value="status">Status</option>
                        </select>
                        <select class="filter-select" id="filterStatus" onchange="filterTickets()">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <select class="filter-select" id="filterType" onchange="filterTickets()">
                            <option value="">All Types</option>
                            <option value="corrective">Corrective</option>
                            <option value="preventive">Preventive</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    <div class="results-count" id="ticketResultsCount"></div>
                </div>

                <!-- Tickets Grid -->
                <div class="tickets-grid" id="ticketsGrid">
                    <!-- Tickets will be populated here -->
                </div>

                <!-- Pagination -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <div class="pagination-info" id="paginationInfo"></div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="paginationPrev" onclick="changePage(-1)">Previous</button>
                        <div class="pagination-page-numbers" id="paginationNumbers"></div>
                        <button class="pagination-btn" id="paginationNext" onclick="changePage(1)">Next</button>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">üé´</div>
                    <h3>No tickets found</h3>
                    <p>Try adjusting your filters</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Create New Ticket Modal -->
    <div class="modal-overlay" id="createTicketModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Create New Ticket</h3>
                <button class="close-btn" onclick="window.closeCreateTicketModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Wizard Steps -->
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1" onclick="goToTicketStep(1)">
                        <div class="step-number">1</div>
                        <div class="step-title">Customer Info</div>
                    </div>
                    <div class="wizard-step" data-step="2" onclick="goToTicketStep(2)">
                        <div class="step-number">2</div>
                        <div class="step-title">Ticket Info</div>
                    </div>
                    <div class="wizard-step" data-step="3" onclick="goToTicketStep(3)">
                        <div class="step-number">3</div>
                        <div class="step-title">Service Info</div>
                    </div>
                    <div class="wizard-step" data-step="4" onclick="goToTicketStep(4)">
                        <div class="step-number">4</div>
                        <div class="step-title">Tools</div>
                    </div>
                </div>

                <!-- Section 1: Customer Info -->
                <div class="wizard-section active" id="ticketSection1">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Customer Information</h4>
                    
                    <div class="form-group">
                        <label class="form-label form-group-required">Company Name</label>
                        <select class="form-input" id="ticketClientName" required onchange="handleTicketClientChange()">
                            <option value="">Select Company</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label form-group-required">Contract Reference</label>
                        <select class="form-input" id="ticketContractReference" required onchange="handleTicketContractChange()">
                            <option value="">Select Contract Reference</option>
                        </select>
                    </div>

                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Branch</label>
                            <select class="form-input" id="ticketBranch" required onchange="handleTicketBranchChange()">
                                <option value="">Select Branch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Zone</label>
                            <select class="form-input" id="ticketZone" required>
                                <option value="">Select Zone</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <div class="location-map-container" id="ticketLocationMapContainer">
                            <div class="location-map-placeholder">
                                <span id="ticketLocationMapText">No location defined</span>
                            </div>
                        </div>
                        <a href="#" class="edit-location-link" id="ticketEditLocationLink" onclick="editTicketCustomerLocation(); return false;" style="display: none;">
                            Edit Customer Profile Map Location
                        </a>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location Description</label>
                        <textarea class="form-input form-textarea" id="ticketLocationDescription" readonly rows="3"></textarea>
                    </div>
                </div>

                <!-- Section 2: Ticket Info -->
                <div class="wizard-section" id="ticketSection2">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Ticket Information</h4>
                    
                    <div class="form-group">
                        <label class="form-label form-group-required">Ticket Type</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="ticketTypeCorrective" name="ticketType" value="corrective" required onchange="handleTicketTypeChange()">
                                <label for="ticketTypeCorrective">Corrective</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="ticketTypePreventive" name="ticketType" value="preventive" required onchange="handleTicketTypeChange()">
                                <label for="ticketTypePreventive">Preventive</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label form-group-required">Ticket Category</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="ticketCategoryScheduled" name="ticketCategory" value="scheduled" required onchange="handleTicketCategoryChange()">
                                <label for="ticketCategoryScheduled">Scheduled</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="ticketCategoryEmergency" name="ticketCategory" value="emergency" required onchange="handleTicketCategoryChange()">
                                <label for="ticketCategoryEmergency">Emergency</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label form-group-required">Ticket Status</label>
                        <select class="form-input" id="ticketStatus" required>
                            <option value="">Select Status</option>
                            <option value="Pending">Pending</option>
                            <option value="In-Progress">In-Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Reschedule">Reschedule</option>
                            <option value="Cancel">Cancel</option>
                        </select>
                    </div>

                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Ticket Date</label>
                            <input type="date" class="form-input" id="ticketDate" required onchange="updateTicketTechnicianAvailability()">
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Ticket Time</label>
                            <select class="form-input" id="ticketTime" required onchange="updateTicketTechnicianAvailability()">
                                <option value="">Select Time</option>
                                <option value="8-10">8:00 - 10:00</option>
                                <option value="10-12">10:00 - 12:00</option>
                                <option value="12-14">12:00 - 14:00</option>
                                <option value="14-16">14:00 - 16:00</option>
                                <option value="16-18">16:00 - 18:00</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group-row">
                        <div class="form-group">
                            <label class="form-label form-group-required">Assign To Team Leader</label>
                            <select class="form-input" id="ticketTeamLeader" required>
                                <option value="">Select Team Leader</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-group-required">Assign To Technician</label>
                            <select class="form-input" id="ticketTechnician" required>
                                <option value="">Select Technician</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ticket Description</label>
                        <textarea class="form-input form-textarea" id="ticketDescription" rows="3" placeholder="Add any additional information about the ticket"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ticket Attachments</label>
                        <input type="file" class="form-input" id="ticketAttachments" multiple>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 6px;">Optional: upload related documents or images (multiple files supported)</small>
                    </div>
                </div>

                <!-- Section 3: Service Info -->
                <div class="wizard-section" id="ticketSection3">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Service Information</h4>
                    <div class="form-group">
                        <label class="form-label">Having a Female Engineer</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="ticketFemaleEngineer" onchange="updateTicketFemaleEngineerLabel()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="color: #374151; font-size: 14px;" id="ticketFemaleEngineerLabel">Off</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required">Main Service</label>
                        <select class="form-input" id="ticketMainService" onchange="handleTicketMainServiceChange()">
                            <option value="">-- Select Category --</option>
                        </select>
                    </div>
                    <div id="ticketSubServicesContainer" class="sub-services-container">
                        <p style="color: #6b7280; font-size: 14px;">Select a main service to view available sub services.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Service Description</label>
                        <textarea class="form-input form-textarea" id="ticketServiceDescription" rows="3" placeholder="Describe the service requirements"></textarea>
                    </div>
                </div>

                <!-- Section 4: Tools -->
                <div class="wizard-section" id="ticketSection4">
                    <h4 style="margin-bottom: 20px; color: #E67E00;">Tools</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Search Tools</label>
                        <input type="text" class="form-input" id="toolsSearch" placeholder="Search for tools..." onkeyup="filterTools()">
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <div class="tools-container" id="toolsContainer">
                            <!-- Tools will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <button class="btn-secondary" id="ticketPrevBtn" onclick="prevTicketStep()" style="display: none;">Previous</button>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-secondary" onclick="window.closeCreateTicketModal()">Cancel</button>
                        <button type="button" class="btn-primary" id="ticketNextBtn" onclick="nextTicketStep()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div class="timeline-modal" id="timelineModal">
        <div class="timeline-content">
            <div class="timeline-header">
                <h3>Ticket Timeline</h3>
                <button class="close-btn" onclick="closeTimeline()">&times;</button>
            </div>
            <div class="timeline-body" id="timelineBody">
                <!-- Timeline items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Update By Technician Modal -->
    <div class="modal-overlay" id="updateByTechnicianModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Update By Technician</h3>
                <button class="close-btn" onclick="closeUpdateByTechnicianModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="updateByTechnicianForm">
                    <div class="form-group">
                        <label class="form-label form-group-required">Ticket Status</label>
                        <select class="form-input" id="updateTicketStatus" required onchange="handleStatusChange()">
                            <option value="">Select Status</option>
                            <option value="Pending">Pending</option>
                            <option value="In-Progress">In-Progress</option>
                            <option value="Cancel">Cancel</option>
                        </select>
                        <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
                            <span id="statusNote">Note: Select a status</span>
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note</label>
                        <textarea class="form-input form-textarea" id="updateTicketNote" rows="4" placeholder="Enter note (optional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeUpdateByTechnicianModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveTechnicianUpdate()">Save</button>
            </div>
        </div>
    </div>

    <!-- Additional Work Modal -->
    <div class="modal-overlay" id="additionalWorkModal">
        <div class="modal-content" style="max-width: 1100px; width: 95%;">
            <div class="modal-header">
                <h3>Additional Work</h3>
                <button class="close-btn" onclick="closeAdditionalWorkModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="additionalWorkForm">
                    <div class="form-group">
                        <label class="form-label form-group-required">Title</label>
                        <input type="text" class="form-input" id="additionalWorkTitle" required placeholder="Enter title">
                    </div>
                    <div class="form-group">
                        <label class="form-label form-group-required">Description</label>
                        <textarea class="form-input form-textarea" id="additionalWorkDescription" rows="6" required placeholder="Enter description"></textarea>
                    </div>
                </form>
                
                <!-- Additional Work List -->
                <div class="additional-work-list">
                    <div class="additional-work-list-header">
                        <div>Name</div>
                        <div>Status</div>
                        <div>Proposal File</div>
                        <div>Submitted Date Time</div>
                    </div>
                    <div class="additional-work-list-body" id="additionalWorkListBody">
                        <!-- Items will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeAdditionalWorkModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="submitAdditionalWork()">Submit</button>
            </div>
        </div>
    </div>

    <script>
        // Sample data - in production, this would come from APIs/localStorage
        let companies = [];
        let individuals = [];
        let technicians = [];
        let wefixTechnicians = [];
        let ticketProcesses = [];
        const defaultTicketTimeOptions = [
            { value: '8-10', label: '8:00 - 10:00' },
            { value: '10-12', label: '10:00 - 12:00' },
            { value: '12-14', label: '12:00 - 14:00' },
            { value: '14-16', label: '14:00 - 16:00' },
            { value: '16-18', label: '16:00 - 18:00' }
        ];
        const emergencyTicketTimeOption = { value: 'response-90-120', label: 'Response Time: 90-120 min' };
        const serviceCategories = {
            '-- Select Category --': { subServices: [] },
            'Electrical Works': {
                subServices: [
                    { id: 'electrical-inspection', title: 'General electrical maintenance', price: 25, tickets: 1 },
                    { id: 'electrical-lighting', title: 'Lighting installation and replacement', price: 30, tickets: 1 },
                    { id: 'electrical-panel', title: 'Distribution board inspection', price: 35, tickets: 1 }
                ]
            },
            'Camera Service': {
                subServices: [
                    { id: 'camera-installation', title: 'Install new camera', price: 30, tickets: 1 },
                    { id: 'camera-maintenance', title: 'Camera maintenance visit', price: 25, tickets: 1 },
                    { id: 'camera-upgrade', title: 'Upgrade existing camera system', price: 45, tickets: 1 }
                ]
            },
            'Smart Home': {
                subServices: [
                    { id: 'smarthome-audit', title: 'Smart home system audit', price: 40, tickets: 1 },
                    { id: 'smarthome-install', title: 'Install smart home device', price: 35, tickets: 1 },
                    { id: 'smarthome-troubleshoot', title: 'Troubleshoot smart home circuit', price: 30, tickets: 1 }
                ]
            },
            'Fit out and Decoration Works': {
                subServices: [
                    { id: 'fitout-repair', title: 'Repair decorative fixtures', price: 25, tickets: 1 },
                    { id: 'fitout-paint', title: 'Touch-up painting service', price: 30, tickets: 1 },
                    { id: 'fitout-upgrade', title: 'Interior decoration upgrade', price: 50, tickets: 2 }
                ]
            },
            'Interior Design': {
                subServices: [
                    { id: 'interior-consult', title: 'Interior design consultation', price: 45, tickets: 1 },
                    { id: 'interior-layout', title: 'Layout planning session', price: 40, tickets: 1 },
                    { id: 'interior-materials', title: 'Material selection assistance', price: 35, tickets: 1 }
                ]
            },
            'Water heaters and boilers': {
                subServices: [
                    { id: 'waterheater-inspection', title: 'Inspect water heater/boiler', price: 25, tickets: 1 },
                    { id: 'waterheater-install', title: 'Install new water heater', price: 45, tickets: 1 },
                    { id: 'waterheater-maintenance', title: 'Scheduled maintenance visit', price: 30, tickets: 1 }
                ]
            },
            'Sewage and water system': {
                subServices: [
                    { id: 'sewage-cleaning', title: 'Drain and sewage cleaning', price: 35, tickets: 1 },
                    { id: 'sewage-leak', title: 'Leak detection and repair', price: 40, tickets: 1 },
                    { id: 'sewage-pump', title: 'Pump maintenance', price: 30, tickets: 1 }
                ]
            },
            'Sink, shower and wash closet (WC)': {
                subServices: [
                    { id: 'bathroom-fix', title: 'Fix leaking sink or shower', price: 25, tickets: 1 },
                    { id: 'bathroom-install', title: 'Install new faucet or WC', price: 35, tickets: 1 },
                    { id: 'bathroom-upgrade', title: 'Bathroom fixture upgrade', price: 45, tickets: 1 }
                ]
            },
            'Water pumps': {
                subServices: [
                    { id: 'pump-inspection', title: 'Water pump inspection', price: 25, tickets: 1 },
                    { id: 'pump-install', title: 'Install new water pump', price: 45, tickets: 1 },
                    { id: 'pump-relocation', title: 'Relocate existing pump', price: 30, tickets: 1 }
                ]
            },
            'Water Tanks': {
                subServices: [
                    { id: 'water-inspection', title: 'Inspection of water tanks, external connections, float valves, and pumps', price: 25, tickets: 1 },
                    { id: 'water-new-point', title: 'Installation of a new water point', price: 25, tickets: 1 },
                    { id: 'water-new-tank', title: 'Installation of a new water tank', price: 25, tickets: 1 },
                    { id: 'water-relocation', title: 'Relocation of a water tank', price: 30, tickets: 1 },
                    { id: 'water-solar-heater', title: 'Inspection of solar water heater', price: 25, tickets: 1 }
                ]
            },
            'Central air conditioning': {
                subServices: [
                    { id: 'hvac-inspection', title: 'HVAC system inspection', price: 35, tickets: 1 },
                    { id: 'hvac-maintenance', title: 'Routine AC maintenance', price: 30, tickets: 1 },
                    { id: 'hvac-repair', title: 'Emergency AC repair', price: 45, tickets: 1 }
                ]
            },
            'Split AC': {
                subServices: [
                    { id: 'split-ac-cleaning', title: 'Split AC deep cleaning', price: 25, tickets: 1 },
                    { id: 'split-ac-install', title: 'Install new split AC unit', price: 50, tickets: 1 },
                    { id: 'split-ac-gas', title: 'Gas refill and pressure check', price: 30, tickets: 1 }
                ]
            },
            'Ventilation and exhaust fans': {
                subServices: [
                    { id: 'ventilation-clean', title: 'Clean ventilation ducts', price: 30, tickets: 1 },
                    { id: 'ventilation-install', title: 'Install exhaust fan', price: 25, tickets: 1 },
                    { id: 'ventilation-repair', title: 'Repair exhaust fan', price: 20, tickets: 1 }
                ]
            },
            'Water filters': {
                subServices: [
                    { id: 'filter-replacement', title: 'Replace water filter cartridges', price: 20, tickets: 1 },
                    { id: 'filter-install', title: 'Install water filtration system', price: 45, tickets: 1 },
                    { id: 'filter-maintenance', title: 'Scheduled filter maintenance', price: 25, tickets: 1 }
                ]
            },
            'All-in-one technician for 3 hours': {
                subServices: [
                    { id: 'allinone-general', title: 'General handyman service (3 hours)', price: 60, tickets: 1 },
                    { id: 'allinone-electric', title: 'Electrical & plumbing combo visit', price: 70, tickets: 1 }
                ]
            },
            'Electrical Appliance Installation Works: Includes up to 3 hours of work per request': {
                subServices: [
                    { id: 'appliance-install', title: 'Install household appliance', price: 45, tickets: 1 },
                    { id: 'appliance-relocate', title: 'Relocate existing appliance', price: 35, tickets: 1 }
                ]
            },
            'Painting and Wallpapering Works': {
                subServices: [
                    { id: 'painting-touchup', title: 'Interior touch-up painting', price: 30, tickets: 1 },
                    { id: 'painting-feature', title: 'Feature wall painting', price: 40, tickets: 1 },
                    { id: 'wallpaper-install', title: 'Wallpaper installation', price: 35, tickets: 1 }
                ]
            },
            'Windows and Doors': {
                subServices: [
                    { id: 'windows-maintenance', title: 'Window maintenance visit', price: 25, tickets: 1 },
                    { id: 'doors-install', title: 'Install interior door', price: 45, tickets: 1 },
                    { id: 'doors-lock', title: 'Repair door lock mechanism', price: 20, tickets: 1 }
                ]
            }
        };

        // Load data from localStorage or initialize with sample data
        function initializeData() {
            // Load companies
            try {
                const storedCompanies = localStorage.getItem('wefixCompanies');
                if (storedCompanies) {
                    companies = JSON.parse(storedCompanies);
                } else {
                    // Sample companies
                    companies = [
                        { id: '1', title: 'TechCorp Solutions', nameEn: 'TechCorp Solutions' },
                        { id: '2', title: 'Global Services Inc', nameEn: 'Global Services Inc' },
                        { id: '3', title: 'Premier Industries', nameEn: 'Premier Industries' }
                    ];
                }
            } catch (error) {
                console.error('Error loading companies:', error);
            }

            // Load individuals
            try {
                const storedIndividuals = localStorage.getItem('wefixIndividuals');
                if (storedIndividuals) {
                    individuals = JSON.parse(storedIndividuals);
                } else {
                    // Sample individuals
                    individuals = [
                        { id: '1', name: 'John Doe' },
                        { id: '2', name: 'Jane Smith' },
                        { id: '3', name: 'Mike Johnson' }
                    ];
                }
            } catch (error) {
                console.error('Error loading individuals:', error);
            }

            // Sample WeFix technicians
            wefixTechnicians = [
                { id: 'wf1', name: 'Ahmed Al-Mansoori', category: 'Electrical' },
                { id: 'wf2', name: 'Mohammed Hassan', category: 'Plumbing' },
                { id: 'wf3', name: 'Fatima Ali', category: 'General', isFemale: true },
                { id: 'wf4', name: 'Omar Khaled', category: 'HVAC' }
            ];

            // Sample technicians for companies (would be loaded from company data)
            technicians = {
                '1': [
                    { id: 't1', name: 'Technician A', category: 'Electrical' },
                    { id: 't2', name: 'Technician B', category: 'Plumbing' }
                ],
                '2': [
                    { id: 't3', name: 'Technician C', category: 'General' },
                    { id: 't4', name: 'Technician D', category: 'HVAC' }
                ],
                '3': [
                    { id: 't5', name: 'Technician E', category: 'Electrical' }
                ]
            };

            // Sample ticket processes
            ticketProcesses = [
                { id: '1', name: 'Initial Assessment' },
                { id: '2', name: 'Diagnosis' },
                { id: '3', name: 'Repair' },
                { id: '4', name: 'Follow-up' }
            ];
        }

        // Wizard Step Navigation
        let ticketCurrentStep = 1;
        const ticketTotalSteps = 4;
        
        // Tools list
        const toolsList = [
            'Clamp Meter 600A AC',
            'Screw driver Set 6 Pcs',
            'Plier Cutter',
            'Allen Keys Star 9 Pcs',
            'Nose Plier 2 PCs',
            'Socket wrench 2 Pcs',
            'Rubber hammer',
            'Spirit Level',
            'Cordless Pressure washer',
            'Electrical wire pulling spring',
            'Drill Hammer',
            'Vacuum Machine',
            'Battery 5 A',
            'Trolly box',
            'Shock wave bit 56 Pcs',
            'Dust Extractor',
            'Water quality Tester',
            'Ratchet and Wrench Set 216 Pcs',
            'Clamp Meter 600A AC-DC',
            'Pliers Set 3 Pcs',
            'Oil Kettle',
            'Adjustable Wrench 3 Pcs',
            'Digital Caliper',
            'Plump Line',
            'Silicon gun',
            'Pressing pliers',
            'Tester Screw Driver',
            'Heat Gun',
            'Drill Brushless Hammer',
            'Drain Cleaner',
            'Battery charger',
            'Hex jaw plier',
            'Drill set 8 Pcs',
            'Iron saw',
            'Earth Tester',
            'Ladder 2.7 Meter',
            'Temp. & Humidity Meter',
            'Utility cutter',
            'Allen Keys Hex 9 Pcs',
            'Measuring tape',
            'Scrapers 3 Pcs',
            'Iron hammer',
            'Crowbar',
            'Water Pressure cage',
            'Electrical wire pulling spring Soft',
            'Wire Stripper',
            'Air Blower',
            'Battery 2 A',
            'Tool Bag',
            'Right Angle attachment',
            'SDS Bit (6,10,12,14)mm',
            'TDS Device',
            'Wall Humidity Detector'
        ];

        function getCheckedRadioValue(groupName) {
            const checked = document.querySelector(`input[name="${groupName}"]:checked`);
            return checked ? checked.value : '';
        }

        function getSelectTextById(id) {
            const selectEl = document.getElementById(id);
            if (selectEl && selectEl.selectedOptions && selectEl.selectedOptions.length > 0) {
                return selectEl.selectedOptions[0].textContent || '';
            }
            return '';
        }

        function getElementValueById(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }

        function isCheckboxChecked(id) {
            const el = document.getElementById(id);
            return !!(el && el.checked);
        }

        function getTicketDateString(ticket) {
            if (ticket.ticketDate) {
                return ticket.ticketDate;
            }
            if (ticket.createdAt && ticket.createdAt.indexOf('T') !== -1) {
                return ticket.createdAt.split('T')[0];
            }
            return ticket.createdAt || '';
        }

        function isTicketStepDisabled(stepNumber) {
            const stepEl = document.querySelector(`.wizard-step[data-step="${stepNumber}"]`);
            return stepEl ? stepEl.classList.contains('disabled') : false;
        }

        function setTicketWizardStepDisabled(stepNumber, disabled) {
            const stepEl = document.querySelector(`.wizard-step[data-step="${stepNumber}"]`);
            if (!stepEl) return;
            if (disabled) {
                stepEl.classList.add('disabled');
            } else {
                stepEl.classList.remove('disabled');
            }
        }

        function setServiceAndToolsDisabled(disabled) {
            [3, 4].forEach(step => setTicketWizardStepDisabled(step, disabled));
        }

        function resetServiceInfoSection() {
            const mainServiceSelect = document.getElementById('ticketMainService');
            const subServicesContainer = document.getElementById('ticketSubServicesContainer');
            if (mainServiceSelect) {
                mainServiceSelect.value = '';
            }
            if (subServicesContainer) {
                subServicesContainer.innerHTML = '<p style="color: #6b7280; font-size: 14px;">Select a main service to view available sub services.</p>';
            }
            const femaleEngineerToggle = document.getElementById('ticketFemaleEngineer');
            const femaleEngineerLabel = document.getElementById('ticketFemaleEngineerLabel');
            if (femaleEngineerToggle) femaleEngineerToggle.checked = false;
            if (femaleEngineerLabel) femaleEngineerLabel.textContent = 'Off';
            const serviceDescriptionInput = document.getElementById('ticketServiceDescription');
            if (serviceDescriptionInput) serviceDescriptionInput.value = '';
        }

        function populateTicketMainServiceOptions() {
            const select = document.getElementById('ticketMainService');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '';
            Object.keys(serviceCategories).forEach(category => {
                const option = document.createElement('option');
                option.value = category === '-- Select Category --' ? '' : category;
                option.textContent = category;
                select.appendChild(option);
            });
            if (currentValue && serviceCategories[currentValue]) {
                select.value = currentValue;
            }
        }

        function renderTicketSubServices(mainService, preselectedIds = []) {
            const container = document.getElementById('ticketSubServicesContainer');
            if (!container) return;

            container.innerHTML = '';

            if (!mainService || !serviceCategories[mainService] || serviceCategories[mainService].subServices.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; font-size: 14px;">No sub services available for this category.</p>';
                return;
            }

            const selectedSet = new Set(preselectedIds);

            serviceCategories[mainService].subServices.forEach(subService => {
                const card = document.createElement('label');
                card.className = 'sub-service-card';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'ticket-sub-service-checkbox';
                checkbox.value = subService.id;
                checkbox.checked = selectedSet.has(subService.id);
                checkbox.dataset.title = subService.title;
                checkbox.dataset.price = subService.price;
                checkbox.dataset.tickets = subService.tickets;

                const header = document.createElement('div');
                header.className = 'sub-service-header';

                header.appendChild(checkbox);

                const titleEl = document.createElement('div');
                titleEl.innerHTML = `<div style="font-weight: 600; color: #1f2937;">${subService.title}</div>`;
                header.appendChild(titleEl);

                const meta = document.createElement('div');
                meta.className = 'sub-service-meta';
                meta.innerHTML = `<span class="sub-service-price">${subService.price} JOD</span><span class="sub-service-badge">Num Of Tickets : ${subService.tickets}</span>`;

                card.appendChild(header);
                card.appendChild(meta);

                container.appendChild(card);
            });
        }

        function handleTicketMainServiceChange(preselectedIds) {
            const select = document.getElementById('ticketMainService');
            if (!select) return;
            const value = select.value;
            const ids = Array.isArray(preselectedIds) ? preselectedIds : [];
            if (!value) {
                renderTicketSubServices('', []);
            } else {
                renderTicketSubServices(value, ids);
            }
        }

        function populateTicketTimeOptions(options, selectedValue) {
            const select = document.getElementById('ticketTime');
            if (!select) return;
            const currentValue = typeof selectedValue !== 'undefined' ? selectedValue : select.value;
            select.innerHTML = '<option value="">Select Time</option>';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;
                select.appendChild(opt);
            });
            if (options.some(option => option.value === currentValue)) {
                select.value = currentValue;
            } else if (options.length === 1) {
                select.value = options[0].value;
            } else {
                select.value = '';
            }
        }

        function setTicketDateToToday(disabled) {
            const dateInput = document.getElementById('ticketDate');
            if (!dateInput) return;
            if (disabled) {
                const today = new Date();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const value = `${today.getFullYear()}-${month}-${day}`;
                dateInput.value = value;
                dateInput.disabled = true;
            } else {
                dateInput.disabled = false;
            }
        }

        function handleTicketCategoryChange() {
            const categoryEl = document.querySelector('input[name="ticketCategory"]:checked');
            const category = categoryEl ? categoryEl.value : '';
            if (category === 'emergency') {
                setTicketDateToToday(true);
                populateTicketTimeOptions([emergencyTicketTimeOption], emergencyTicketTimeOption.value);
            } else {
                setTicketDateToToday(false);
                populateTicketTimeOptions(defaultTicketTimeOptions);
            }
            updateTicketTechnicianAvailability();
        }

        function handleTicketTypeChange() {
            const typeEl = document.querySelector('input[name="ticketType"]:checked');
            const type = typeEl ? typeEl.value : '';
            const emergencyRadio = document.getElementById('ticketCategoryEmergency');
            const scheduledRadio = document.getElementById('ticketCategoryScheduled');

            if (type === 'preventive') {
                if (emergencyRadio) {
                    emergencyRadio.checked = false;
                    emergencyRadio.disabled = true;
                }
                if (scheduledRadio) {
                    scheduledRadio.checked = true;
                }
                handleTicketCategoryChange();
                setServiceAndToolsDisabled(true);
                if (ticketCurrentStep > 2) {
                    ticketCurrentStep = 2;
                    updateTicketWizardUI();
                }
            } else {
                if (emergencyRadio) {
                    emergencyRadio.disabled = false;
                }
                setServiceAndToolsDisabled(false);
            }
        }

        function goToTicketStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= ticketTotalSteps) {
                if (isTicketStepDisabled(stepNumber)) {
                    return;
                }
                ticketCurrentStep = stepNumber;
                updateTicketWizardUI();
            }
        }

        function nextTicketStep() {
            if (validateCurrentTicketStep()) {
                let nextStep = ticketCurrentStep + 1;
                while (nextStep <= ticketTotalSteps && isTicketStepDisabled(nextStep)) {
                    nextStep++;
                }
                if (nextStep > ticketTotalSteps) {
                    saveTicket();
                } else {
                    ticketCurrentStep = nextStep;
                    updateTicketWizardUI();
                }
            }
        }

        function prevTicketStep() {
            if (ticketCurrentStep > 1) {
                let prevStep = ticketCurrentStep - 1;
                while (prevStep >= 1 && isTicketStepDisabled(prevStep)) {
                    prevStep--;
                }
                if (prevStep >= 1) {
                    ticketCurrentStep = prevStep;
                    updateTicketWizardUI();
                }
            }
        }

        function updateTicketWizardUI() {
            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum < ticketCurrentStep) {
                    step.classList.add('completed');
                } else if (stepNum === ticketCurrentStep) {
                    step.classList.add('active');
                }
            });

            // Update sections
            document.querySelectorAll('.wizard-section').forEach((section, index) => {
                section.classList.remove('active');
                if (index + 1 === ticketCurrentStep) {
                    section.classList.add('active');
                    // Load tools if we're on step 4
                    if (ticketCurrentStep === 4 && section.id === 'ticketSection4') {
                        loadTools();
                    }
                }
            });

            // Update buttons
            const prevBtn = document.getElementById('ticketPrevBtn');
            const nextBtn = document.getElementById('ticketNextBtn');

            prevBtn.style.display = ticketCurrentStep === 1 ? 'none' : 'block';
            let nextAvailableStep = ticketCurrentStep + 1;
            while (nextAvailableStep <= ticketTotalSteps && isTicketStepDisabled(nextAvailableStep)) {
                nextAvailableStep++;
            }
            if (nextAvailableStep > ticketTotalSteps || ticketCurrentStep === ticketTotalSteps) {
                nextBtn.textContent = currentEditTicketId ? 'Save' : 'Save';
            } else {
                nextBtn.textContent = 'Next';
            }
        }

        function validateCurrentTicketStep() {
            if (ticketCurrentStep === 1) {
                // Validate Customer Info
                const clientName = document.getElementById('ticketClientName').value;
                const contractRef = document.getElementById('ticketContractReference').value;
                const branch = document.getElementById('ticketBranch').value;
                const zone = document.getElementById('ticketZone').value;

                if (!clientName) {
                    showTicketValidationError('ticketClientName', 'Please select Company Name');
                    return false;
                }
                if (!contractRef) {
                    showTicketValidationError('ticketContractReference', 'Please select Contract Reference');
                    return false;
                }
                if (!branch) {
                    showTicketValidationError('ticketBranch', 'Please select Branch');
                    return false;
                }
                if (!zone) {
                    showTicketValidationError('ticketZone', 'Please select Zone');
                    return false;
                }
            } else if (ticketCurrentStep === 2) {
                // Validate Ticket Info
                const ticketType = getCheckedRadioValue('ticketType');
                const ticketStatus = document.getElementById('ticketStatus').value;
                const ticketDate = document.getElementById('ticketDate').value;
                const ticketTime = document.getElementById('ticketTime').value;
                const teamLeader = document.getElementById('ticketTeamLeader').value;
                const technician = document.getElementById('ticketTechnician').value;
                let ticketCategory = getCheckedRadioValue('ticketCategory');
                if (ticketCategory === 'later') {
                    ticketCategory = 'scheduled';
                }

                if (!ticketType) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Validation Error',
                        text: 'Please select a Ticket Type',
                        confirmButtonColor: '#E67E00'
                    });
                    return false;
                }
                if (!ticketCategory) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Validation Error',
                        text: 'Please select a Ticket Category',
                        confirmButtonColor: '#E67E00'
                    });
                    return false;
                }
                if (ticketType === 'preventive' && ticketCategory === 'emergency') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Validation Error',
                        text: 'Emergency category is not allowed for Preventive tickets',
                        confirmButtonColor: '#E67E00'
                    });
                    return false;
                }
                if (!ticketStatus) {
                    showTicketValidationError('ticketStatus', 'Please select Ticket Status');
                    return false;
                }
                if (!ticketDate) {
                    showTicketValidationError('ticketDate', 'Please select Ticket Date');
                    return false;
                }
                if (!ticketTime) {
                    showTicketValidationError('ticketTime', 'Please select Ticket Time');
                    return false;
                }
                if (!teamLeader) {
                    showTicketValidationError('ticketTeamLeader', 'Please select Team Leader');
                    return false;
                }
                if (!technician) {
                    showTicketValidationError('ticketTechnician', 'Please select Technician');
                    return false;
                }
            } else if (ticketCurrentStep === 3) {
                const mainService = getElementValueById('ticketMainService');
                const selectedSubServices = getSelectedSubServiceIds();
                if (!mainService) {
                    showTicketValidationError('ticketMainService', 'Please select Main Service');
                    return false;
                }
                if (selectedSubServices.length === 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Validation Error',
                        text: 'Please select at least one Sub Service',
                        confirmButtonColor: '#E67E00'
                    });
                    return false;
                }
            } else if (ticketCurrentStep === 4) {
                // Tools section - no validation required, optional
            }
            return true;
        }

        function showTicketValidationError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.borderColor = '#EF4444';
                element.style.borderWidth = '2px';
                element.focus();
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: message,
                    confirmButtonColor: '#E67E00'
                });
                setTimeout(() => {
                    element.style.borderColor = '';
                    element.style.borderWidth = '';
                }, 3000);
            }
        }

        // Handle Client Name change
        window.handleTicketClientChange = function() {
            const clientId = document.getElementById('ticketClientName').value;
            loadTicketContracts(clientId);
            loadTicketBranches(clientId);
            loadTicketTeamLeaders();
            loadTicketTechnicians();
            updateTicketLocation();
        };
        
        // Load sample data when company is selected or on modal open
        function loadTicketSampleData() {
            const companyId = document.getElementById('ticketClientName').value;
            
            // Load contracts
            loadTicketContracts(companyId);
            
            // Load branches
            loadTicketBranches(companyId);
            
            // Load zones (if branch is already selected)
            const branchId = document.getElementById('ticketBranch').value;
            if (branchId) {
                loadTicketZones(branchId);
            } else {
                loadTicketZones(null);
            }
            
            // Load team leaders
            loadTicketTeamLeaders();
            
            // Load technicians
            loadTicketTechnicians();
        }

        // Handle Contract Reference change
        window.handleTicketContractChange = function() {
            // Can add logic here if needed
        };

        // Handle Branch change
        window.handleTicketBranchChange = function() {
            const branchId = document.getElementById('ticketBranch').value;
            loadTicketZones(branchId);
            updateTicketLocation();
        };

        // Load companies into Company Name dropdown
        function loadTicketCompanies() {
            const clientSelect = document.getElementById('ticketClientName');
            clientSelect.innerHTML = '<option value="">Select Company</option>';
            
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.title || company.nameEn || company.nameAr || '';
                clientSelect.appendChild(option);
            });
        }

        // Load contracts for selected company
        function loadTicketContracts(companyId) {
            const contractSelect = document.getElementById('ticketContractReference');
            contractSelect.innerHTML = '<option value="">Select Contract Reference</option>';
            
            // Sample contract references
            const sampleContracts = [
                'CNT-0001',
                'CNT-0002',
                'CNT-0003',
                'CNT-0004',
                'CNT-0005'
            ];
            
            if (companyId) {
                const company = companies.find(c => c.id === companyId);
                if (company) {
                    // Get contracts from company
                    if (company.contracts && Array.isArray(company.contracts)) {
                        company.contracts.forEach(contract => {
                            const option = document.createElement('option');
                            const ref = contract.reference || contract.number || (contract.title ? contract.title : '');
                            option.value = ref;
                            option.textContent = ref;
                            contractSelect.appendChild(option);
                        });
                    }
                    
                    // Also check main contract
                    if (company.contractNumber) {
                        const option = document.createElement('option');
                        option.value = company.contractNumber;
                        option.textContent = company.contractNumber;
                        contractSelect.appendChild(option);
                    }
                }
            }
            
            // Add sample contracts if no company contracts found or always show samples
            if (contractSelect.options.length <= 1) {
                sampleContracts.forEach(contractRef => {
                    const option = document.createElement('option');
                    option.value = contractRef;
                    option.textContent = contractRef;
                    contractSelect.appendChild(option);
                });
            }
        }

        // Load branches for selected company
        function loadTicketBranches(companyId) {
            const branchSelect = document.getElementById('ticketBranch');
            branchSelect.innerHTML = '<option value="">Select Branch</option>';
            
            // Sample branches
            const sampleBranches = [
                { id: 'branch_1', name: 'Main Branch - Amman' },
                { id: 'branch_2', name: 'Branch - Irbid' },
                { id: 'branch_3', name: 'Branch - Zarqa' },
                { id: 'branch_4', name: 'Branch - Aqaba' },
                { id: 'branch_5', name: 'Branch - Madaba' }
            ];
            
            if (companyId) {
                const company = companies.find(c => c.id === companyId);
                if (company) {
                    // Get branches from company
                    if (company.branches && Array.isArray(company.branches)) {
                        company.branches.forEach((branch, index) => {
                            const option = document.createElement('option');
                            option.value = branch.id || `branch_${index}`;
                            option.textContent = branch.title || branch.nameEn || branch.nameAr || `Branch ${index + 1}`;
                            branchSelect.appendChild(option);
                        });
                    }
                }
            }
            
            // Add sample branches if no company branches found or always show samples
            if (branchSelect.options.length <= 1) {
                sampleBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    branchSelect.appendChild(option);
                });
            }
        }

        // Load zones for selected branch
        function loadTicketZones(branchId) {
            const zoneSelect = document.getElementById('ticketZone');
            zoneSelect.innerHTML = '<option value="">Select Zone</option>';
            
            // Sample zones
            const sampleZones = [
                { id: 'zone_1', name: 'Zone 1 - North' },
                { id: 'zone_2', name: 'Zone 2 - South' },
                { id: 'zone_3', name: 'Zone 3 - East' },
                { id: 'zone_4', name: 'Zone 4 - West' },
                { id: 'zone_5', name: 'Zone 5 - Central' },
                { id: 'zone_6', name: 'Zone 6 - Industrial' }
            ];
            
            const companyId = document.getElementById('ticketClientName').value;
            
            if (companyId) {
                const company = companies.find(c => c.id === companyId);
                if (company && company.zones) {
                    // Get zones from company (zones are company-level, not branch-level)
                    company.zones.forEach((zone, index) => {
                        const option = document.createElement('option');
                        option.value = zone.id || `zone_${index}`;
                        option.textContent = zone.title || zone.number || `Zone ${index + 1}`;
                        zoneSelect.appendChild(option);
                    });
                }
            }
            
            // Add sample zones if no company zones found or always show samples
            if (zoneSelect.options.length <= 1) {
                sampleZones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone.id;
                    option.textContent = zone.name;
                    zoneSelect.appendChild(option);
                });
            }
        }

        // Load team leaders for selected branch/company
        function loadTicketTeamLeaders() {
            const teamLeaderSelect = document.getElementById('ticketTeamLeader');
            teamLeaderSelect.innerHTML = '<option value="">Select Team Leader</option>';
            
            // Sample team leaders
            const sampleTeamLeaders = [
                'Ahmad Al-Mousa',
                'Mohammed Al-Hashimi',
                'Omar Al-Zahawi',
                'Khalid Al-Rashid',
                'Yousef Al-Mansouri',
                'Ali Al-Douri',
                'Hassan Al-Najjar',
                'Sami Al-Khatib'
            ];
            
            const companyId = document.getElementById('ticketClientName').value;
            const branchId = document.getElementById('ticketBranch').value;
            
            if (companyId) {
                const company = companies.find(c => c.id === companyId);
                if (company) {
                    // Get team leaders from company
                    if (company.teamLeaders && Array.isArray(company.teamLeaders)) {
                        company.teamLeaders.forEach(tl => {
                            const option = document.createElement('option');
                            option.value = tl.id || tl.name;
                            option.textContent = tl.name || tl.nameEn || tl.nameAr || 'Team Leader';
                            teamLeaderSelect.appendChild(option);
                        });
                    }
                    
                    // Also check branchTeamLeader if available
                    if (company.branchTeamLeader) {
                        const option = document.createElement('option');
                        option.value = company.branchTeamLeader;
                        option.textContent = company.branchTeamLeader;
                        teamLeaderSelect.appendChild(option);
                    }
                }
            }
            
            // Add sample team leaders if no company team leaders found or always show samples
            if (teamLeaderSelect.options.length <= 1) {
                sampleTeamLeaders.forEach(tl => {
                    const option = document.createElement('option');
                    option.value = tl;
                    option.textContent = tl;
                    teamLeaderSelect.appendChild(option);
                });
            }
        }

        // Update team leaders when branch changes
        window.handleTicketBranchChange = function() {
            const branchId = document.getElementById('ticketBranch').value;
            loadTicketZones(branchId);
            loadTicketTeamLeaders();
            updateTicketLocation();
        };

        // Load technicians for selected team leader
        function loadTicketTechnicians() {
            const technicianSelect = document.getElementById('ticketTechnician');
            technicianSelect.innerHTML = '<option value="">Select Technician</option>';
            
            const companyId = document.getElementById('ticketClientName').value;
            
            // Sample technicians
            const sampleTechnicians = [
                { id: 'tech_1', name: 'Ahmed Al-Mansoori', category: 'Electrical' },
                { id: 'tech_2', name: 'Mohammed Hassan', category: 'Plumbing' },
                { id: 'tech_3', name: 'Fatima Ali', category: 'General', isFemale: true },
                { id: 'tech_4', name: 'Omar Khaled', category: 'HVAC' },
                { id: 'tech_5', name: 'Khalid Ibrahim', category: 'Electrical' },
                { id: 'tech_6', name: 'Yousef Salem', category: 'Plumbing' },
                { id: 'tech_7', name: 'Noor Al-Hashimi', category: 'General', isFemale: true },
                { id: 'tech_8', name: 'Samer Al-Douri', category: 'HVAC' },
                { id: 'tech_9', name: 'Rami Al-Khatib', category: 'Electrical' },
                { id: 'tech_10', name: 'Hani Al-Najjar', category: 'Civil' }
            ];
            
            // Use sample technicians if wefixTechnicians is empty or add both
            let techList = [];
            if (wefixTechnicians && wefixTechnicians.length > 0) {
                techList = wefixTechnicians;
            } else {
                techList = sampleTechnicians;
            }
            
            // Add sample technicians
            sampleTechnicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name + (tech.category ? ` (${tech.category})` : '');
                if (tech.isFemale) {
                    option.setAttribute('data-female', 'true');
                }
                technicianSelect.appendChild(option);
            });
            
            updateTicketTechnicianAvailability();
        }

        // Update technician availability based on date and time
        window.updateTicketTechnicianAvailability = function() {
            const date = document.getElementById('ticketDate').value;
            const time = document.getElementById('ticketTime').value;
            const femaleEngineerEl = document.getElementById('ticketFemaleEngineer');
            const femaleEngineer = femaleEngineerEl ? femaleEngineerEl.checked : false;
            const technicianSelect = document.getElementById('ticketTechnician');
            
            if (!date || !time) return;

            // Simulate unavailable technicians (in production, this would check actual schedules)
            const unavailableTechs = getUnavailableTechnicians(date, time);
            
            Array.from(technicianSelect.options).forEach(option => {
                if (option.value) {
                    // Filter by female engineer requirement
                    if (femaleEngineer && !option.hasAttribute('data-female')) {
                        option.style.display = 'none';
                    } else {
                        option.style.display = '';
                    }
                    
                    // Mark unavailable
                    if (unavailableTechs.includes(option.value)) {
                        option.disabled = true;
                        option.style.color = '#9ca3af';
                        if (!option.textContent.includes('(Unavailable)')) {
                            option.textContent += ' (Unavailable)';
                        }
                    } else {
                        option.disabled = false;
                        option.style.color = '#374151';
                        option.textContent = option.textContent.replace(' (Unavailable)', '');
                    }
                }
            });
        };

        // Update Sub Service based on Main Service
        window.updateTicketSubService = function() {
            const mainServiceSelect = document.getElementById('ticketMainService');
            const subServiceSelect = document.getElementById('ticketSubService');
            if (!mainServiceSelect || !subServiceSelect) return;

            const mainService = mainServiceSelect.value;
            
            subServiceSelect.innerHTML = '<option value="">Select Sub Service</option>';
            
            if (!mainService) return;
            
            // Sub-services mapping (same as in companies.html)
            const subServicesMap = {
                'ÿßŸÑÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©': [
                    'ÿ•ÿµŸÑÿßÿ≠ ÿ£Ÿà ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©ÿå ÿ£ÿ®ÿßÿ±Ÿäÿ≤ ŸàŸÉÿ®ÿ≥',
                    'ÿ™ÿ±ŸÉŸäÿ® ÿ£Ÿà ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ Ÿàÿ≠ÿØÿßÿ™ ÿßŸÑÿ•ŸÜÿßÿ±ÿ©',
                    'ÿµŸäÿßŸÜÿ© ÿßŸÑŸÑŸàÿ≠ÿßÿ™ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©',
                    'ÿµŸäÿßŸÜÿ© ŸÇŸàÿßÿ∑ÿπ ŸÉŸáÿ±ÿ®ÿßÿ°',
                    'ÿ™ŸÖÿØŸäÿØ ŸÜŸÇÿ∑ÿ© ÿ£ÿ±ÿ∂Ÿä ÿ¨ÿØŸäÿØÿ©',
                    'ÿ™ŸÖÿØŸäÿØ ŸÜŸÇÿ∑ÿ© ŸÉŸáÿ±ÿ®ÿßÿ° ÿ£Ÿà ÿ£ÿ®ÿßÿ±Ÿäÿ≤ ÿ¨ÿØŸäÿØÿ©',
                    'ÿ£ÿπŸÖÿßŸÑ ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ© ÿ£ÿÆÿ±Ÿâ'
                ],
                'ÿ£ÿπŸÖÿßŸÑ ŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ© Ÿàÿµÿ≠Ÿäÿ©': [
                    'ÿµŸäÿßŸÜÿ© ÿ£Ÿà ÿ•ÿµŸÑÿßÿ≠ ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÖŸäÿßŸá ŸàÿßŸÑŸÖŸäÿßŸá ŸàŸÖŸäÿßŸá ÿßŸÑÿµÿ±ŸÅ',
                    'ÿµŸäÿßŸÜÿ© ŸÖÿ∂ÿÆÿßÿ™ ÿØŸàÿ±ÿßÿ™ ÿßŸÑŸÖŸäÿßŸá',
                    'ÿ£ÿπŸÖÿßŸÑ ÿµŸäÿßŸÜÿ© Ÿàÿ™ÿ±ŸÉŸäÿ® ÿßŸÑÿ≥ÿÆÿßŸÜÿßÿ™',
                    'ÿµŸäÿßŸÜÿ© ŸàÿÆÿ∑Ÿäÿßÿ™ ÿÆÿ≤ÿßŸÜÿßÿ™ ÿßŸÑŸÖÿßÿ° ŸàÿßŸÑÿ™ŸàÿµŸäŸÑÿßÿ™ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ© ŸàÿßŸÑÿ≠ŸàÿßŸÖÿßÿ™ ŸàÿßŸÑŸÖŸÜÿ∏ŸÅÿßÿ™',
                    'ÿ£ÿπŸÖÿßŸÑ ÿµÿ≠Ÿäÿ© ŸàŸÖŸäŸÉÿßŸÜŸäŸÉŸäÿ© ÿ£ÿÆÿ±Ÿâ'
                ],
                'ÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÖÿØŸÜŸä': [
                    'ÿ£ÿπŸÖÿßŸÑ ÿßŸÑÿØŸáÿßŸÜÿßÿ™ ŸàŸàÿ±ŸÇ ÿßŸÑÿ¨ÿØÿ±ÿßŸÜ',
                    'ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑÿ±ÿ∑Ÿàÿ®ÿ© ŸàÿßŸÑÿπŸÅŸàŸÜÿ©',
                    'ÿßŸÑÿπÿ≤ŸÑ ÿßŸÑÿØÿßÿÆŸÑŸä ŸàÿßŸÑÿÆÿßÿ±ÿ¨Ÿä',
                    'ÿµŸäÿßŸÜÿ© ÿßŸÑŸÜŸàÿßŸÅÿ∞ ŸàÿßŸÑÿ£ÿ®Ÿàÿßÿ®',
                    'ÿ£ÿπŸÖÿßŸÑ ŸÖÿØŸÜŸäÿ© ÿ£ÿÆÿ±Ÿâ'
                ],
                'ÿ£ÿπŸÖÿßŸÑ ÿßŸÑÿ™ŸáŸàŸäÿ© ŸàÿßŸÑÿ™ŸÉŸäŸäŸÅ': [
                    'ÿµŸäÿßŸÜÿ© Ÿàÿ≠ÿØÿßÿ™ ÿßŸÑÿ™ŸÉŸäŸäŸÅ ÿßŸÑÿØÿßÿÆŸÑŸäÿ© (ÿ≥ÿ®ŸÑÿ™)',
                    'ÿµŸäÿßŸÜÿ© Ÿàÿ≠ÿØÿßÿ™ ÿßŸÑÿ™ŸÉŸäŸäŸÅ ÿßŸÑŸÖÿ±ŸÉÿ≤Ÿäÿ©',
                    'ÿµŸäÿßŸÜÿ© ÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑÿ™ŸáŸàŸäÿ© Ÿàÿ™ÿ¥ŸÅÿßÿ∑ÿßÿ™',
                    'ÿ™ÿ®ÿØŸäŸÑ ŸÅŸÑÿßÿ™ÿ± ÿßŸÑŸáŸàÿßÿ°',
                    'ÿ£ÿπŸÖÿßŸÑ ÿ™ŸÉŸäŸäŸÅ ÿ£ÿÆÿ±Ÿâ'
                ],
                'ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™': [
                    'ÿµŸäÿßŸÜÿ© ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™',
                    'ÿ™ÿ±ŸÉŸäÿ® ŸÉÿßŸÖŸäÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ÿ∞ŸÉŸäÿ© ÿ£Ÿà ÿπÿßÿØŸäÿ©'
                ],
                'ÿµŸäÿßŸÜÿ© ÿ£ÿπŸÖÿßŸÑ ÿßŸÑÿ™ÿµŸÖŸäŸÖ ŸàÿßŸÑÿØŸäŸÉŸàÿ±': [
                    'ÿµŸäÿßŸÜÿ© ÿ£ÿπŸÖÿßŸÑ ÿßŸÑÿ™ÿµŸÖŸäŸÖ ŸàÿßŸÑÿØŸäŸÉŸàÿ±'
                ]
            };
            
            if (subServicesMap[mainService]) {
                subServicesMap[mainService].forEach(subService => {
                    const option = document.createElement('option');
                    option.value = subService;
                    option.textContent = subService;
                    subServiceSelect.appendChild(option);
                });
            }
        };

        // Toggle Materials Section based on Business Model
        // Get unavailable technicians for a given date and time
        function getUnavailableTechnicians(date, time) {
            // This is a simulation - in production, check actual schedules
            // For demo purposes, randomly mark some as unavailable
            const unavailable = [];
            const techSelect = document.getElementById('ticketTechnician');
            if (!techSelect) return unavailable;
            const techOptions = techSelect.options;
            
            // Simulate: mark every 3rd technician as unavailable
            for (let i = 1; i < techOptions.length; i++) {
                if (i % 3 === 0) {
                    unavailable.push(techOptions[i].value);
                }
            }
            
            return unavailable;
        }

        // Update ticket location information
        function updateTicketLocation() {
            const companyId = document.getElementById('ticketClientName').value;
            const branchId = document.getElementById('ticketBranch').value;
            const zoneId = document.getElementById('ticketZone').value;
            
            const locationMapText = document.getElementById('ticketLocationMapText');
            const editLocationLink = document.getElementById('ticketEditLocationLink');
            const locationDescription = document.getElementById('ticketLocationDescription');

            if (!companyId) {
                locationMapText.textContent = 'No location defined';
                editLocationLink.style.display = 'none';
                locationDescription.value = '';
                return;
            }

            const company = companies.find(c => c.id === companyId);
            if (!company) {
                locationMapText.textContent = 'No location defined';
                editLocationLink.style.display = 'none';
                locationDescription.value = '';
                return;
            }

            // Get location from company or branch
            let address = company.hoAddress || '123 Main Street, Amman, Jordan';
            let description = company.hoAddress || 'Company headquarters location';
            
            // If branch is selected, can add branch-specific location logic here
            
            locationMapText.textContent = `üìç ${address}`;
            locationDescription.value = description;
            editLocationLink.style.display = 'inline';
        }

        // Edit customer location
        window.editTicketCustomerLocation = function() {
            Swal.fire({
                title: 'Edit Location',
                text: 'This will open the customer profile page to edit the map location.',
                icon: 'info',
                confirmButtonText: 'OK',
                confirmButtonColor: '#E67E00'
            });
        };

        // Open create ticket modal
        window.openCreateTicketModal = function() {
            const modal = document.getElementById('createTicketModal');
            if (!modal) {
                console.error('Create Ticket modal element not found');
                return;
            }

            modal.classList.add('active');
            modal.style.display = 'flex';

            console.log('Opening Create Ticket modal');

            try {
                if (!currentEditTicketId) {
                    currentEditTicketId = null;
                }

                // Reset wizard and UI state
                ticketCurrentStep = 1;
                setServiceAndToolsDisabled(false);

                // Reset Ticket Type & Category defaults
                Array.from(document.querySelectorAll('input[name="ticketType"]')).forEach(radio => {
                    radio.checked = false;
                });
                Array.from(document.querySelectorAll('input[name="ticketCategory"]')).forEach(radio => {
                    radio.checked = false;
                    radio.disabled = false;
                });
                const scheduledCategoryRadio = document.getElementById('ticketCategoryScheduled');
                if (scheduledCategoryRadio) {
                    scheduledCategoryRadio.checked = true;
                }
                handleTicketCategoryChange();
                handleTicketTypeChange();

                // Reset form fields
                const clientSelect = document.getElementById('ticketClientName');
                const contractSelect = document.getElementById('ticketContractReference');
                const branchSelect = document.getElementById('ticketBranch');
                const zoneSelect = document.getElementById('ticketZone');
                const dateInput = document.getElementById('ticketDate');
                const timeSelect = document.getElementById('ticketTime');
                const teamLeaderSelect = document.getElementById('ticketTeamLeader');
                const technicianSelect = document.getElementById('ticketTechnician');
                const descriptionInput = document.getElementById('ticketDescription');
                const attachmentsInput = document.getElementById('ticketAttachments');

                if (clientSelect) clientSelect.value = '';
                if (contractSelect) contractSelect.innerHTML = '<option value="">Select Contract Reference</option>';
                if (branchSelect) branchSelect.innerHTML = '<option value="">Select Branch</option>';
                if (zoneSelect) zoneSelect.innerHTML = '<option value="">Select Zone</option>';
                if (dateInput) {
                    dateInput.value = '';
                    dateInput.disabled = false;
                }
                populateTicketTimeOptions(defaultTicketTimeOptions);
                if (timeSelect) timeSelect.value = '';
                if (teamLeaderSelect) teamLeaderSelect.innerHTML = '<option value="">Select Team Leader</option>';
                if (technicianSelect) technicianSelect.innerHTML = '<option value="">Select Technician</option>';
                if (descriptionInput) descriptionInput.value = '';
                if (attachmentsInput) attachmentsInput.value = '';

                const ticketStatus = document.getElementById('ticketStatus');
                if (ticketStatus) ticketStatus.value = '';

                resetServiceInfoSection();

                const toolsSearch = document.getElementById('toolsSearch');
                if (toolsSearch) toolsSearch.value = '';
                const toolsContainer = document.getElementById('toolsContainer');
                if (toolsContainer) {
                    loadTools();
                    Array.from(toolsContainer.querySelectorAll('input[type="checkbox"]')).forEach(cb => cb.checked = false);
                }

                const locationMapText = document.getElementById('ticketLocationMapText');
                const editLocationLink = document.getElementById('ticketEditLocationLink');
                const locationDescription = document.getElementById('ticketLocationDescription');
                if (locationMapText) locationMapText.textContent = 'No location defined';
                if (editLocationLink) editLocationLink.style.display = 'none';
                if (locationDescription) locationDescription.value = '';

            populateTicketMainServiceOptions();
            renderTicketSubServices('', []);

                loadTicketCompanies();
                loadTicketSampleData();
                updateTicketWizardUI();
            } catch (error) {
                console.error('Error while opening Create Ticket modal:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Something went wrong',
                    text: 'We could not open the Create Ticket wizard. Please refresh and try again.',
                    confirmButtonColor: '#E67E00'
                });
            }
        };
        
        // Load Tools into the container
        function loadTools() {
            const container = document.getElementById('toolsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            toolsList.forEach((tool, index) => {
                const toolId = 'tool_' + index;
                const toolItem = document.createElement('div');
                toolItem.className = 'tool-checkbox-item';
                toolItem.setAttribute('data-tool-name', tool.toLowerCase());
                toolItem.setAttribute('data-tool-index', index);
                toolItem.innerHTML = `
                    <input type="checkbox" id="${toolId}" name="tools" value="${tool}" onchange="handleToolCheckboxChange(this)">
                    <label for="${toolId}">${tool}</label>
                `;
                container.appendChild(toolItem);
            });
        }
        
        // Handle tool checkbox change - move checked items to top
        window.handleToolCheckboxChange = function(checkbox) {
            const container = document.getElementById('toolsContainer');
            if (!container) return;
            
            const toolItem = checkbox.closest('.tool-checkbox-item');
            if (!toolItem) return;
            
            if (checkbox.checked) {
                // Move to top
                container.insertBefore(toolItem, container.firstChild);
            } else {
                // Move back to position (after all checked items)
                const allItems = Array.from(container.querySelectorAll('.tool-checkbox-item'));
                const checkedItems = allItems.filter(item => item.querySelector('input[type="checkbox"]').checked);
                const uncheckedItems = allItems.filter(item => !item.querySelector('input[type="checkbox"]').checked);
                
                // Reorder: checked first, then unchecked in original order
                container.innerHTML = '';
                
                // Add checked items first
                checkedItems.forEach(item => {
                    container.appendChild(item);
                });
                
                // Add unchecked items in original order
                uncheckedItems.sort((a, b) => {
                    const indexA = parseInt(a.getAttribute('data-tool-index'));
                    const indexB = parseInt(b.getAttribute('data-tool-index'));
                    return indexA - indexB;
                });
                uncheckedItems.forEach(item => {
                    container.appendChild(item);
                });
            }
            
            // Update search filter if active
            const searchTerm = document.getElementById('toolsSearch').value;
            if (searchTerm) {
                filterTools();
            }
        };
        
        // Filter tools based on search
        window.filterTools = function() {
            const searchTerm = document.getElementById('toolsSearch').value.toLowerCase();
            const container = document.getElementById('toolsContainer');
            if (!container) return;
            
            const allItems = Array.from(container.querySelectorAll('.tool-checkbox-item'));
            
            // Separate checked and unchecked items
            const checkedItems = allItems.filter(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                return checkbox && checkbox.checked;
            });
            
            const uncheckedItems = allItems.filter(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                return !checkbox || !checkbox.checked;
            });
            
            // Filter both groups
            const filteredChecked = checkedItems.filter(item => {
                const toolName = item.getAttribute('data-tool-name');
                return toolName.includes(searchTerm);
            });
            
            const filteredUnchecked = uncheckedItems.filter(item => {
                const toolName = item.getAttribute('data-tool-name');
                return toolName.includes(searchTerm);
            });
            
            // Hide all items first
            allItems.forEach(item => {
                item.classList.add('hidden');
            });
            
            // Show filtered checked items first, then filtered unchecked items
            filteredChecked.forEach(item => {
                item.classList.remove('hidden');
            });
            
            filteredUnchecked.forEach(item => {
                item.classList.remove('hidden');
            });
            
            // Reorder visible items: checked first, then unchecked in original order
            const visibleChecked = filteredChecked;
            const visibleUnchecked = filteredUnchecked.sort((a, b) => {
                const indexA = parseInt(a.getAttribute('data-tool-index'));
                const indexB = parseInt(b.getAttribute('data-tool-index'));
                return indexA - indexB;
            });
            
            // Clear and rebuild in correct order
            container.innerHTML = '';
            visibleChecked.forEach(item => container.appendChild(item));
            visibleUnchecked.forEach(item => container.appendChild(item));
        };

        // Close create ticket modal
        window.closeCreateTicketModal = function() {
            const modal = document.getElementById('createTicketModal');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
            }
            // Reset edit mode
            currentEditTicketId = null;
            const descriptionInput = document.getElementById('ticketDescription');
            if (descriptionInput) descriptionInput.value = '';
            const attachmentsInput = document.getElementById('ticketAttachments');
            if (attachmentsInput) attachmentsInput.value = '';
            resetServiceInfoSection();
        };

        // Save ticket
        window.saveTicket = function() {
            // Final validation
            if (!validateCurrentTicketStep()) {
                return;
            }

            // Collect ticket data
            const companyId = document.getElementById('ticketClientName').value;
            const company = companies.find(c => c.id === companyId);
            
            // Collect selected materials (not used currently)
            const selectedMaterials = [];
            
            // Collect selected tools
            const selectedTools = [];
            document.querySelectorAll('#toolsContainer input[type="checkbox"]:checked').forEach(cb => {
                selectedTools.push(cb.value);
            });

            const descriptionInput = document.getElementById('ticketDescription');
            const attachmentsInput = document.getElementById('ticketAttachments');
            const ticketDescription = descriptionInput ? descriptionInput.value.trim() : '';
            const ticketAttachments = attachmentsInput ? Array.from(attachmentsInput.files).map(file => file.name) : [];
            const mainServiceValue = getElementValueById('ticketMainService');
            const selectedSubServices = getSelectedSubServiceIds();
            const femaleEngineerValue = isCheckboxChecked('ticketFemaleEngineer');
            const serviceDescriptionInput = document.getElementById('ticketServiceDescription');
            const serviceDescriptionValue = serviceDescriptionInput ? serviceDescriptionInput.value.trim() : '';
            const subServiceDetails = getSubServiceDetailsByIds(mainServiceValue, selectedSubServices);

            // Check if editing existing ticket
            if (currentEditTicketId) {
                // Update existing ticket
                const ticketIndex = allTickets.findIndex(t => t.id === currentEditTicketId);
                if (ticketIndex === -1) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Ticket not found',
                        confirmButtonColor: '#E67E00'
                    });
                    return;
                }
                
                const existingTicket = allTickets[ticketIndex];
                
                // Update ticket data
                existingTicket.clientId = companyId;
                existingTicket.clientName = company ? (company.title || company.nameEn || company.nameAr) : existingTicket.clientName;
                existingTicket.contractReference = document.getElementById('ticketContractReference').value;
                existingTicket.branchId = document.getElementById('ticketBranch').value;
                existingTicket.branch = getSelectTextById('ticketBranch') || existingTicket.branch;
                existingTicket.zoneId = document.getElementById('ticketZone').value;
                existingTicket.zone = getSelectTextById('ticketZone') || existingTicket.zone;
                existingTicket.ticketType = getCheckedRadioValue('ticketType') || existingTicket.ticketType;
                const selectedCategory = getCheckedRadioValue('ticketCategory');
                if (selectedCategory) {
                    existingTicket.ticketCategory = selectedCategory;
                } else if (existingTicket.ticketCategory === 'later') {
                    existingTicket.ticketCategory = 'scheduled';
                }
                existingTicket.status = document.getElementById('ticketStatus').value;
                existingTicket.ticketDate = document.getElementById('ticketDate').value;
                existingTicket.ticketTime = document.getElementById('ticketTime').value;
                existingTicket.teamLeader = document.getElementById('ticketTeamLeader').value;
                existingTicket.teamLeaderName = getSelectTextById('ticketTeamLeader') || existingTicket.teamLeaderName;
                existingTicket.assignedTechnician = document.getElementById('ticketTechnician').value;
                existingTicket.technicianName = getSelectTextById('ticketTechnician') || existingTicket.technicianName;
                existingTicket.technician = existingTicket.technicianName || existingTicket.assignedTechnician;
                existingTicket.mainService = mainServiceValue;
                existingTicket.subServices = selectedSubServices;
                existingTicket.femaleEngineer = femaleEngineerValue;
                existingTicket.serviceDescription = serviceDescriptionValue;
                existingTicket.subServiceDetails = subServiceDetails;
                existingTicket.materials = selectedMaterials;
                existingTicket.tools = selectedTools;
                existingTicket.location = document.getElementById('ticketLocationDescription').value || '';
                existingTicket.description = ticketDescription;
                existingTicket.attachments = ticketAttachments.length > 0 ? ticketAttachments : (existingTicket.attachments || []);
                
                // Save to localStorage
                try {
                    localStorage.setItem('wefixTickets', JSON.stringify(allTickets));
                    
                    // Refresh ticket list
                    filteredTickets = [...allTickets];
                    currentPage = 1;
                    sortTickets();
                } catch (error) {
                    console.error('Error updating ticket:', error);
                }
                
                // Reset edit mode
                currentEditTicketId = null;
                
                // Close modal
                window.closeCreateTicketModal();

                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Ticket Updated!',
                    text: 'Ticket has been updated successfully',
                    confirmButtonColor: '#E67E00',
                    timer: 3000,
                    timerProgressBar: true
                });
            } else {
                // Create new ticket
                const ticketData = {
                    id: 'TKT' + Date.now(),
                    customerType: 'Company', // Always Company in new wizard
                    clientId: companyId,
                    clientName: company ? (company.title || company.nameEn || company.nameAr) : '',
                    contractReference: document.getElementById('ticketContractReference').value,
                    branchId: document.getElementById('ticketBranch').value,
                    branch: getSelectTextById('ticketBranch'),
                    zoneId: document.getElementById('ticketZone').value,
                    zone: getSelectTextById('ticketZone'),
                    ticketType: getCheckedRadioValue('ticketType'),
                    ticketCategory: getCheckedRadioValue('ticketCategory') || 'scheduled',
                    status: document.getElementById('ticketStatus').value,
                    ticketDate: document.getElementById('ticketDate').value,
                    ticketTime: document.getElementById('ticketTime').value,
                    teamLeader: document.getElementById('ticketTeamLeader').value,
                    teamLeaderName: getSelectTextById('ticketTeamLeader'),
                    assignedTechnician: document.getElementById('ticketTechnician').value,
                    technicianName: getSelectTextById('ticketTechnician'),
                    technician: getSelectTextById('ticketTechnician'),
                    mainService: mainServiceValue,
                    subServices: selectedSubServices,
                    femaleEngineer: femaleEngineerValue,
                    businessModel: getCheckedRadioValue('ticketBusinessModel') || '',
                    serviceDescription: serviceDescriptionValue,
                    subServiceDetails: subServiceDetails,
                    withMaterial: false,
                    materials: selectedMaterials,
                    tools: selectedTools,
                    location: document.getElementById('ticketLocationDescription').value || '',
                    description: ticketDescription,
                    attachments: ticketAttachments,
                    createdAt: new Date().toISOString()
                };

                // Save to localStorage (in production, send to API)
                try {
                    let tickets = JSON.parse(localStorage.getItem('wefixTickets') || '[]');
                    tickets.push(ticketData);
                    localStorage.setItem('wefixTickets', JSON.stringify(tickets));
                    
                    // Refresh ticket list
                    allTickets.push(ticketData);
                    filteredTickets = [...allTickets];
                    currentPage = 1;
                    sortTickets();
                } catch (error) {
                    console.error('Error saving ticket:', error);
                }

                // Close modal
                window.closeCreateTicketModal();

                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Ticket Created!',
                    text: 'Ticket has been created successfully',
                    confirmButtonColor: '#E67E00',
                    timer: 3000,
                    timerProgressBar: true
                });
            }
        };


        // Generate sample tickets data
        function generateSampleTickets() {
            const sampleTickets = [];
            const statuses = ['Pending', 'In Progress', 'Completed'];
            const types = ['corrective', 'preventive', 'emergency'];
            const clients = ['TechCorp Solutions', 'Global Services Inc', 'Premier Industries', 'Digital Solutions', 'Modern Tech Ltd'];
            const technicians = ['Ahmed Al-Mansoori', 'Mohammed Hassan', 'Fatima Ali', 'Omar Khaled', 'Khalid Ibrahim'];
            const teamLeaders = ['Ahmad Al-Mousa', 'Mohammed Al-Hashimi', 'Omar Al-Zahawi', 'Khalid Al-Rashid'];
            const serviceCategoryKeys = Object.keys(serviceCategories).filter(key => key && key !== '-- Select Category --' && serviceCategories[key].subServices && serviceCategories[key].subServices.length > 0);
            
            for (let i = 1; i <= 100; i++) {
                const createdDate = new Date();
                createdDate.setDate(createdDate.getDate() - Math.floor(Math.random() * 30));
                const createdTime = createdDate.toISOString();
                
                let pendingDate = null;
                let completedDate = null;
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                if (status !== 'Pending') {
                    pendingDate = new Date(createdDate);
                    pendingDate.setHours(pendingDate.getHours() + Math.floor(Math.random() * 48));
                }
                
                if (status === 'Completed') {
                    completedDate = new Date(createdDate);
                    completedDate.setHours(completedDate.getHours() + Math.floor(Math.random() * 72) + 24);
                }
                
                let inProgressDate = null;
                let inProgressBy = null;
                let inProgressByAvatar = null;
                
                // Select a technician for this ticket
                const selectedTechnician = technicians[Math.floor(Math.random() * technicians.length)];
                
                if (status === 'In Progress' || status === 'Completed') {
                    inProgressDate = new Date(createdDate);
                    inProgressDate.setHours(inProgressDate.getHours() + Math.floor(Math.random() * 24) + 12);
                    inProgressBy = selectedTechnician;
                    // Generate avatar from technician name initials
                    const nameParts = selectedTechnician.split(' ');
                    inProgressByAvatar = nameParts.length >= 2 
                        ? (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase()
                        : selectedTechnician.substring(0, 2).toUpperCase();
                }
                
                const selectedCategory = serviceCategoryKeys[Math.floor(Math.random() * serviceCategoryKeys.length)];
                const subServicePool = serviceCategories[selectedCategory].subServices || [];
                const selectedSubServices = subServicePool.length ? [subServicePool[Math.floor(Math.random() * subServicePool.length)].id] : [];
                const selectedSubServiceDetails = getSubServiceDetailsByIds(selectedCategory, selectedSubServices);
                const femaleEngineer = Math.random() > 0.6;
                const serviceDescription = `Service details for ticket #${i}`;
                
                sampleTickets.push({
                    id: 'TKT' + String(i).padStart(6, '0'),
                    customerType: 'Company',
                    clientName: clients[Math.floor(Math.random() * clients.length)],
                    contractReference: 'CNT-' + String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0'),
                    branch: 'Branch ' + String.fromCharCode(65 + Math.floor(Math.random() * 5)),
                    zone: 'Zone ' + (Math.floor(Math.random() * 6) + 1),
                    ticketType: types[Math.floor(Math.random() * types.length)],
                    ticketDate: createdDate.toISOString().split('T')[0],
                    ticketTime: ['8-10', '10-12', '12-14', '14-16', '16-18'][Math.floor(Math.random() * 5)],
                    teamLeader: teamLeaders[Math.floor(Math.random() * teamLeaders.length)],
                    technician: selectedTechnician,
                    mainService: selectedCategory,
                    subService: 'Repair Services',
                    status: status,
                    createdAt: createdTime,
                    createdBy: 'Admin User',
                    createdByAvatar: 'AU',
                    description: 'This is an auto-generated description for ticket #' + i,
                    attachments: [],
                    pendingAt: pendingDate ? pendingDate.toISOString() : null,
                    inProgressAt: inProgressDate ? inProgressDate.toISOString() : null,
                    inProgressBy: inProgressBy,
                    inProgressByAvatar: inProgressByAvatar,
                    completedAt: completedDate ? completedDate.toISOString() : null,
                    completedBy: status === 'Completed' ? 'Manager User' : null,
                    completedByAvatar: status === 'Completed' ? 'MU' : null,
                    subServiceDetails: selectedSubServiceDetails,
                    serviceDescription: serviceDescription,
                    femaleEngineer: femaleEngineer
                });
            }
            
            return sampleTickets;
        }

        // Display tickets in grid
        let allTickets = [];
        let filteredTickets = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        function displayTickets() {
            const grid = document.getElementById('ticketsGrid');
            const emptyState = document.getElementById('emptyState');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (filteredTickets.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                paginationContainer.style.display = 'none';
                document.getElementById('ticketResultsCount').textContent = '0 tickets found';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredTickets.length / itemsPerPage);
            
            // Reset to first page if current page is out of bounds
            if (currentPage > totalPages) {
                currentPage = 1;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTickets = filteredTickets.slice(startIndex, endIndex);
            
            grid.innerHTML = '';
            
            paginatedTickets.forEach(ticket => {
                const card = document.createElement('div');
                card.className = 'ticket-card';
                const statusValue = ticket.status || 'Pending';
                const statusClass = statusValue.toLowerCase().replace(/\s+/g, '-');
                card.innerHTML = `
                    <div class="ticket-card-header">
                        <div class="ticket-id">${ticket.id}</div>
                        <div class="ticket-status-badge status-${statusClass}">
                            ${statusValue}
                        </div>
                    </div>
                    <div class="ticket-info-grid">
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">Company</div>
                        <div class="ticket-info-value">${ticket.clientName || 'N/A'}</div>
                        </div>
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">Type</div>
                        <div class="ticket-info-value">${ticket.ticketType ? (ticket.ticketType.charAt(0).toUpperCase() + ticket.ticketType.slice(1)) : 'N/A'}</div>
                        </div>
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">Branch</div>
                        <div class="ticket-info-value">${ticket.branch || 'N/A'}</div>
                        </div>
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">Zone</div>
                        <div class="ticket-info-value">${ticket.zone || 'N/A'}</div>
                        </div>
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">Technician</div>
                        <div class="ticket-info-value">${ticket.technician || ticket.technicianName || 'Unassigned'}</div>
                        </div>
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">Date</div>
                        <div class="ticket-info-value">${ticket.createdAt ? new Date(ticket.createdAt).toLocaleDateString() : (ticket.ticketDate || '‚Äî')}</div>
                        </div>
                    </div>
                    <div class="ticket-actions">
                        <button class="btn-action btn-timeline" onclick="openTimeline('${ticket.id}')">Time Line</button>
                        <button class="btn-action btn-update" onclick="openUpdateByTechnicianModal('${ticket.id}')" id="updateBtn_${ticket.id}" style="display: none;">Update By Technician</button>
                        <button class="btn-action btn-additional-work" onclick="openAdditionalWorkModal('${ticket.id}')">Additional Work</button>
                        <button class="btn-action btn-edit" onclick="editTicket('${ticket.id}')">Edit</button>
                        <button class="btn-action btn-delete" onclick="deleteTicket('${ticket.id}')">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
                
                // Show Update button only for Technician users
                const updateBtn = document.getElementById(`updateBtn_${ticket.id}`);
                if (updateBtn) {
                    if (isTechnician()) {
                        updateBtn.style.display = 'inline-block';
                    } else {
                        updateBtn.style.display = 'none';
                    }
                }
            });
            
            document.getElementById('ticketResultsCount').textContent = `${filteredTickets.length} ticket${filteredTickets.length !== 1 ? 's' : ''} found`;
            
            // Update pagination UI
            updatePagination(totalPages);
        }

        // Update pagination controls
        function updatePagination(totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationPrev = document.getElementById('paginationPrev');
            const paginationNext = document.getElementById('paginationNext');
            const paginationNumbers = document.getElementById('paginationNumbers');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            // Update info
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredTickets.length);
            paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${filteredTickets.length} tickets`;
            
            // Update prev/next buttons
            paginationPrev.disabled = currentPage === 1;
            paginationNext.disabled = currentPage === totalPages;
            
            // Update page numbers
            paginationNumbers.innerHTML = '';
            
            // Show page numbers (max 5 visible)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // Adjust if near the beginning or end
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(5, totalPages);
                } else if (endPage === totalPages) {
                    startPage = Math.max(1, totalPages - 4);
                }
            }
            
            // First page
            if (startPage > 1) {
                const btn = document.createElement('button');
                btn.className = 'pagination-btn';
                btn.textContent = '1';
                btn.onclick = () => goToPage(1);
                paginationNumbers.appendChild(btn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px 4px';
                    paginationNumbers.appendChild(ellipsis);
                }
            }
            
            // Page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
                btn.textContent = i;
                btn.onclick = () => goToPage(i);
                paginationNumbers.appendChild(btn);
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px 4px';
                    paginationNumbers.appendChild(ellipsis);
                }
                
                const btn = document.createElement('button');
                btn.className = 'pagination-btn';
                btn.textContent = totalPages;
                btn.onclick = () => goToPage(totalPages);
                paginationNumbers.appendChild(btn);
            }
        }

        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredTickets.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayTickets();
                // Scroll to top of grid
                document.getElementById('ticketsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Go to specific page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredTickets.length / itemsPerPage);
            
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayTickets();
                // Scroll to top of grid
                document.getElementById('ticketsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Filter tickets
        function filterTickets() {
            const searchTerm = document.getElementById('ticketFilter').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const typeFilter = document.getElementById('filterType').value;
            
            filteredTickets = allTickets.filter(ticket => {
                const idValue = (ticket.id || '').toLowerCase();
                const clientValue = (ticket.clientName || '').toLowerCase();
                const contractValue = (ticket.contractReference || '').toLowerCase();
                const technicianValue = (ticket.technician || ticket.technicianName || '').toLowerCase();
                const matchesSearch = !searchTerm || 
                    idValue.includes(searchTerm) ||
                    clientValue.includes(searchTerm) ||
                    contractValue.includes(searchTerm) ||
                    technicianValue.includes(searchTerm);
                
                const matchesStatus = !statusFilter || ticket.status === statusFilter;
                const matchesType = !typeFilter || ticket.ticketType === typeFilter;
                
                return matchesSearch && matchesStatus && matchesType;
            });
            
            // Reset to first page when filtering
            currentPage = 1;
            sortTickets();
            
            // Refresh calendar views if active
            if (currentView === 'month') {
                renderMonthView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'day') {
                renderDayView();
            }
        }

        // Sort tickets
        function sortTickets() {
            const sortBy = document.getElementById('sortTickets').value;
            
            filteredTickets.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'oldest':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'client':
                        return (a.clientName || '').localeCompare(b.clientName || '');
                    case 'type':
                        return (a.ticketType || '').localeCompare(b.ticketType || '');
                    case 'status':
                        return (a.status || '').localeCompare(b.status || '');
                    default:
                        return 0;
                }
            });
            
            displayTickets();
        }

        // Open Timeline Modal
        function openTimeline(ticketId) {
            const ticket = allTickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            const modal = document.getElementById('timelineModal');
            const body = document.getElementById('timelineBody');
            
            const createdDate = new Date(ticket.createdAt);
            const pendingDate = ticket.pendingAt ? new Date(ticket.pendingAt) : null;
            const inProgressDate = ticket.inProgressAt ? new Date(ticket.inProgressAt) : null;
            const completedDate = ticket.completedAt ? new Date(ticket.completedAt) : null;
            
            body.innerHTML = `
                <!-- Created -->
                <div class="timeline-item">
                    <div class="timeline-avatar" title="${ticket.createdBy}">${ticket.createdByAvatar}</div>
                    <div class="timeline-content-box">
                        <div class="timeline-title">Created By</div>
                        <div class="timeline-subtitle">${ticket.createdBy}</div>
                        <div class="timeline-datetime">
                            <span>üìÖ</span>
                            <span>${createdDate.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                
                ${pendingDate ? `
                <!-- Pending -->
                <div class="timeline-item">
                    <div class="timeline-arrow">‚Üì</div>
                    <div class="timeline-content-box">
                        <div class="timeline-title">Status: Pending</div>
                        <div class="timeline-subtitle">Assigned to: ${ticket.technician}</div>
                        <div class="timeline-datetime">
                            <span>üìÖ</span>
                            <span>${pendingDate.toLocaleString()}</span>
                        </div>
                        <span class="timeline-status-badge status-pending">Pending</span>
                    </div>
                </div>
                ` : ''}
                
                ${inProgressDate ? `
                <!-- In Progress -->
                <div class="timeline-item">
                    <div class="timeline-arrow">‚Üì</div>
                    <div class="timeline-avatar" title="${ticket.inProgressBy || ticket.technician}">${ticket.inProgressByAvatar || 'T'}</div>
                    <div class="timeline-content-box">
                        <div class="timeline-title">Status: In Progress</div>
                        <div class="timeline-subtitle">Technician: ${ticket.inProgressBy || ticket.technician}</div>
                        <div class="timeline-datetime">
                            <span>üìÖ</span>
                            <span>${inProgressDate.toLocaleString()}</span>
                        </div>
                        <span class="timeline-status-badge status-in-progress">In Progress</span>
                    </div>
                </div>
                ` : ''}
                
                ${completedDate ? `
                <!-- Completed -->
                <div class="timeline-item">
                    <div class="timeline-arrow">‚Üì</div>
                    <div class="timeline-avatar" title="${ticket.completedBy}">${ticket.completedByAvatar}</div>
                    <div class="timeline-content-box">
                        <div class="timeline-title">Completed By</div>
                        <div class="timeline-subtitle">${ticket.completedBy}</div>
                        <div class="timeline-datetime">
                            <span>üìÖ</span>
                            <span>${completedDate.toLocaleString()}</span>
                        </div>
                        <span class="timeline-status-badge status-completed">Completed</span>
                    </div>
                </div>
                ` : ''}
            `;
            
            modal.classList.add('active');
        }

        // Close Timeline Modal
        function closeTimeline() {
            document.getElementById('timelineModal').classList.remove('active');
        }

        // Edit Ticket
        let currentEditTicketId = null;
        
        function editTicket(ticketId) {
            const ticket = allTickets.find(t => t.id === ticketId);
            if (!ticket) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ticket not found',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }
            
            currentEditTicketId = ticketId;
            
            // Open create modal and populate with ticket data
            window.openCreateTicketModal();
            
            // Populate form with ticket data
            setTimeout(() => {
                // Customer Info Section
                if (ticket.clientId) {
                    document.getElementById('ticketClientName').value = ticket.clientId;
                    handleTicketClientChange();
                    
                    // Wait for dropdowns to populate, then set values
                    setTimeout(() => {
                        if (ticket.contractReference) {
                            document.getElementById('ticketContractReference').value = ticket.contractReference;
                            handleTicketContractChange();
                        }
                        if (ticket.branchId) {
                            document.getElementById('ticketBranch').value = ticket.branchId;
                            handleTicketBranchChange();
                        }
                        if (ticket.zoneId) {
                            document.getElementById('ticketZone').value = ticket.zoneId;
                        }
                    }, 300);
                }
                
                // Ticket Info Section
                if (ticket.ticketType) {
                    const ticketTypeRadio = document.getElementById(`ticketType${ticket.ticketType.charAt(0).toUpperCase() + ticket.ticketType.slice(1)}`);
                    if (ticketTypeRadio) {
                        ticketTypeRadio.checked = true;
                    }
                }
                handleTicketTypeChange();

                let normalizedCategory = ticket.ticketCategory === 'later' ? 'scheduled' : ticket.ticketCategory;
                if (normalizedCategory) {
                    const categoryId = `ticketCategory${normalizedCategory.charAt(0).toUpperCase() + normalizedCategory.slice(1)}`;
                    const ticketCategoryRadio = document.getElementById(categoryId);
                    if (ticketCategoryRadio) {
                        ticketCategoryRadio.checked = true;
                    }
                } else if (document.getElementById('ticketCategoryScheduled')) {
                    document.getElementById('ticketCategoryScheduled').checked = true;
                }
                handleTicketCategoryChange();
                
                if (ticket.status) {
                    document.getElementById('ticketStatus').value = ticket.status;
                } else {
                    document.getElementById('ticketStatus').value = 'Pending';
                }
                
                if (ticket.ticketDate) {
                    document.getElementById('ticketDate').value = ticket.ticketDate;
                }
                
                if (ticket.ticketTime) {
                    document.getElementById('ticketTime').value = ticket.ticketTime;
                }
                
                if (ticket.teamLeader) {
                    setTimeout(() => {
                        document.getElementById('ticketTeamLeader').value = ticket.teamLeader;
                        updateTicketTechnicianAvailability();
                    }, 500);
                }
                
                if (ticket.assignedTechnician || ticket.technician) {
                    setTimeout(() => {
                        document.getElementById('ticketTechnician').value = ticket.assignedTechnician || ticket.technician;
                    }, 600);
                }
                
                
                // Tools Section
                if (ticket.tools && Array.isArray(ticket.tools)) {
                    ticket.tools.forEach(tool => {
                        const toolCheckbox = document.querySelector(`#toolsContainer input[value="${tool}"]`);
                        if (toolCheckbox) {
                            toolCheckbox.checked = true;
                            handleToolCheckboxChange(toolCheckbox);
                        }
                    });
                }
                
                // Location
                if (ticket.location) {
                    document.getElementById('ticketLocationDescription').value = ticket.location;
                }
                
                updateTicketLocation();

                // Service Info Section
                const mainServiceSelect = document.getElementById('ticketMainService');
                if (mainServiceSelect) {
                    mainServiceSelect.value = ticket.mainService || '';
                    handleTicketMainServiceChange(ticket.subServices || []);
                }

                const femaleEngineerToggle = document.getElementById('ticketFemaleEngineer');
                if (femaleEngineerToggle) {
                    femaleEngineerToggle.checked = !!ticket.femaleEngineer;
                    updateTicketFemaleEngineerLabel();
                }

                const serviceDescriptionInput = document.getElementById('ticketServiceDescription');
                if (serviceDescriptionInput) {
                    serviceDescriptionInput.value = ticket.serviceDescription || '';
                }

                const descriptionInput = document.getElementById('ticketDescription');
                if (descriptionInput) {
                    descriptionInput.value = ticket.description || '';
                }
                const attachmentsInput = document.getElementById('ticketAttachments');
                if (attachmentsInput) {
                    attachmentsInput.value = '';
                }
            }, 200);
        }

        // Delete Ticket
        function deleteTicket(ticketId) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'This ticket will be deleted permanently',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#E67E00',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    allTickets = allTickets.filter(t => t.id !== ticketId);
                    filteredTickets = filteredTickets.filter(t => t.id !== ticketId);
                    displayTickets();
                    
                    // Update localStorage
                    try {
                        localStorage.setItem('wefixTickets', JSON.stringify(allTickets));
                    } catch (error) {
                        console.error('Error saving tickets:', error);
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: 'Ticket has been deleted',
                        confirmButtonColor: '#E67E00',
                        timer: 2000
                    });
                }
            });
        }

        // Additional Work Functions
        let currentAdditionalWorkTicketId = null;

        // Sample additional work items
        function getSampleAdditionalWorkItems() {
            const now = new Date();
            return [
                { 
                    name: 'Electrical Repair Work', 
                    status: 'In Progress', 
                    proposalFile: 'Electrical_Repair_Proposal.pdf',
                    submittedDateTime: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString() // 5 days ago
                },
                { 
                    name: 'Plumbing Maintenance', 
                    status: 'Approved', 
                    proposalFile: 'Plumbing_Maintenance_Proposal.pdf',
                    submittedDateTime: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString() // 3 days ago
                },
                { 
                    name: 'HVAC System Check', 
                    status: 'Canceled', 
                    proposalFile: 'HVAC_System_Check_Proposal.pdf',
                    submittedDateTime: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days ago
                },
                { 
                    name: 'Painting Services', 
                    status: 'Rejected', 
                    proposalFile: 'Painting_Services_Proposal.pdf',
                    submittedDateTime: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString() // 2 days ago
                },
                { 
                    name: 'Carpentry Work', 
                    status: 'In Progress', 
                    proposalFile: 'Carpentry_Work_Proposal.pdf',
                    submittedDateTime: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString() // 1 day ago
                }
            ];
        }

        // Load additional work items list
        function loadAdditionalWorkItems() {
            const listBody = document.getElementById('additionalWorkListBody');
            if (!listBody) return;

            // Get sample items
            const items = getSampleAdditionalWorkItems();
            
            listBody.innerHTML = '';
            
            items.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'additional-work-list-item';
                
                // Convert status to lowercase and replace spaces/hyphens
                let statusClass = item.status.toLowerCase().replace(/[\s-]/g, '');
                statusClass = `status-${statusClass}`;
                
                // Create file link - only show file if status is "Approved"
                const fileLink = item.proposalFile || '';
                const isApproved = item.status === 'Approved';
                // In production, replace '#' with actual file URL: `/api/files/${fileLink}` or full URL
                const fileUrl = '#'; // Change to actual file path when available
                const fileDisplay = (fileLink && isApproved) ? `
                    <div class="additional-work-item-file">
                        <a href="${fileUrl}" class="additional-work-item-file-link" onclick="openProposalFile('${fileLink}', event)" target="_blank">
                            <span class="additional-work-item-file-icon">üìÑ</span>
                            <span>${fileLink}</span>
                        </a>
                    </div>
                ` : '<div class="additional-work-item-file" style="color: #9ca3af;">-</div>';
                
                // Format submitted date time
                let dateDisplay = '<div class="additional-work-item-file" style="color: #9ca3af;">-</div>';
                if (item.submittedDateTime) {
                    try {
                        const submittedDate = new Date(item.submittedDateTime);
                        const formattedDate = submittedDate.toLocaleDateString('en-GB', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric' 
                        });
                        const formattedTime = submittedDate.toLocaleTimeString('en-GB', { 
                            hour: '2-digit', 
                            minute: '2-digit',
                            hour12: false
                        });
                        dateDisplay = `
                            <div class="additional-work-item-date">
                                <div>${formattedDate}</div>
                                <div class="additional-work-item-date-time">${formattedTime}</div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error formatting date:', e);
                    }
                }
                
                listItem.innerHTML = `
                    <div class="additional-work-item-name">${item.name}</div>
                    <div class="additional-work-item-status ${statusClass}">${item.status}</div>
                    ${fileDisplay}
                    ${dateDisplay}
                `;
                
                listBody.appendChild(listItem);
            });
        }

        // Open Additional Work Modal
        function openAdditionalWorkModal(ticketId) {
            const ticket = allTickets.find(t => t.id === ticketId);
            if (!ticket) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ticket not found',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            currentAdditionalWorkTicketId = ticketId;
            const modal = document.getElementById('additionalWorkModal');
            
            // Reset form
            document.getElementById('additionalWorkTitle').value = '';
            document.getElementById('additionalWorkDescription').value = '';
            
            // Load additional work items list
            loadAdditionalWorkItems();
            
            modal.classList.add('active');
        }

        // Close Additional Work Modal
        function closeAdditionalWorkModal() {
            document.getElementById('additionalWorkModal').classList.remove('active');
            document.getElementById('additionalWorkForm').reset();
            currentAdditionalWorkTicketId = null;
        }

        // Open Proposal File
        function openProposalFile(fileName, event) {
            event.preventDefault();
            
            // In production, this would use the actual file URL from server/storage
            // For demo, we'll create a data URL for a sample PDF or open in new tab
            // Option 1: Open in new tab (if you have actual file URLs on server)
            // const fileUrl = `/api/files/${fileName}`; // Replace with actual API endpoint
            // window.open(fileUrl, '_blank');
            
            // Option 2: Show info message (current implementation)
            Swal.fire({
                icon: 'info',
                title: 'Proposal File',
                html: `File: <strong>${fileName}</strong><br><br>Clicking this link would open the PDF file in a new tab.`,
                confirmButtonText: 'OK',
                confirmButtonColor: '#E67E00',
                footer: '<small>In production, this would directly open the PDF file</small>'
            });
            
            // If you want to actually open a PDF, uncomment and set the file URL:
            // const fileUrl = `path/to/files/${fileName}`;
            // window.open(fileUrl, '_blank');
        }

        // Submit Additional Work
        function submitAdditionalWork() {
            if (!currentAdditionalWorkTicketId) return;

            const title = document.getElementById('additionalWorkTitle').value.trim();
            const description = document.getElementById('additionalWorkDescription').value.trim();

            // Validate required fields
            if (!title) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Please enter a title',
                    confirmButtonColor: '#E67E00'
                });
                document.getElementById('additionalWorkTitle').focus();
                return;
            }

            if (!description) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Please enter a description',
                    confirmButtonColor: '#E67E00'
                });
                document.getElementById('additionalWorkDescription').focus();
                return;
            }

            // Find ticket
            const ticketIndex = allTickets.findIndex(t => t.id === currentAdditionalWorkTicketId);
            if (ticketIndex === -1) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ticket not found',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            const ticket = allTickets[ticketIndex];
            
            // Add additional work to ticket
            if (!ticket.additionalWork) {
                ticket.additionalWork = [];
            }
            
            ticket.additionalWork.push({
                title: title,
                description: description,
                createdAt: new Date().toISOString(),
                createdBy: 'User' // In production, use actual user name
            });

            // Save to localStorage
            try {
                localStorage.setItem('wefixTickets', JSON.stringify(allTickets));
            } catch (error) {
                console.error('Error saving tickets:', error);
            }

            // Close modal
            closeAdditionalWorkModal();

            Swal.fire({
                icon: 'success',
                title: 'Submitted!',
                text: 'Additional work has been added successfully',
                confirmButtonColor: '#E67E00',
                timer: 2000
            });
        }

        // Update By Technician Functions
        let currentUpdateTicketId = null;

        // Check if current user is Technician (can be modified to check actual user role)
        function isTechnician() {
            // Check localStorage for user role, or return true for testing
            // In production, this should check the actual logged-in user's role
            const userRole = localStorage.getItem('currentUserRole') || 'Technician'; // Default for testing
            return userRole === 'Technician';
        }

        // Open Update By Technician Modal
        function openUpdateByTechnicianModal(ticketId) {
            const ticket = allTickets.find(t => t.id === ticketId);
            if (!ticket) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ticket not found',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            currentUpdateTicketId = ticketId;
            const modal = document.getElementById('updateByTechnicianModal');
            
            // Reset form - default status to Pending
            document.getElementById('updateTicketStatus').value = 'Pending';
            document.getElementById('updateTicketNote').value = '';
            
            // Set status note
            handleStatusChange();
            
            modal.classList.add('active');
        }

        // Close Update By Technician Modal
        function closeUpdateByTechnicianModal() {
            document.getElementById('updateByTechnicianModal').classList.remove('active');
            document.getElementById('updateByTechnicianForm').reset();
            currentUpdateTicketId = null;
        }

        // Handle Status Change to show appropriate notes
        function handleStatusChange() {
            const statusSelect = document.getElementById('updateTicketStatus');
            const statusNote = document.getElementById('statusNote');
            const selectedStatus = statusSelect.value;

            switch(selectedStatus) {
                case 'Pending':
                    statusNote.textContent = 'Note: Optional';
                    statusNote.style.color = '#6b7280';
                    break;
                case 'In-Progress':
                    statusNote.textContent = 'Note: Optional';
                    statusNote.style.color = '#6b7280';
                    break;
                case 'Cancel':
                    statusNote.textContent = 'Note: Required';
                    statusNote.style.color = '#EF4444';
                    break;
                default:
                    statusNote.textContent = 'Note: Select a status';
                    statusNote.style.color = '#6b7280';
            }
        }

        // Save Technician Update
        function saveTechnicianUpdate() {
            if (!currentUpdateTicketId) return;

            const statusSelect = document.getElementById('updateTicketStatus');
            const noteTextarea = document.getElementById('updateTicketNote');
            
            const newStatus = statusSelect.value;
            const note = noteTextarea.value.trim();

            // Validate required fields
            if (!newStatus) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Please select a ticket status',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            // Check if status requires a note
            if (newStatus === 'Cancel' && !note) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Note is required for Cancel status',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            // Find and update ticket
            const ticketIndex = allTickets.findIndex(t => t.id === currentUpdateTicketId);
            if (ticketIndex === -1) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ticket not found',
                    confirmButtonColor: '#E67E00'
                });
                return;
            }

            const ticket = allTickets[ticketIndex];
            
            // Update ticket status
            ticket.status = newStatus;
            
            // Add update note to ticket (you might want to store this in a notes array)
            if (!ticket.technicianNotes) {
                ticket.technicianNotes = [];
            }
            if (note) {
                ticket.technicianNotes.push({
                    note: note,
                    updatedAt: new Date().toISOString(),
                    updatedBy: 'Technician' // In production, use actual user name
                });
            }

            // Update status timestamps
            const now = new Date().toISOString();
            if (newStatus === 'In-Progress' && !ticket.inProgressAt) {
                ticket.inProgressAt = now;
                ticket.inProgressBy = 'Technician'; // In production, use actual user name
                ticket.inProgressByAvatar = 'T';
            }

            // Save to localStorage
            try {
                localStorage.setItem('wefixTickets', JSON.stringify(allTickets));
            } catch (error) {
                console.error('Error saving tickets:', error);
            }

            // Refresh display
            filterTickets();
            
            // Close modal
            closeUpdateByTechnicianModal();

            Swal.fire({
                icon: 'success',
                title: 'Updated!',
                text: 'Ticket has been updated successfully',
                confirmButtonColor: '#E67E00',
                timer: 2000
            });
        }

        // Calendar View Management
        let currentView = 'list';
        let currentDate = new Date();

        function switchView(view) {
            currentView = view;
            
            // Update active button
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
            
            // Hide all views
            document.querySelectorAll('.calendar-view').forEach(v => {
                v.style.display = 'none';
            });
            
            // Show selected view
            if (view === 'list') {
                document.getElementById('calendarListView').style.display = 'block';
            } else if (view === 'month') {
                document.getElementById('calendarMonthView').style.display = 'block';
                renderMonthView();
            } else if (view === 'week') {
                document.getElementById('calendarWeekView').style.display = 'block';
                renderWeekView();
            } else if (view === 'day') {
                document.getElementById('calendarDayView').style.display = 'block';
                renderDayView();
            }
            
            updateCalendarDateDisplay();
        }

        function changeCalendarMonth(direction) {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
                renderMonthView();
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
                renderWeekView();
            } else if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() + direction);
                renderDayView();
            }
            updateCalendarDateDisplay();
        }

        function goToToday() {
            currentDate = new Date();
            if (currentView === 'month') {
                renderMonthView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'day') {
                renderDayView();
            }
            updateCalendarDateDisplay();
        }

        function updateCalendarDateDisplay() {
            const dateDisplay = document.getElementById('calendarDateDisplay');
            if (currentView === 'month') {
                const months = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE', 'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];
                dateDisplay.textContent = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            } else if (currentView === 'week') {
                const weekStart = getWeekStart(currentDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                if (weekStart.getMonth() === weekEnd.getMonth()) {
                    dateDisplay.textContent = `${months[weekStart.getMonth()]} ${weekStart.getDate()} - ${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
                } else {
                    dateDisplay.textContent = `${months[weekStart.getMonth()]} ${weekStart.getDate()} - ${months[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;
                }
            } else if (currentView === 'day') {
                const months = ['JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE', 'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'];
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                dateDisplay.textContent = `${days[currentDate.getDay()]}, ${months[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
            }
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function getTicketsForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return filteredTickets.filter(ticket => {
                const ticketDate = getTicketDateString(ticket);
                return ticketDate === dateStr;
            });
        }

        function renderMonthView() {
            const grid = document.getElementById('calendarMonthGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // First day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Previous month's days
            const prevMonth = new Date(year, month, 0);
            const daysInPrevMonth = prevMonth.getDate();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Add previous month's days
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const date = new Date(year, month - 1, daysInPrevMonth - i);
                const dayElement = createCalendarDay(date, true, false);
                grid.appendChild(dayElement);
            }
            
            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.getTime() === today.getTime();
                const dayElement = createCalendarDay(date, false, isToday);
                grid.appendChild(dayElement);
            }
            
            // Add next month's days to fill the grid
            const totalCells = grid.children.length;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                const dayElement = createCalendarDay(date, true, false);
                grid.appendChild(dayElement);
            }
        }

        function createCalendarDay(date, isOtherMonth, isToday) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day' + (isOtherMonth ? ' other-month' : '') + (isToday ? ' today' : '');
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = date.getDate();
            
            const eventsDiv = document.createElement('div');
            eventsDiv.className = 'calendar-day-events';
            
            const tickets = getTicketsForDate(date);
            tickets.slice(0, 3).forEach(ticket => {
                const event = document.createElement('div');
                event.className = 'calendar-event';
                event.textContent = ticket.id + ' - ' + (ticket.clientName || 'Ticket');
                event.onclick = () => openTimeline(ticket.id);
                
                // Add hover tooltip
                event.addEventListener('mouseenter', (e) => showTicketTooltip(e, ticket));
                event.addEventListener('mouseleave', hideTicketTooltip);
                event.addEventListener('mousemove', (e) => updateTooltipPosition(e));
                
                eventsDiv.appendChild(event);
            });
            
            if (tickets.length > 3) {
                const moreEvent = document.createElement('div');
                moreEvent.className = 'calendar-event more';
                moreEvent.textContent = `+${tickets.length - 3} more`;
                eventsDiv.appendChild(moreEvent);
            }
            
            dayDiv.appendChild(dayNumber);
            dayDiv.appendChild(eventsDiv);
            
            return dayDiv;
        }

        function renderWeekView() {
            const weekStart = getWeekStart(currentDate);
            const weekDays = document.getElementById('calendarWeekDays');
            const weekGrid = document.getElementById('calendarWeekGrid');
            const timeColumn = document.querySelector('.calendar-week-time-column');
            
            if (!weekDays || !weekGrid) return;
            
            weekDays.innerHTML = '';
            weekGrid.innerHTML = '';
            if (timeColumn) timeColumn.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Create time slots in time column
            if (timeColumn) {
                for (let hour = 0; hour < 24; hour++) {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'calendar-week-time-slot';
                    timeSlot.textContent = hour.toString().padStart(2, '0') + ':00';
                    timeColumn.appendChild(timeSlot);
                }
            }
            
            // Create week day headers
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-week-day-header' + (date.getTime() === today.getTime() ? ' today' : '');
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayHeader.innerHTML = `
                    <div style="font-size: 12px; color: #6b7280;">${days[date.getDay()]}</div>
                    <div style="font-size: 16px; margin-top: 4px;">${date.getDate()}</div>
                `;
                weekDays.appendChild(dayHeader);
                
                // Create day column
                const dayColumn = document.createElement('div');
                dayColumn.className = 'calendar-week-day-column';
                dayColumn.style.position = 'relative';
                dayColumn.style.minHeight = '1440px';
                
                // Add hour markers
                for (let hour = 0; hour < 24; hour++) {
                    const hourMarker = document.createElement('div');
                    hourMarker.style.position = 'absolute';
                    hourMarker.style.top = (hour * 60) + 'px';
                    hourMarker.style.height = '60px';
                    hourMarker.style.width = '100%';
                    hourMarker.style.borderBottom = '1px solid #e5e7eb';
                    dayColumn.appendChild(hourMarker);
                }
                
                // Add events to this day
                const tickets = getTicketsForDate(date);
                tickets.forEach(ticket => {
                    try {
                        const event = document.createElement('div');
                        event.className = 'calendar-week-event';
                        const timeStr = ticket.ticketTime || '12:00';
                        const [hourStr] = timeStr.split('-')[0].split(':');
                        const hour = parseInt(hourStr) || 12;
                        const top = (hour * 60);
                        const duration = 60;
                        event.style.top = top + 'px';
                        event.style.height = duration + 'px';
                        event.innerHTML = `
                            <div style="font-weight: 600; font-size: 10px;">${ticket.id}</div>
                            <div style="font-size: 9px; opacity: 0.9;">${(ticket.clientName || 'Ticket').substring(0, 15)}</div>
                        `;
                        event.onclick = () => openTimeline(ticket.id);
                        
                        // Add hover tooltip
                        event.addEventListener('mouseenter', (e) => showTicketTooltip(e, ticket));
                        event.addEventListener('mouseleave', hideTicketTooltip);
                        event.addEventListener('mousemove', (e) => updateTooltipPosition(e));
                        
                        dayColumn.appendChild(event);
                    } catch (e) {
                        console.error('Error rendering ticket event:', e, ticket);
                    }
                });
                
                weekGrid.appendChild(dayColumn);
            }
        }

        function renderDayView() {
            const dayHeader = document.getElementById('calendarDayHeader');
            const dayGrid = document.getElementById('calendarDayGrid');
            const timeColumn = document.querySelector('.calendar-day-time-column');
            
            if (!dayHeader || !dayGrid) return;
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            dayHeader.textContent = `${days[currentDate.getDay()]}, ${months[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
            
            dayGrid.innerHTML = '';
            if (timeColumn) timeColumn.innerHTML = '';
            
            // Create time slots
            if (timeColumn) {
                for (let hour = 0; hour < 24; hour++) {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'calendar-day-time-slot';
                    timeSlot.textContent = hour.toString().padStart(2, '0') + ':00';
                    timeColumn.appendChild(timeSlot);
                }
            }
            
            // Add hour markers
            dayGrid.style.position = 'relative';
            dayGrid.style.minHeight = '1440px';
            for (let hour = 0; hour < 24; hour++) {
                const hourMarker = document.createElement('div');
                hourMarker.style.position = 'absolute';
                hourMarker.style.top = (hour * 60) + 'px';
                hourMarker.style.height = '60px';
                hourMarker.style.width = '100%';
                hourMarker.style.borderBottom = '1px solid #e5e7eb';
                dayGrid.appendChild(hourMarker);
            }
            
            const tickets = getTicketsForDate(currentDate);
            tickets.forEach(ticket => {
                try {
                    const event = document.createElement('div');
                    event.className = 'calendar-day-event';
                    const timeStr = ticket.ticketTime || '12:00';
                    const [hourStr] = timeStr.split('-')[0].split(':');
                    const hour = parseInt(hourStr) || 12;
                    const top = (hour * 60);
                    const duration = 60;
                    event.style.top = top + 'px';
                    event.style.height = duration + 'px';
                    event.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 4px;">${ticket.id}</div>
                        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">${ticket.clientName || 'Ticket'}</div>
                        <div style="font-size: 10px; opacity: 0.8;">${ticket.ticketTime || 'All Day'}</div>
                    `;
                    event.onclick = () => openTimeline(ticket.id);
                    
                    // Add hover tooltip
                    event.addEventListener('mouseenter', (e) => showTicketTooltip(e, ticket));
                    event.addEventListener('mouseleave', hideTicketTooltip);
                    event.addEventListener('mousemove', (e) => updateTooltipPosition(e));
                    
                    dayGrid.appendChild(event);
                } catch (e) {
                    console.error('Error rendering ticket event:', e, ticket);
                }
            });
        }

        // Tooltip Management
        let tooltipElement = null;

        function createTooltip() {
            if (!tooltipElement) {
                tooltipElement = document.createElement('div');
                tooltipElement.className = 'calendar-ticket-tooltip';
                document.body.appendChild(tooltipElement);
            }
            return tooltipElement;
        }

        function showTicketTooltip(event, ticket) {
            const tooltip = createTooltip();
            
            // Format dates
            const ticketDate = getTicketDateString(ticket);
            const ticketTime = ticket.ticketTime || '12:00';
            const [timeStart, timeEnd] = ticketTime.includes('-') ? ticketTime.split('-') : [ticketTime, ticketTime];
            
            // Parse date and time
            let fromDateTime = '';
            let toDateTime = '';
            try {
                const date = new Date(ticketDate);
                const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const [startHour, startMin] = timeStart.split(':');
                const [endHour, endMin] = timeEnd ? timeEnd.split(':') : [startHour, startMin];
                fromDateTime = `${formattedDate} ${formatTime(parseInt(startHour), parseInt(startMin || 0))}`;
                toDateTime = `${formattedDate} ${formatTime(parseInt(endHour), parseInt(endMin || 0))}`;
            } catch (e) {
                fromDateTime = ticketDate + ' ' + timeStart;
                toDateTime = ticketDate + ' ' + timeEnd;
            }
            
            const serviceProvider = ticket.technician || ticket.teamLeader || 'Not assigned';
            const status = ticket.status || 'Pending';
            const femaleEngineer = ticket.femaleEngineer ? 'True' : 'False';
            const mainService = ticket.mainService || 'Not specified';
            const subServiceNames = Array.isArray(ticket.subServiceDetails) && ticket.subServiceDetails.length > 0
                ? ticket.subServiceDetails.map(sub => sub.title)
                : (Array.isArray(ticket.subServices) ? ticket.subServices.map(getSubServiceTitleById) : []);
            const subServicesDisplay = subServiceNames.length > 0 ? subServiceNames.join(', ') : 'No sub services selected';
            const serviceDescription = ticket.serviceDescription || 'No service description provided';
            const totalPrice = ticket.totalPrice || '25 JOD';
            const notes = ticket.description || ticket.notes || ticket.location || 'No notes provided';
            const attachments = Array.isArray(ticket.attachments) ? ticket.attachments : [];
            
            tooltip.innerHTML = `
                <div class="tooltip-header">
                    <span class="tooltip-header-icon">üìÖ</span>
                    <span>${ticket.clientName || ticket.id}</span>
                </div>
                <div class="tooltip-body">
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon clock">üïê</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">From:</div>
                            <div class="tooltip-detail-value">${fromDateTime}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon clock">üïê</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">To:</div>
                            <div class="tooltip-detail-value">${toDateTime}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon person">üë§</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Service Provider:</div>
                            <div class="tooltip-detail-value">${serviceProvider}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon ticket">üé´</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Number Of Tickets:</div>
                            <div class="tooltip-detail-value">1</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon pushpin">üìç</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Status:</div>
                            <div class="tooltip-detail-value">${status}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon female-engineer">üîß</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Having an female engineer:</div>
                            <div class="tooltip-detail-value">${femaleEngineer}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon person">üìÇ</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Main Service:</div>
                            <div class="tooltip-detail-value">${mainService}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon person">üõ†Ô∏è</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Sub Services:</div>
                            <div class="tooltip-detail-value">${subServicesDisplay}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon notes">üìù</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Service Description:</div>
                            <div class="tooltip-detail-value ${serviceDescription === 'No service description provided' ? 'italic' : ''}">${serviceDescription}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon money">üí∞</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Total Price:</div>
                            <div class="tooltip-detail-value">${totalPrice}</div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon notes">üìé</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Attachments:</div>
                            <div class="tooltip-detail-value">
                                ${attachments.length > 0 ? attachments.map(name => `<div>${name}</div>`).join('') : '<span class="italic">No attachments</span>'}
                            </div>
                        </div>
                    </div>
                    <div class="tooltip-detail-item">
                        <span class="tooltip-icon notes">üóíÔ∏è</span>
                        <div class="tooltip-detail-content">
                            <div class="tooltip-detail-label">Additional Notes:</div>
                            <div class="tooltip-detail-value ${notes === 'No notes provided' ? 'italic' : ''}">${notes}</div>
                        </div>
                    </div>
                </div>
            `;
            
            tooltip.classList.add('visible');
            updateTooltipPosition(event);
        }

        function hideTicketTooltip() {
            if (tooltipElement) {
                tooltipElement.classList.remove('visible');
            }
        }

        function updateTooltipPosition(event) {
            if (!tooltipElement) return;
            
            const tooltip = tooltipElement;
            const rect = tooltip.getBoundingClientRect();
            const x = event.clientX;
            const y = event.clientY;
            
            // Position tooltip below and slightly to the right of cursor
            let left = x + 15;
            let top = y + 15;
            
            // Adjust if tooltip would go off screen
            if (left + rect.width > window.innerWidth) {
                left = x - rect.width - 15;
            }
            
            if (top + rect.height > window.innerHeight) {
                top = y - rect.height - 15;
            }
            
            // Ensure tooltip stays within viewport
            left = Math.max(10, Math.min(left, window.innerWidth - rect.width - 10));
            top = Math.max(10, Math.min(top, window.innerHeight - rect.height - 10));
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function formatTime(hour, minutes) {
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            const displayMinutes = minutes.toString().padStart(2, '0');
            return `${displayHour}:${displayMinutes} ${period}`;
        }

        // Make functions globally accessible
        window.switchView = switchView;
        window.changeCalendarMonth = changeCalendarMonth;
        window.goToToday = goToToday;

        // Initialize tickets
        function initializeTickets() {
            try {
                const storedTickets = localStorage.getItem('wefixTickets');
                // Always generate sample tickets (100 items)
                allTickets = generateSampleTickets();
                
                // If there are saved tickets, add them to the list
                if (storedTickets) {
                    try {
                        const savedTickets = JSON.parse(storedTickets);
                        if (savedTickets && Array.isArray(savedTickets) && savedTickets.length > 0) {
                            // Add saved tickets to the beginning
                            allTickets = [...savedTickets, ...allTickets];
                        }
                    } catch (e) {
                        console.error('Error parsing saved tickets:', e);
                    }
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                allTickets = generateSampleTickets();
            }
            
            filteredTickets = [...allTickets];
            currentPage = 1; // Reset to first page
            sortTickets();
        }

        // Initialize data on page load
        function init() {
            initializeData();
            populateTicketMainServiceOptions();
            renderTicketSubServices('', []);
            resetServiceInfoSection();
            // Wait a bit to ensure DOM is ready
            setTimeout(() => {
                initializeTickets();
                updateCalendarDateDisplay();
            }, 100);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        function getSelectedSubServiceIds() {
            return Array.from(document.querySelectorAll('.ticket-sub-service-checkbox:checked')).map(cb => cb.value);
        }

        function getSubServiceTitleById(subServiceId) {
            for (const categoryKey of Object.keys(serviceCategories)) {
                const category = serviceCategories[categoryKey];
                if (!category || !category.subServices) continue;
                const match = category.subServices.find(sub => sub.id === subServiceId);
                if (match) return match.title;
            }
            return subServiceId;
        }

        function getSubServiceDetailsByIds(mainService, subServiceIds) {
            const details = [];
            if (serviceCategories[mainService] && serviceCategories[mainService].subServices) {
                subServiceIds.forEach(id => {
                    const found = serviceCategories[mainService].subServices.find(sub => sub.id === id);
                    if (found) {
                        details.push({ ...found });
                    }
                });
            } else {
                subServiceIds.forEach(id => {
                    details.push({ id, title: getSubServiceTitleById(id), price: '', tickets: '' });
                });
            }
            return details;
        }

        function updateTicketFemaleEngineerLabel() {
            const checkbox = document.getElementById('ticketFemaleEngineer');
            const label = document.getElementById('ticketFemaleEngineerLabel');
            if (!checkbox || !label) return;
            label.textContent = checkbox.checked ? 'On' : 'Off';
            updateTicketTechnicianAvailability();
        }

        function handleTicketMainServiceChange(preselectedIds) {
            const select = document.getElementById('ticketMainService');
            if (!select) return;
            const value = select.value;
            const ids = Array.isArray(preselectedIds) ? preselectedIds : [];
            if (!value) {
                renderTicketSubServices('', []);
            } else {
                renderTicketSubServices(value, ids);
            }
        }

        window.handleTicketMainServiceChange = handleTicketMainServiceChange;

        function getUnavailableTechnicians(date, time) {
            // This is a simulation - in production, check actual schedules
            // For demo purposes, randomly mark some as unavailable
            const unavailable = [];
            const techSelect = document.getElementById('ticketTechnician');
            if (!techSelect) return unavailable;
            const techOptions = techSelect.options;
            
            // Simulate: mark every 3rd technician as unavailable
            for (let i = 1; i < techOptions.length; i++) {
                if (i % 3 === 0) {
                    unavailable.push(techOptions[i].value);
                }
            }
            
            return unavailable;
        }
    </script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>





